<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZHSFGWQMSN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZHSFGWQMSN');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founder Admin - Authorized Domains</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/styles/founder-admin.css">
    <script src="/config.js"></script>
    <script src="/auth.js"></script>
</head>
<body>
    <div id="loginOverlay" class="login-overlay hidden">
        <div class="login-container">
            <div id="loginFormSection">
                <h2>Sign in</h2>
                <p class="login-subtext">
                    Enter your work email and we'll email you a secure magic link.
                </p>
                <input type="email" id="loginEmail" placeholder="you@company.com" autocomplete="email">
                <button id="loginButton" type="button">Send Magic Link</button>
                <div id="loginError" class="login-error"></div>
                <div id="loginSuccess" class="login-success"></div>
            </div>
        </div>
    </div>

    <div id="appShell">
        <header>
            <div>
                <nav class="breadcrumbs">
                    <a href="/founder_admin.html">Founder Admin</a>
                    <span class="breadcrumbs-separator">›</span>
                    <span>Authorized Domains</span>
                </nav>
                <h1>Authorized Domains</h1>
                <div class="subtitle">
                    Manage which email domains can request access and which clients each domain can view.
                </div>
            </div>
            <div class="founder-meta">
                <span id="founderEmail"></span>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" id="refreshButton">Refresh</button>
                    <button class="btn btn-ghost" id="logoutButton">Logout</button>
                </div>
            </div>
        </header>
        <main>
            <div class="content">
                <div class="toolbar">
                    <div>
                        <h2 style="font-size: 18px; font-weight: 600;">Authorized Domains</h2>
                        <p style="font-size: 14px; color: var(--muted); margin-top: 6px;">
                            Keep the list of approved email domains in sync with client access rules.
                        </p>
                    </div>
                    <button class="btn btn-primary" id="newDomainButton">New Domain</button>
                </div>
                <div id="statusMessage" class="status-message"></div>
                <div id="domainsContainer" class="domains-grid"></div>
            </div>
        </main>
    </div>

    <div id="modalBackdrop" class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <header>
                <h2 id="modalTitle">New Domain</h2>
            </header>
            <form id="domainForm">
                <div class="form-group">
                    <label for="domainInput">Email Domain</label>
                    <input type="text" id="domainInput" placeholder="example.com" required>
                </div>
                <div class="form-group">
                    <label for="descriptionInput">Description</label>
                    <textarea id="descriptionInput" placeholder="Optional notes for founders"></textarea>
                </div>
                <div class="form-group">
                    <label>Client Access</label>
                    <div id="clientOptions" class="client-list"></div>
                    <p style="font-size: 12px; color: var(--muted);">
                        People signing in with this domain will inherit access to the selected clients.
                    </p>
                </div>
            </form>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelModalButton" type="button">Cancel</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="submitDomainButton" type="submit" form="domainForm">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.APP_CONFIG?.API_BASE_URL || 'http://localhost:8000';

        const elements = {
            appShell: document.getElementById('appShell'),
            founderEmail: document.getElementById('founderEmail'),
            logoutButton: document.getElementById('logoutButton'),
            refreshButton: document.getElementById('refreshButton'),
            newDomainButton: document.getElementById('newDomainButton'),
            statusMessage: document.getElementById('statusMessage'),
            domainsContainer: document.getElementById('domainsContainer'),
            modalBackdrop: document.getElementById('modalBackdrop'),
            modalTitle: document.getElementById('modalTitle'),
            domainForm: document.getElementById('domainForm'),
            domainInput: document.getElementById('domainInput'),
            descriptionInput: document.getElementById('descriptionInput'),
            clientOptions: document.getElementById('clientOptions'),
            cancelModalButton: document.getElementById('cancelModalButton'),
            submitDomainButton: document.getElementById('submitDomainButton'),
        };

        const state = {
            founder: null,
            domains: [],
            clients: [],
            currentMode: 'create',
            currentDomainId: null,
        };

        const authHeaders = () => {
            return Auth.getAuthHeaders();
        };

        function showStatus(message, type = 'success') {
            if (!message) {
                elements.statusMessage.style.display = 'none';
                elements.statusMessage.textContent = '';
                elements.statusMessage.classList.remove('success', 'error');
                return;
            }
            elements.statusMessage.textContent = message;
            elements.statusMessage.style.display = 'block';
            elements.statusMessage.classList.remove('success', 'error');
            elements.statusMessage.classList.add(type);
        }

        function renderFounderInfo() {
            if (state.founder?.email) {
                elements.founderEmail.textContent = state.founder.email;
            } else {
                elements.founderEmail.textContent = '';
            }
        }

        function initializePage() {
            Auth.hideLogin();
            elements.appShell.style.display = 'flex';
            renderFounderInfo();
            loadInitialData();
        }

        // Check authentication on page load
        Auth.checkAuth().then(authenticated => {
            if (authenticated) {
                const userInfo = Auth.getStoredUserInfo();
                if (!userInfo?.is_founder) {
                    Auth.showLogin();
                    const errorEl = document.getElementById('loginError');
                    if (errorEl) {
                        errorEl.textContent = 'Access denied: founder privileges required.';
                        errorEl.style.display = 'block';
                    }
                } else {
                    state.founder = userInfo;
                    initializePage();
                }
            }
        });

        // Listen for auth events
        window.addEventListener('auth:authenticated', (e) => {
            const userInfo = e.detail.user;
            if (userInfo?.is_founder) {
                state.founder = userInfo;
                initializePage();
            } else {
                Auth.showLogin();
                const errorEl = document.getElementById('loginError');
                if (errorEl) {
                    errorEl.textContent = 'Access denied: founder privileges required.';
                    errorEl.style.display = 'block';
                }
            }
        });

        // Logout handler
        elements.logoutButton.addEventListener('click', () => {
            Auth.handleLogout();
        });



        async function loadInitialData() {
            showStatus('Loading authorized domains…', 'success');
            try {
                await Promise.all([loadClients(), loadDomains()]);
                showStatus();
            } catch (error) {
                console.error('Failed to load initial data', error);
                showStatus(error.message || 'Unable to load data.', 'error');
            }
        }

        async function loadClients() {
            const response = await fetch(`${API_BASE_URL}/api/clients`, {
                headers: authHeaders(),
            });
            if (!response.ok) {
                throw new Error('Failed to load clients.');
            }
            state.clients = await response.json();
        }

        async function loadDomains() {
            const response = await fetch(`${API_BASE_URL}/api/founder/authorized-domains`, {
                headers: authHeaders(),
            });
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    Auth.handleLogout();
                    return;
                }
                throw new Error('Failed to load authorized domains.');
            }
            state.domains = await response.json();
            renderDomains();
        }

        function renderDomains() {
            if (!state.domains.length) {
                elements.domainsContainer.innerHTML = `
                    <div class="empty-state">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No authorized domains yet</h3>
                        <p style="font-size: 14px;">Add your first domain to control who can sign in.</p>
                    </div>
                `;
                return;
            }

            elements.domainsContainer.innerHTML = state.domains
                .map((domain) => {
                    const clientBadges = domain.clients
                        .map((client) => `<span class="client-chip">${client.name}</span>`)
                        .join('') || '<span class="description">No clients mapped</span>';
                    const updatedAt = domain.updated_at ? new Date(domain.updated_at).toLocaleString() : 'Unknown';
                    const createdAt = domain.created_at ? new Date(domain.created_at).toLocaleDateString() : 'Unknown';

                    return `
                        <article class="domain-card">
                            <div class="domain-header">
                                <div>
                                    <h2>${domain.domain}</h2>
                                    <div class="domain-meta">
                                        <span>Created ${createdAt}</span>
                                        <span>Updated ${updatedAt}</span>
                                    </div>
                                </div>
                                <button class="btn btn-secondary" data-action="edit-domain" data-domain-id="${domain.id}">Edit</button>
                            </div>
                            <div class="description">${domain.description ? domain.description : 'No description provided.'}</div>
                            <div class="client-chips">${clientBadges}</div>
                        </article>
                    `;
                })
                .join('');

            elements.domainsContainer.querySelectorAll('[data-action="edit-domain"]').forEach((button) => {
                button.addEventListener('click', () => {
                    const domainId = button.getAttribute('data-domain-id');
                    openDomainModal('edit', domainId);
                });
            });
        }

        function openDomainModal(mode, domainId = null) {
            state.currentMode = mode;
            state.currentDomainId = domainId;
            elements.domainForm.reset();

            let selectedIds = new Set();
            if (mode === 'edit' && domainId) {
                const domain = state.domains.find((item) => item.id === domainId);
                if (!domain) {
                    showStatus('Selected domain could not be found.', 'error');
                    return;
                }
                elements.modalTitle.textContent = `Edit ${domain.domain}`;
                elements.domainInput.value = domain.domain;
                elements.descriptionInput.value = domain.description || '';
                selectedIds = new Set(domain.clients.map((client) => client.id));
            } else {
                elements.modalTitle.textContent = 'New Domain';
                elements.domainInput.value = '';
                elements.descriptionInput.value = '';
            }

            renderClientOptions(selectedIds);
            elements.submitDomainButton.textContent = mode === 'edit' ? 'Save Changes' : 'Create Domain';
            elements.modalBackdrop.classList.add('visible');
            setTimeout(() => elements.domainInput.focus(), 50);
        }

        function closeDomainModal() {
            state.currentMode = 'create';
            state.currentDomainId = null;
            elements.modalBackdrop.classList.remove('visible');
        }

        function renderClientOptions(selectedIds = new Set()) {
            if (!state.clients.length) {
                elements.clientOptions.innerHTML = '<p style="font-size: 13px; color: var(--muted);">No clients available yet.</p>';
                return;
            }

            const clientsMarkup = state.clients
                .map((client) => {
                    const checked = selectedIds.has(client.id) ? 'checked' : '';
                    return `
                        <label class="client-option">
                            <input type="checkbox" value="${client.id}" ${checked}>
                            <span>${client.name}</span>
                        </label>
                    `;
                })
                .join('');

            elements.clientOptions.innerHTML = clientsMarkup;
        }

        async function handleDomainFormSubmit(event) {
            event.preventDefault();
            elements.submitDomainButton.disabled = true;
            const domainValue = elements.domainInput.value.trim();
            const descriptionValue = elements.descriptionInput.value.trim();
            const selectedClientIds = Array.from(
                elements.clientOptions.querySelectorAll('input[type="checkbox"]:checked')
            ).map((input) => input.value);

            if (!domainValue) {
                showStatus('Domain is required.', 'error');
                elements.submitDomainButton.disabled = false;
                return;
            }

            const payload = {
                domain: domainValue,
                description: descriptionValue || null,
                client_ids: selectedClientIds,
            };

            try {
                if (state.currentMode === 'edit' && state.currentDomainId) {
                    await updateDomain(state.currentDomainId, payload);
                    showStatus('Domain updated successfully.', 'success');
                } else {
                    await createDomain(payload);
                    showStatus('Domain created successfully.', 'success');
                }
                closeDomainModal();
                await loadDomains();
            } catch (error) {
                console.error('Domain save failed', error);
                showStatus(error.message || 'Unable to save domain.', 'error');
            } finally {
                elements.submitDomainButton.disabled = false;
            }
        }

        async function createDomain(payload) {
            const response = await fetch(`${API_BASE_URL}/api/founder/authorized-domains`, {
                method: 'POST',
                headers: authHeaders(),
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || 'Failed to create domain.');
            }
            return response.json();
        }

        async function updateDomain(domainId, payload) {
            const response = await fetch(`${API_BASE_URL}/api/founder/authorized-domains/${domainId}`, {
                method: 'PUT',
                headers: authHeaders(),
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || 'Failed to update domain.');
            }
            return response.json();
        }

        elements.refreshButton.addEventListener('click', loadInitialData);
        elements.newDomainButton.addEventListener('click', () => openDomainModal('create'));
        elements.cancelModalButton.addEventListener('click', closeDomainModal);
        elements.domainForm.addEventListener('submit', handleDomainFormSubmit);

        elements.modalBackdrop.addEventListener('click', (event) => {
            if (event.target === elements.modalBackdrop) {
                closeDomainModal();
            }
        });
    </script>
</body>
</html>
