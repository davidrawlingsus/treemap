<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founder Admin - Authorized Domains</title>
    <script src="/config.js"></script>
    <style>
        :root {
            --bg: #f5f7fb;
            --surface: #ffffff;
            --border: #e2e8f0;
            --border-strong: #cbd5f5;
            --primary: #667eea;
            --primary-dark: #4c51bf;
            --danger: #e53e3e;
            --success: #38a169;
            --text: #1a202c;
            --muted: #718096;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Inter", "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .login-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.85);
            z-index: 999;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-card {
            background: var(--surface);
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(56, 66, 106, 0.35);
            width: min(380px, 92vw);
        }

        .login-card h2 {
            margin-bottom: 12px;
        }

        .login-card p {
            margin-bottom: 16px;
            color: var(--muted);
            font-size: 14px;
            line-height: 1.5;
        }

        .login-card input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 12px;
            transition: border 0.2s;
        }

        .login-card input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.15s, box-shadow 0.2s, background 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: #edf2f7;
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-ghost {
            background: transparent;
            color: var(--primary);
        }

        .btn-ghost:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #appShell {
            display: none;
            min-height: 100vh;
            flex-direction: column;
        }

        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        header h1 {
            font-size: 26px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 14px;
            color: var(--muted);
            margin-top: 6px;
            max-width: 640px;
        }

        .founder-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        #founderEmail {
            font-size: 12px;
            color: var(--muted);
        }

        main {
            flex: 1;
            padding: 32px;
            display: flex;
            justify-content: center;
        }

        .content {
            width: min(1100px, 100%);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .toolbar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
        }

        .status-message {
            padding: 14px 18px;
            border-radius: 10px;
            font-size: 14px;
            display: none;
        }

        .status-message.success {
            background: #f0fff4;
            border: 1px solid #c6f6d5;
            color: var(--success);
        }

        .status-message.error {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: var(--danger);
        }

        .domains-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .domain-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 20px 45px -24px rgba(15, 23, 42, 0.35);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .domain-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .domain-header h2 {
            font-size: 18px;
            font-weight: 600;
            word-break: break-word;
        }

        .domain-meta {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .description {
            font-size: 14px;
            color: var(--muted);
        }

        .client-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .client-chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: rgba(102, 126, 234, 0.12);
            font-size: 12px;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            color: var(--muted);
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 48px 24px;
            background: rgba(255, 255, 255, 0.7);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-backdrop.visible {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 30px 60px -24px rgba(15, 23, 42, 0.45);
            border: 1px solid var(--border-strong);
            width: min(520px, 100%);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal header {
            position: static;
            border-bottom: 1px solid var(--border);
            padding: 20px 24px;
            background: #f7f9ff;
        }

        .modal header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .modal form {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--muted);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 72px;
        }

        .client-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            max-height: 220px;
            overflow-y: auto;
            padding: 6px 2px;
        }

        .client-option {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 13px;
            padding: 6px 8px;
            border: 1px solid transparent;
            border-radius: 8px;
        }

        .client-option:hover {
            border-color: rgba(102, 126, 234, 0.3);
            background: rgba(102, 126, 234, 0.08);
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 18px 24px;
            border-top: 1px solid var(--border);
            background: #f8fafc;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .founder-meta {
                align-items: flex-start;
            }

            main {
                padding: 24px;
            }

            .domains-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <h2>Founder Login</h2>
            <p>Use your founder email to manage authorized domains and client access.</p>
            <div id="loginError" class="status-message error" style="display: none;"></div>
            <input type="email" id="loginEmail" placeholder="founder@example.com" autocomplete="email">
            <input type="password" id="loginPassword" placeholder="Password (if configured)" autocomplete="current-password">
            <button class="btn btn-primary" id="loginButton">Login</button>
        </div>
    </div>

    <div id="appShell">
        <header>
            <div>
                <h1>Authorized Domains</h1>
                <div class="subtitle">
                    Manage which email domains can request access and which clients each domain can view.
                </div>
            </div>
            <div class="founder-meta">
                <span id="founderEmail"></span>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" id="refreshButton">Refresh</button>
                    <button class="btn btn-ghost" id="logoutButton">Logout</button>
                </div>
            </div>
        </header>
        <main>
            <div class="content">
                <div class="toolbar">
                    <div>
                        <h2 style="font-size: 18px; font-weight: 600;">Authorized Domains</h2>
                        <p style="font-size: 14px; color: var(--muted); margin-top: 6px;">
                            Keep the list of approved email domains in sync with client access rules.
                        </p>
                    </div>
                    <button class="btn btn-primary" id="newDomainButton">New Domain</button>
                </div>
                <div id="statusMessage" class="status-message"></div>
                <div id="domainsContainer" class="domains-grid"></div>
            </div>
        </main>
    </div>

    <div id="modalBackdrop" class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <header>
                <h2 id="modalTitle">New Domain</h2>
            </header>
            <form id="domainForm">
                <div class="form-group">
                    <label for="domainInput">Email Domain</label>
                    <input type="text" id="domainInput" placeholder="example.com" required>
                </div>
                <div class="form-group">
                    <label for="descriptionInput">Description</label>
                    <textarea id="descriptionInput" placeholder="Optional notes for founders"></textarea>
                </div>
                <div class="form-group">
                    <label>Client Access</label>
                    <div id="clientOptions" class="client-list"></div>
                    <p style="font-size: 12px; color: var(--muted);">
                        People signing in with this domain will inherit access to the selected clients.
                    </p>
                </div>
            </form>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelModalButton" type="button">Cancel</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="submitDomainButton" type="submit" form="domainForm">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.APP_CONFIG?.API_BASE_URL || 'http://localhost:8000';
        const AUTH_TOKEN_KEY = 'visualizd_auth_token';

        const elements = {
            loginOverlay: document.getElementById('loginOverlay'),
            loginEmail: document.getElementById('loginEmail'),
            loginPassword: document.getElementById('loginPassword'),
            loginButton: document.getElementById('loginButton'),
            loginError: document.getElementById('loginError'),
            appShell: document.getElementById('appShell'),
            founderEmail: document.getElementById('founderEmail'),
            logoutButton: document.getElementById('logoutButton'),
            refreshButton: document.getElementById('refreshButton'),
            newDomainButton: document.getElementById('newDomainButton'),
            statusMessage: document.getElementById('statusMessage'),
            domainsContainer: document.getElementById('domainsContainer'),
            modalBackdrop: document.getElementById('modalBackdrop'),
            modalTitle: document.getElementById('modalTitle'),
            domainForm: document.getElementById('domainForm'),
            domainInput: document.getElementById('domainInput'),
            descriptionInput: document.getElementById('descriptionInput'),
            clientOptions: document.getElementById('clientOptions'),
            cancelModalButton: document.getElementById('cancelModalButton'),
            submitDomainButton: document.getElementById('submitDomainButton'),
        };

        const state = {
            founder: null,
            domains: [],
            clients: [],
            currentMode: 'create',
            currentDomainId: null,
        };

        const getAuthToken = () => localStorage.getItem(AUTH_TOKEN_KEY);
        const setAuthToken = (token) => localStorage.setItem(AUTH_TOKEN_KEY, token);
        const clearAuth = () => localStorage.removeItem(AUTH_TOKEN_KEY);

        const authHeaders = () => {
            const token = getAuthToken();
            return token
                ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                : { 'Content-Type': 'application/json' };
        };

        function showLoginError(message) {
            if (!message) {
                elements.loginError.style.display = 'none';
                elements.loginError.textContent = '';
                return;
            }
            elements.loginError.textContent = message;
            elements.loginError.style.display = 'block';
        }

        function showStatus(message, type = 'success') {
            if (!message) {
                elements.statusMessage.style.display = 'none';
                elements.statusMessage.textContent = '';
                elements.statusMessage.classList.remove('success', 'error');
                return;
            }
            elements.statusMessage.textContent = message;
            elements.statusMessage.style.display = 'block';
            elements.statusMessage.classList.remove('success', 'error');
            elements.statusMessage.classList.add(type);
        }

        async function validateFounderSession() {
            const response = await fetch(`${API_BASE_URL}/api/auth/me`, {
                headers: authHeaders(),
            });
            if (!response.ok) {
                throw new Error('Could not validate founder session.');
            }
            const data = await response.json();
            if (!data.is_founder) {
                throw new Error('Access denied: founder privileges required.');
            }
            state.founder = data;
            return data;
        }

        function renderFounderInfo() {
            if (state.founder?.email) {
                elements.founderEmail.textContent = state.founder.email;
            } else {
                elements.founderEmail.textContent = '';
            }
        }

        function showAppShell() {
            elements.loginOverlay.classList.add('hidden');
            elements.appShell.style.display = 'flex';
            renderFounderInfo();
        }

        function resetLoginForm() {
            elements.loginButton.disabled = false;
            elements.loginButton.textContent = 'Login';
        }

        async function loginFounder() {
            const email = elements.loginEmail.value.trim();
            const password = elements.loginPassword.value;

            if (!email) {
                showLoginError('Please enter your founder email.');
                return;
            }

            elements.loginButton.disabled = true;
            elements.loginButton.textContent = 'Logging in...';
            showLoginError();

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Login failed');
                }

                const data = await response.json();
                setAuthToken(data.access_token);

                await validateFounderSession();
                showAppShell();
                await loadInitialData();
            } catch (error) {
                console.error('Founder login failed', error);
                showLoginError(error.message || 'Unable to log in.');
                clearAuth();
            } finally {
                resetLoginForm();
            }
        }

        function logout() {
            clearAuth();
            state.founder = null;
            state.domains = [];
            state.clients = [];
            window.location.href = 'https://marketably.ai';
        }

        async function attemptExistingSession() {
            const token = getAuthToken();
            if (!token) return false;
            try {
                await validateFounderSession();
                showAppShell();
                await loadInitialData();
                return true;
            } catch (error) {
                console.warn('Existing founder session invalid', error);
                clearAuth();
                return false;
            }
        }

        async function loadInitialData() {
            showStatus('Loading authorized domainsâ€¦', 'success');
            try {
                await Promise.all([loadClients(), loadDomains()]);
                showStatus();
            } catch (error) {
                console.error('Failed to load initial data', error);
                showStatus(error.message || 'Unable to load data.', 'error');
            }
        }

        async function loadClients() {
            const response = await fetch(`${API_BASE_URL}/api/clients`, {
                headers: authHeaders(),
            });
            if (!response.ok) {
                throw new Error('Failed to load clients.');
            }
            state.clients = await response.json();
        }

        async function loadDomains() {
            const response = await fetch(`${API_BASE_URL}/api/founder/authorized-domains`, {
                headers: authHeaders(),
            });
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }
                throw new Error('Failed to load authorized domains.');
            }
            state.domains = await response.json();
            renderDomains();
        }

        function renderDomains() {
            if (!state.domains.length) {
                elements.domainsContainer.innerHTML = `
                    <div class="empty-state">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No authorized domains yet</h3>
                        <p style="font-size: 14px;">Add your first domain to control who can sign in.</p>
                    </div>
                `;
                return;
            }

            elements.domainsContainer.innerHTML = state.domains
                .map((domain) => {
                    const clientBadges = domain.clients
                        .map((client) => `<span class="client-chip">${client.name}</span>`)
                        .join('') || '<span class="description">No clients mapped</span>';
                    const updatedAt = domain.updated_at ? new Date(domain.updated_at).toLocaleString() : 'Unknown';
                    const createdAt = domain.created_at ? new Date(domain.created_at).toLocaleDateString() : 'Unknown';

                    return `
                        <article class="domain-card">
                            <div class="domain-header">
                                <div>
                                    <h2>${domain.domain}</h2>
                                    <div class="domain-meta">
                                        <span>Created ${createdAt}</span>
                                        <span>Updated ${updatedAt}</span>
                                    </div>
                                </div>
                                <button class="btn btn-secondary" data-action="edit-domain" data-domain-id="${domain.id}">Edit</button>
                            </div>
                            <div class="description">${domain.description ? domain.description : 'No description provided.'}</div>
                            <div class="client-chips">${clientBadges}</div>
                        </article>
                    `;
                })
                .join('');

            elements.domainsContainer.querySelectorAll('[data-action="edit-domain"]').forEach((button) => {
                button.addEventListener('click', () => {
                    const domainId = button.getAttribute('data-domain-id');
                    openDomainModal('edit', domainId);
                });
            });
        }

        function openDomainModal(mode, domainId = null) {
            state.currentMode = mode;
            state.currentDomainId = domainId;
            elements.domainForm.reset();

            let selectedIds = new Set();
            if (mode === 'edit' && domainId) {
                const domain = state.domains.find((item) => item.id === domainId);
                if (!domain) {
                    showStatus('Selected domain could not be found.', 'error');
                    return;
                }
                elements.modalTitle.textContent = `Edit ${domain.domain}`;
                elements.domainInput.value = domain.domain;
                elements.descriptionInput.value = domain.description || '';
                selectedIds = new Set(domain.clients.map((client) => client.id));
            } else {
                elements.modalTitle.textContent = 'New Domain';
                elements.domainInput.value = '';
                elements.descriptionInput.value = '';
            }

            renderClientOptions(selectedIds);
            elements.submitDomainButton.textContent = mode === 'edit' ? 'Save Changes' : 'Create Domain';
            elements.modalBackdrop.classList.add('visible');
            setTimeout(() => elements.domainInput.focus(), 50);
        }

        function closeDomainModal() {
            state.currentMode = 'create';
            state.currentDomainId = null;
            elements.modalBackdrop.classList.remove('visible');
        }

        function renderClientOptions(selectedIds = new Set()) {
            if (!state.clients.length) {
                elements.clientOptions.innerHTML = '<p style="font-size: 13px; color: var(--muted);">No clients available yet.</p>';
                return;
            }

            const clientsMarkup = state.clients
                .map((client) => {
                    const checked = selectedIds.has(client.id) ? 'checked' : '';
                    return `
                        <label class="client-option">
                            <input type="checkbox" value="${client.id}" ${checked}>
                            <span>${client.name}</span>
                        </label>
                    `;
                })
                .join('');

            elements.clientOptions.innerHTML = clientsMarkup;
        }

        async function handleDomainFormSubmit(event) {
            event.preventDefault();
            elements.submitDomainButton.disabled = true;
            const domainValue = elements.domainInput.value.trim();
            const descriptionValue = elements.descriptionInput.value.trim();
            const selectedClientIds = Array.from(
                elements.clientOptions.querySelectorAll('input[type="checkbox"]:checked')
            ).map((input) => input.value);

            if (!domainValue) {
                showStatus('Domain is required.', 'error');
                elements.submitDomainButton.disabled = false;
                return;
            }

            const payload = {
                domain: domainValue,
                description: descriptionValue || null,
                client_ids: selectedClientIds,
            };

            try {
                if (state.currentMode === 'edit' && state.currentDomainId) {
                    await updateDomain(state.currentDomainId, payload);
                    showStatus('Domain updated successfully.', 'success');
                } else {
                    await createDomain(payload);
                    showStatus('Domain created successfully.', 'success');
                }
                closeDomainModal();
                await loadDomains();
            } catch (error) {
                console.error('Domain save failed', error);
                showStatus(error.message || 'Unable to save domain.', 'error');
            } finally {
                elements.submitDomainButton.disabled = false;
            }
        }

        async function createDomain(payload) {
            const response = await fetch(`${API_BASE_URL}/api/founder/authorized-domains`, {
                method: 'POST',
                headers: authHeaders(),
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || 'Failed to create domain.');
            }
            return response.json();
        }

        async function updateDomain(domainId, payload) {
            const response = await fetch(`${API_BASE_URL}/api/founder/authorized-domains/${domainId}`, {
                method: 'PUT',
                headers: authHeaders(),
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || 'Failed to update domain.');
            }
            return response.json();
        }

        elements.loginButton.addEventListener('click', loginFounder);
        elements.logoutButton.addEventListener('click', logout);
        elements.refreshButton.addEventListener('click', loadInitialData);
        elements.newDomainButton.addEventListener('click', () => openDomainModal('create'));
        elements.cancelModalButton.addEventListener('click', closeDomainModal);
        elements.domainForm.addEventListener('submit', handleDomainFormSubmit);

        elements.modalBackdrop.addEventListener('click', (event) => {
            if (event.target === elements.modalBackdrop) {
                closeDomainModal();
            }
        });

        elements.loginEmail.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                loginFounder();
            }
        });

        elements.loginPassword.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                loginFounder();
            }
        });

        attemptExistingSession().then((hasSession) => {
            if (!hasSession) {
                elements.loginOverlay.classList.remove('hidden');
                elements.appShell.style.display = 'none';
            }
        });
    </script>
</body>
</html>
