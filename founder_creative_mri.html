<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founder Tools – Creative MRI</title>
    <link rel="icon" href="/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/styles/founder-admin.css">
    <link rel="stylesheet" href="/styles/founder-creative-mri.css">
    <script src="/config.js"></script>
    <script src="/auth.js"></script>
</head>
<body>
    <div id="loginOverlay" class="login-overlay hidden">
        <div class="login-container">
            <div id="loginFormSection">
                <h2>Sign in</h2>
                <p class="login-subtext">Enter your work email and we'll email you a secure magic link.</p>
                <input type="email" id="loginEmail" placeholder="you@company.com" autocomplete="email">
                <button id="loginButton" type="button">Send Magic Link</button>
                <div id="loginError" class="login-error"></div>
                <div id="loginSuccess" class="login-success"></div>
            </div>
        </div>
    </div>

    <div id="appShell" style="display: none;">
        <header>
            <div>
                <nav class="breadcrumbs">
                    <a href="/founder_admin.html">Founder Admin</a>
                    <span class="breadcrumbs-separator">›</span>
                    <span>Creative MRI</span>
                </nav>
                <h1>Creative Effectiveness Command Center</h1>
                <div class="subtitle">What exists and how it behaves · Why it performs · What to do next.</div>
            </div>
            <div class="founder-meta">
                <span id="founderEmail"></span>
                <button class="btn btn-secondary" id="logoutButton">Logout</button>
            </div>
        </header>

        <main>
            <div class="panel mri-panel brands-imports-panel">
                <h2>Brands & Imports</h2>
                <p class="mri-panel-desc">Add diagnosis-only brands and import ads from Meta Ads Library. These brands do not appear in the visualization app.</p>
                <div class="mri-tabs mri-tabs--primary" role="tablist" aria-label="Brand type">
                    <button class="mri-tab mri-tab--active" role="tab" id="tabNewBrand" data-tab="new">New Brand</button>
                    <button class="mri-tab" role="tab" id="tabExistingBrand" data-tab="existing">Existing Brand</button>
                    <button class="mri-tab" role="tab" id="tabHistory" data-tab="history">History</button>
                </div>

                <div id="paneNewBrand" class="mri-tab-pane mri-tab-pane--active" role="tabpanel">
                    <div class="mri-form-section">
                        <div class="mri-form-row">
                            <label for="brandNameInput">Brand name</label>
                            <input type="text" id="brandNameInput" placeholder="e.g. Acme Corp" />
                        </div>
                        <div class="mri-form-row">
                            <label for="newBrandUrlInput">Meta Ads Library URL</label>
                            <input type="url" id="newBrandUrlInput" placeholder="https://www.facebook.com/ads/library/..." />
                        </div>
                        <button class="btn btn-primary" id="addAndImportButton">Add and Import</button>
                        <div id="addAndImportMessage" class="mri-message" style="display: none;"></div>
                    </div>
                </div>

                <div id="paneExistingBrand" class="mri-tab-pane" role="tabpanel" hidden>
                    <div class="mri-form-row">
                        <label for="existingBrandSelect">Brand</label>
                        <select id="existingBrandSelect">
                            <option value="">Select a brand</option>
                        </select>
                    </div>
                    <div id="existingBrandImportSection" class="mri-existing-import-section" hidden>
                        <div class="mri-tabs mri-tabs--secondary" role="tablist" aria-label="Import type">
                            <button class="mri-tab mri-tab--active" role="tab" id="tabExistingImport" data-tab="existing-import">Existing Import</button>
                            <button class="mri-tab" role="tab" id="tabNewImport" data-tab="new-import">New Import</button>
                        </div>
                        <div id="paneExistingImport" class="mri-tab-pane mri-tab-pane--active" role="tabpanel">
                        <div class="mri-form-row">
                            <label for="importSelect">Ad Library import</label>
                            <select id="importSelect">
                                <option value="">Use latest import</option>
                            </select>
                        </div>
                        <div id="recentReportsSection" class="mri-form-row" style="display: none;">
                            <label>Load saved report</label>
                            <select id="recentReportsSelect">
                                <option value="">— No saved reports —</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="runReportButton">Run report</button>
                    </div>
                    <div id="paneNewImport" class="mri-tab-pane" role="tabpanel" hidden>
                        <div class="mri-form-row">
                            <label for="existingBrandUrlInput">Meta Ads Library URL</label>
                            <input type="url" id="existingBrandUrlInput" placeholder="https://www.facebook.com/ads/library/..." />
                        </div>
                        <div class="mri-form-row mri-form-row--inline">
                            <label for="importScrollsInput">Scrolls (1–20)</label>
                            <input type="number" id="importScrollsInput" min="1" max="20" value="5" class="mri-input-narrow" />
                        </div>
                        <button class="btn btn-primary" id="importAdsButton">Import Ads</button>
                        <div id="importAdsMessage" class="mri-message" style="display: none;"></div>
                    </div>
                    </div>
                </div>

                <div id="paneHistory" class="mri-tab-pane" role="tabpanel" hidden>
                    <p class="mri-panel-desc">Previous reports you can reopen. Click a report to view it.</p>
                    <div id="historyReportsList" class="mri-history-list">
                        <p class="mri-history-empty" id="historyEmpty">Loading…</p>
                    </div>
                </div>
            </div>

            <div class="panel mri-results" id="mriResults" style="display: none;">
                <div class="command-center-filters" id="mriFilters" style="display: none;">
                    <span>Brand: <strong id="filterBrand">—</strong></span>
                    <span>Import: <strong id="filterImport">—</strong></span>
                </div>
                <h2>Report</h2>
                <p class="mri-panel-desc" id="mriLabel">Copy-based effectiveness diagnostics.</p>
                <div id="mriLoading" class="mri-loading mri-loading--active" style="display: none;">
                    <div class="mri-loading-spinner" aria-hidden="true"></div>
                    <p class="mri-loading-title">Running report…</p>
                    <p class="mri-loading-detail" id="mriLoadingDetail">Claude analyzes each ad (plus Gemini for video). This can take 1–2 minutes for many ads.</p>
                    <div class="mri-progress-container" style="margin-top: 16px; max-width: 360px; width: 100%;">
                        <div class="mri-progress-track">
                            <div class="mri-progress-fill" id="mriProgressFill" style="width: 0%"></div>
                        </div>
                        <p class="mri-progress-message" id="mriProgressMessage" style="margin: 8px 0 0 0; font-size: 13px; color: var(--muted, #718096);"></p>
                    </div>
                </div>
                <div id="mriContent" style="display: none;">
                    <div class="command-center-grid">
                        <div class="command-center-section health-summary">
                            <h3>Health Summary</h3>
                            <div class="mri-summary" id="mriSummary"></div>
                        </div>
                        <div class="command-center-section impact-scoreboard">
                            <h3>Impact Scoreboard</h3>
                            <div id="mriImpactScoreboard"></div>
                        </div>
                    </div>
                    <h3>Charts</h3>
                    <div class="mri-charts">
                        <div class="mri-chart" id="mriChartSubscores">
                            <h4 class="mri-chart-title">Subscores (average)</h4>
                            <div class="mri-chart-bars" id="mriChartSubscoresBars"></div>
                        </div>
                        <div class="mri-chart" id="mriChartHooks">
                            <h4 class="mri-chart-title">Hook type distribution</h4>
                            <div class="mri-chart-bars" id="mriChartHooksBars"></div>
                        </div>
                        <div class="mri-chart" id="mriChartFunnel">
                            <h4 class="mri-chart-title">Funnel stage distribution</h4>
                            <div class="mri-chart-bars" id="mriChartFunnelBars"></div>
                        </div>
                    </div>
                    <h3>Top Ads (click to expand)</h3>
                    <div id="mriAdsList" class="mri-ads-grid"></div>
                </div>
                <div id="mriEmpty" class="mri-loading" style="display: none;">Run a report to see results.</div>
            </div>
        </main>
    </div>

    <script type="module">
        const API_BASE_URL = window.APP_CONFIG?.API_BASE_URL || 'http://localhost:8000';

        function getAuthHeaders() {
            if (typeof window.Auth !== 'undefined' && typeof window.Auth.getAuthHeaders === 'function') {
                return window.Auth.getAuthHeaders();
            }
            return {};
        }

        const existingBrandSelect = document.getElementById('existingBrandSelect');
        const importSelect = document.getElementById('importSelect');
        const runReportButton = document.getElementById('runReportButton');
        const mriResults = document.getElementById('mriResults');
        const mriLoading = document.getElementById('mriLoading');
        const mriContent = document.getElementById('mriContent');
        const mriEmpty = document.getElementById('mriEmpty');
        const mriSummary = document.getElementById('mriSummary');
        const mriAdsList = document.getElementById('mriAdsList');

        async function loadClients() {
            const res = await fetch(`${API_BASE_URL}/api/clients`, { headers: getAuthHeaders() });
            if (!res.ok) return;
            const clients = await res.json();
            const optionHtml = (c) => {
                const label = c.name || c.client_name || c.id || 'Unknown';
                const suffix = c.ad_library_only ? ' (Diagnosis)' : '';
                return { value: c.id || c.client_id, text: label + suffix };
            };
            existingBrandSelect.innerHTML = '<option value="">Select a brand</option>';
            (clients || []).forEach(c => {
                const { value, text } = optionHtml(c);
                const opt = document.createElement('option');
                opt.value = value;
                opt.textContent = text;
                existingBrandSelect.appendChild(opt);
            });
        }

        function slugify(s) {
            if (!s || typeof s !== 'string') return '';
            return s.toLowerCase().trim()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '') || 'brand';
        }

        async function loadImports() {
            const clientId = existingBrandSelect.value;
            if (!clientId) {
                importSelect.innerHTML = '<option value="">Select a client first</option>';
                return;
            }
            const res = await fetch(`${API_BASE_URL}/api/clients/${clientId}/ad-library-imports`, { headers: getAuthHeaders() });
            if (!res.ok) {
                importSelect.innerHTML = '<option value="">Use latest import</option>';
                return;
            }
            const data = await res.json();
            importSelect.innerHTML = '<option value="">Use latest import</option>';
            (data.items || []).forEach(imp => {
                const opt = document.createElement('option');
                opt.value = imp.id;
                opt.textContent = `Import ${imp.ad_count || 0} ads · ${imp.imported_at ? new Date(imp.imported_at).toLocaleDateString() : ''}`;
                importSelect.appendChild(opt);
            });
        }

        const existingBrandImportSection = document.getElementById('existingBrandImportSection');
        existingBrandSelect.addEventListener('change', () => {
            const hasBrand = !!existingBrandSelect.value;
            existingBrandImportSection.hidden = !hasBrand;
            if (hasBrand) {
                loadImports();
                loadRecentReports();
            } else {
                document.getElementById('recentReportsSection').style.display = 'none';
            }
        });

        document.getElementById('recentReportsSelect').addEventListener('change', async () => {
            const reportId = document.getElementById('recentReportsSelect').value;
            const clientId = existingBrandSelect.value;
            if (!reportId || !clientId) return;
            setUrlReportParams(clientId, reportId);
            await loadStoredReportAndRender();
        });

        function switchPrimaryTab(tab) {
            const isNew = tab === 'new';
            const isExisting = tab === 'existing';
            const isHistory = tab === 'history';
            document.getElementById('tabNewBrand').classList.toggle('mri-tab--active', isNew);
            document.getElementById('tabExistingBrand').classList.toggle('mri-tab--active', isExisting);
            document.getElementById('tabHistory').classList.toggle('mri-tab--active', isHistory);
            document.getElementById('paneNewBrand').classList.toggle('mri-tab-pane--active', isNew);
            document.getElementById('paneNewBrand').hidden = !isNew;
            document.getElementById('paneExistingBrand').classList.toggle('mri-tab-pane--active', isExisting);
            document.getElementById('paneExistingBrand').hidden = !isExisting;
            document.getElementById('paneHistory').classList.toggle('mri-tab-pane--active', isHistory);
            document.getElementById('paneHistory').hidden = !isHistory;
            if (isHistory) loadHistoryReports();
        }
        function switchSecondaryTab(tab) {
            const isExisting = tab === 'existing-import';
            document.getElementById('tabExistingImport').classList.toggle('mri-tab--active', isExisting);
            document.getElementById('tabNewImport').classList.toggle('mri-tab--active', !isExisting);
            const paneExisting = document.getElementById('paneExistingImport');
            const paneNew = document.getElementById('paneNewImport');
            paneExisting.classList.toggle('mri-tab-pane--active', isExisting);
            paneExisting.hidden = !isExisting;
            paneNew.classList.toggle('mri-tab-pane--active', !isExisting);
            paneNew.hidden = isExisting;
        }
        document.getElementById('tabNewBrand').addEventListener('click', () => switchPrimaryTab('new'));
        document.getElementById('tabExistingBrand').addEventListener('click', () => switchPrimaryTab('existing'));
        document.getElementById('tabHistory').addEventListener('click', () => switchPrimaryTab('history'));
        document.getElementById('tabExistingImport').addEventListener('click', () => switchSecondaryTab('existing-import'));
        document.getElementById('tabNewImport').addEventListener('click', () => switchSecondaryTab('new-import'));

        document.getElementById('addAndImportButton').addEventListener('click', async () => {
            const nameInput = document.getElementById('brandNameInput');
            const urlInput = document.getElementById('newBrandUrlInput');
            const msgEl = document.getElementById('addAndImportMessage');
            const name = (nameInput?.value || '').trim();
            const url = (urlInput?.value || '').trim();
            if (!name) {
                msgEl.textContent = 'Enter a brand name.';
                msgEl.style.display = 'block';
                msgEl.className = 'mri-message mri-message--error';
                return;
            }
            if (!url) {
                msgEl.textContent = 'Enter a Meta Ads Library URL (must include view_all_page_id).';
                msgEl.style.display = 'block';
                msgEl.className = 'mri-message mri-message--error';
                return;
            }
            const slug = slugify(name) || 'brand';
            msgEl.style.display = 'none';
            const btn = document.getElementById('addAndImportButton');
            btn.disabled = true;
            try {
                const createRes = await fetch(`${API_BASE_URL}/api/clients`, {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, slug, ad_library_only: true }),
                });
                const createData = await createRes.json().catch(() => ({}));
                if (!createRes.ok) {
                    msgEl.textContent = createData.detail || `Error ${createRes.status}`;
                    msgEl.className = 'mri-message mri-message--error';
                    msgEl.style.display = 'block';
                    return;
                }
                const brandId = createData.id || createData.client_id;
                const importRes = await fetch(`${API_BASE_URL}/api/clients/${brandId}/ad-library-imports`, {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_url: url, max_scrolls: 5 }),
                });
                const importData = await importRes.json().catch(() => ({}));
                if (!importRes.ok) {
                    msgEl.textContent = importData.detail || `Brand created, but import failed: ${importRes.status}`;
                    msgEl.className = 'mri-message mri-message--error';
                    msgEl.style.display = 'block';
                    await loadClients();
                    return;
                }
                msgEl.textContent = `Brand "${name}" added. Importing ads… (checking every 10 seconds). Report will run automatically when ready.`;
                msgEl.className = 'mri-message mri-message--success';
                msgEl.style.display = 'block';
                nameInput.value = '';
                urlInput.value = '';
                await loadClients();
                existingBrandSelect.value = brandId;
                existingBrandImportSection.hidden = false;
                await loadImports();
                const pollInterval = 10000;
                const maxWait = 3 * 60 * 1000;
                const startedAt = Date.now();
                const pollUntilReady = async () => {
                    while (Date.now() - startedAt < maxWait) {
                        await new Promise((r) => setTimeout(r, pollInterval));
                        const impRes = await fetch(`${API_BASE_URL}/api/clients/${brandId}/ad-library-imports`, { headers: getAuthHeaders() });
                        if (!impRes.ok) continue;
                        const impData = await impRes.json();
                        const items = impData.items || [];
                        if (items.length >= 1 && (items[0].ad_count || 0) > 0) {
                            await loadImports();
                            importSelect.value = items[0].id;
                            mriResults.style.display = 'block';
                            mriLoading.style.display = 'flex';
                            mriContent.style.display = 'none';
                            mriEmpty.style.display = 'none';
                            document.getElementById('mriProgressFill').style.width = '0%';
                            document.getElementById('mriProgressMessage').textContent = '';
                            document.getElementById('mriLoadingDetail').textContent = 'Connecting…';
                            switchPrimaryTab('existing');
                            runReportButton.click();
                            msgEl.textContent = `Import complete. Running report…`;
                            return;
                        }
                        msgEl.textContent = `Importing ads… (${Math.round((Date.now() - startedAt) / 1000)}s elapsed). Report will run when ready.`;
                    }
                    msgEl.textContent = `Import is taking longer than expected. Switch to Existing Brand and run report manually when ready.`;
                    msgEl.className = 'mri-message mri-message--error';
                };
                await pollUntilReady();
            } finally {
                btn.disabled = false;
            }
        });

        document.getElementById('importAdsButton').addEventListener('click', async () => {
            const brandId = existingBrandSelect.value;
            const urlInput = document.getElementById('existingBrandUrlInput');
            const scrollsInput = document.getElementById('importScrollsInput');
            const msgEl = document.getElementById('importAdsMessage');
            const url = (urlInput?.value || '').trim();
            if (!brandId) {
                msgEl.textContent = 'Select a brand first.';
                msgEl.className = 'mri-message mri-message--error';
                msgEl.style.display = 'block';
                return;
            }
            if (!url) {
                msgEl.textContent = 'Enter a Meta Ads Library URL (must include view_all_page_id).';
                msgEl.className = 'mri-message mri-message--error';
                msgEl.style.display = 'block';
                return;
            }
            const scrolls = Math.min(20, Math.max(1, parseInt(scrollsInput.value, 10) || 5));
            msgEl.style.display = 'none';
            const btn = document.getElementById('importAdsButton');
            btn.disabled = true;
            try {
                const res = await fetch(`${API_BASE_URL}/api/clients/${brandId}/ad-library-imports`, {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_url: url, max_scrolls: scrolls }),
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    msgEl.textContent = data.detail || `Error ${res.status}`;
                    msgEl.className = 'mri-message mri-message--error';
                    msgEl.style.display = 'block';
                    return;
                }
                msgEl.textContent = 'Import started. This may take 1–2 minutes. Switch to Existing Import when done to run a report.';
                msgEl.className = 'mri-message mri-message--success';
                msgEl.style.display = 'block';
                urlInput.value = '';
                await loadImports();
            } finally {
                btn.disabled = false;
            }
        });

        runReportButton.addEventListener('click', async () => {
            const clientId = existingBrandSelect.value;
            if (!clientId) {
                alert('Select a brand first.');
                return;
            }
            mriResults.style.display = 'block';
            mriLoading.style.display = 'flex';
            mriContent.style.display = 'none';
            mriEmpty.style.display = 'none';
            document.getElementById('mriProgressFill').style.width = '0%';
            document.getElementById('mriProgressMessage').textContent = '';
            document.getElementById('mriLoadingDetail').textContent = 'Connecting…';
            runReportButton.disabled = true;
            try {
                const body = {};
                const importId = importSelect.value;
                if (importId) body.ad_library_import_id = importId;
                const res = await fetch(`${API_BASE_URL}/api/clients/${clientId}/creative-mri/report?stream=1`, {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    mriLoading.style.display = 'none';
                    mriEmpty.style.display = 'block';
                    mriEmpty.textContent = err.detail || `Error ${res.status}`;
                    return;
                }
                const reader = res.body.getReader();
                const dec = new TextDecoder();
                let buf = '';
                let report = null;
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buf += dec.decode(value, { stream: true });
                    const lines = buf.split('\n');
                    buf = lines.pop() || '';
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.error) {
                                    mriLoading.style.display = 'none';
                                    mriEmpty.style.display = 'block';
                                    mriEmpty.textContent = data.error;
                                    return;
                                }
                                if (data.stage === 'done' && data.report) {
                                    report = data.report;
                                    if (data.report_id && clientId) {
                                        setUrlReportParams(clientId, data.report_id);
                                    }
                                    break;
                                }
                                const total = data.total || 1;
                                const current = data.current || 0;
                                const pct = total > 0 ? Math.round((current / total) * 100) : 0;
                                document.getElementById('mriProgressFill').style.width = pct + '%';
                                document.getElementById('mriProgressMessage').textContent = data.message || '';
                                document.getElementById('mriLoadingDetail').textContent = data.message || 'Processing…';
                            } catch (_) {}
                        }
                    }
                    if (report) break;
                }
                if (!report) {
                    mriLoading.style.display = 'none';
                    mriEmpty.style.display = 'block';
                    mriEmpty.textContent = 'Report incomplete. No data received.';
                    return;
                }
                mriLoading.style.display = 'none';
                mriContent.style.display = 'block';
                const clientOpt = existingBrandSelect.options[existingBrandSelect.selectedIndex];
                const importLabel = importSelect.options[importSelect.selectedIndex]?.textContent || 'Latest';
                renderReport(report, clientOpt?.textContent || '—', importLabel);
                loadRecentReports();
            } catch (e) {
                mriLoading.style.display = 'none';
                mriEmpty.style.display = 'block';
                mriEmpty.textContent = 'Report failed: ' + (e.message || String(e));
                console.error(e);
            } finally {
                runReportButton.disabled = false;
            }
        });

        function escapeHtml(s) {
            if (s == null) return '';
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function getUrlReportParams() {
            const params = new URLSearchParams(window.location.search);
            const clientId = params.get('client_id');
            const reportId = params.get('report_id');
            return { clientId, reportId };
        }

        function setUrlReportParams(clientId, reportId) {
            const url = new URL(window.location.href);
            url.searchParams.set('client_id', clientId);
            url.searchParams.set('report_id', reportId);
            window.history.replaceState({}, '', url.toString());
        }

        function renderReport(report, brandLabel, importLabel) {
            const exec = report.executive_summary || {};
            const ads = report.ads || [];
            const analysis = report.analysis || {};
            const ds = analysis?.analysis?.dataset_summary || {};
            const funnelShare = ds.funnel?.stage_share || {};

            document.getElementById('mriFilters').style.display = 'flex';
            document.getElementById('filterBrand').textContent = brandLabel || '—';
            document.getElementById('filterImport').textContent = importLabel || 'Latest';

            document.getElementById('mriImpactScoreboard').innerHTML = `
                <p><strong>Performance lift potential:</strong> +${Math.round(exec.overall_effectiveness_score || 0) - 50}% (copy-based proxy)</p>
                <p><strong>Biggest drags:</strong></p>
                <ul>${(exec.top_leaks || []).slice(0, 3).map(l => `<li>${l.subscore}</li>`).join('')}</ul>
                <p><strong>Quick wins:</strong></p>
                <ul>${(exec.fast_wins || []).slice(0, 3).map(w => `<li>${escapeHtml(w)}</li>`).join('')}</ul>
                <p class="muted">Funnel mix: TOFU ${Math.round((funnelShare.tofu || 0) * 100)}% / MOFU ${Math.round((funnelShare.mofu || 0) * 100)}% / BOFU ${Math.round((funnelShare.bofu || 0) * 100)}%</p>
            `;

            function renderBarRow(label, value, maxVal, fillClass = '') {
                const pct = maxVal ? Math.round((value / maxVal) * 100) : 0;
                return `
                    <div class="mri-bar-row">
                        <span class="mri-bar-label" title="${escapeHtml(label)}">${escapeHtml(label)}</span>
                        <div class="mri-bar-track"><div class="mri-bar-fill ${fillClass}" style="width: ${pct}%"></div></div>
                        <span class="mri-bar-value">${value}</span>
                    </div>`;
            }

            const subscoresSummary = exec.subscores_summary || [];
            document.getElementById('mriChartSubscoresBars').innerHTML = subscoresSummary
                .map(s => renderBarRow(s.name.replace(/_/g, ' '), s.average.toFixed(1), 20)).join('');

            const hookCounts = {};
            ads.forEach(ad => { const h = ad.hook_type || 'unknown'; hookCounts[h] = (hookCounts[h] || 0) + 1; });
            const hookMax = Math.max(...Object.values(hookCounts), 1);
            document.getElementById('mriChartHooksBars').innerHTML = Object.entries(hookCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([name, count]) => renderBarRow(name, count, hookMax, 'mri-bar-fill--hook')).join('');

            const funnelCounts = {};
            ads.forEach(ad => { const f = ad.funnel_stage || 'unknown'; funnelCounts[f] = (funnelCounts[f] || 0) + 1; });
            const funnelMax = Math.max(...Object.values(funnelCounts), 1);
            document.getElementById('mriChartFunnelBars').innerHTML = Object.entries(funnelCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([name, count]) => renderBarRow(name, count, funnelMax, 'mri-bar-fill--funnel')).join('');

            mriSummary.innerHTML = `
                <h3>Executive summary</h3>
                <p><span class="score">${exec.overall_effectiveness_score ?? 0}</span> / 100 (copy-based effectiveness)</p>
                <p><strong>Subscores:</strong></p>
                <ul>
                    ${(exec.subscores_summary || []).map(s => `<li>${s.name}: ${s.average}</li>`).join('')}
                </ul>
                <p><strong>Top strengths:</strong></p>
                <ul>
                    ${(exec.top_strengths || []).map(s => `<li>${s.subscore} (avg ${s.average}) – ${(s.headline || '').slice(0, 60)}…</li>`).join('')}
                </ul>
                <p><strong>Top leaks:</strong></p>
                <ul>
                    ${(exec.top_leaks || []).map(s => `<li>${s.subscore} (avg ${s.average}) – ${(s.headline || '').slice(0, 60)}…</li>`).join('')}
                </ul>
                <p><strong>Fast wins:</strong></p>
                <ul>
                    ${(exec.fast_wins || []).map(w => `<li>${w}</li>`).join('')}
                </ul>
            `;
            mriAdsList.innerHTML = ads.map(ad => {
                const llm = ad.llm || {};
                const headline = (ad.headline || ad.primary_text || '').slice(0, 120);
                const angle = llm.angle || ad.angle || '—';
                const hookPhrase = llm.hook_phrase || ad.hook_phrase || '—';
                const whatToChange = (llm.what_to_change || ad.what_to_change || []);
                return `
                    <div class="mri-ad-card">
                        <div class="headline">${escapeHtml(headline)}</div>
                        <div class="angle">Angle: ${escapeHtml(angle)}</div>
                        <div class="hook-phrase">Hook: ${escapeHtml(hookPhrase)}</div>
                        <div>Score: ${ad.overall_score ?? '—'} · Stage: ${ad.funnel_stage ?? '—'} · Hook: ${ad.hook_type ?? '—'}</div>
                        ${(ad.media_thumbnail_url ? `<img src="${escapeHtml(ad.media_thumbnail_url)}" alt="" class="mri-ad-thumb">` : '')}
                        ${whatToChange.length ? `<div class="what-to-change"><strong>What to change:</strong><ul>${whatToChange.map(w => `<li>${escapeHtml(w)}</li>`).join('')}</ul></div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function loadReportById(clientId, reportId) {
            const res = await fetch(`${API_BASE_URL}/api/clients/${clientId}/creative-mri/reports/${reportId}`, { headers: getAuthHeaders() });
            if (!res.ok) return null;
            return res.json();
        }

        async function loadStoredReportAndRender() {
            const { clientId, reportId } = getUrlReportParams();
            if (!clientId || !reportId) return false;

            mriResults.style.display = 'block';
            mriLoading.style.display = 'flex';
            mriContent.style.display = 'none';
            mriEmpty.style.display = 'none';
            document.getElementById('mriLoadingDetail').textContent = 'Loading report…';

            const data = await loadReportById(clientId, reportId);
            if (!data) {
                mriLoading.style.display = 'none';
                mriEmpty.style.display = 'block';
                mriEmpty.textContent = 'Report not found.';
                return true;
            }

            if (data.status === 'complete' && data.report) {
                mriLoading.style.display = 'none';
                mriContent.style.display = 'block';
                existingBrandSelect.value = clientId;
                existingBrandImportSection.hidden = false;
                await loadImports();
                await loadRecentReports();
                switchPrimaryTab('existing');
                const clientOpt = existingBrandSelect.options[existingBrandSelect.selectedIndex];
                const meta = data.report.meta || {};
                const adCount = meta.total_ads ?? '?';
                renderReport(data.report, clientOpt?.textContent || '—', `${adCount} ads`);
                return true;
            }

            if (data.status === 'failed') {
                mriLoading.style.display = 'none';
                mriEmpty.style.display = 'block';
                mriEmpty.textContent = data.error_message || 'Report failed.';
                return true;
            }

            // status === 'running' (or pending)
            document.getElementById('mriLoadingDetail').textContent = 'Report is still being generated. Checking every 5 seconds…';
            const pollStoredReport = async () => {
                const d = await loadReportById(clientId, reportId);
                if (!d) return;
                if (d.status === 'complete' && d.report) {
                    mriLoading.style.display = 'none';
                    mriContent.style.display = 'block';
                    existingBrandSelect.value = clientId;
                    existingBrandImportSection.hidden = false;
                    await loadImports();
                    await loadRecentReports();
                    switchPrimaryTab('existing');
                    const clientOpt = existingBrandSelect.options[existingBrandSelect.selectedIndex];
                    const meta = d.report.meta || {};
                    const adCount = meta.total_ads ?? '?';
                    renderReport(d.report, clientOpt?.textContent || '—', `${adCount} ads`);
                    return;
                }
                if (d.status === 'failed') {
                    mriLoading.style.display = 'none';
                    mriEmpty.style.display = 'block';
                    mriEmpty.textContent = d.error_message || 'Report failed.';
                    return;
                }
                setTimeout(pollStoredReport, 5000);
            };
            setTimeout(pollStoredReport, 5000);
            return true;
        }

        async function loadRecentReports() {
            const clientId = existingBrandSelect.value;
            const sel = document.getElementById('recentReportsSelect');
            const section = document.getElementById('recentReportsSection');
            if (!clientId) {
                section.style.display = 'none';
                return;
            }
            const res = await fetch(`${API_BASE_URL}/api/clients/${clientId}/creative-mri/reports?limit=20`, { headers: getAuthHeaders() });
            if (!res.ok) {
                section.style.display = 'none';
                return;
            }
            const data = await res.json();
            const items = data.items || [];
            sel.innerHTML = '<option value="">— No saved reports —</option>';
            items.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                const status = r.status === 'complete' ? 'complete' : r.status;
                const date = r.created_at ? new Date(r.created_at).toLocaleString() : '';
                opt.textContent = `${status} · ${date}`;
                sel.appendChild(opt);
            });
            section.style.display = items.length ? 'block' : 'none';
        }

        async function loadHistoryReports() {
            const listEl = document.getElementById('historyReportsList');
            const emptyEl = document.getElementById('historyEmpty');
            emptyEl.textContent = 'Loading…';
            emptyEl.style.display = 'block';
            listEl.querySelectorAll('.mri-history-item').forEach(el => el.remove());
            try {
                const res = await fetch(`${API_BASE_URL}/api/creative-mri/reports?limit=50`, { headers: getAuthHeaders() });
                if (!res.ok) {
                    emptyEl.textContent = 'Failed to load reports.';
                    return;
                }
                const data = await res.json();
                const items = data.items || [];
                emptyEl.style.display = items.length ? 'none' : 'block';
                emptyEl.textContent = items.length ? '' : 'No previous reports yet. Run a report from New Brand or Existing Brand.';
                items.forEach(r => {
                    const row = document.createElement('button');
                    row.type = 'button';
                    row.className = 'mri-history-item';
                    const date = r.created_at ? new Date(r.created_at).toLocaleString() : '—';
                    const adInfo = r.ad_count != null ? ` · ${r.ad_count} ads` : '';
                    const statusLabel = r.status === 'complete' ? 'Complete' : r.status === 'running' ? 'Running' : r.status === 'failed' ? 'Failed' : r.status;
                    row.innerHTML = `
                        <span class="mri-history-brand">${escapeHtml(r.client_name || '—')}</span>
                        <span class="mri-history-meta">${escapeHtml(date)}${escapeHtml(adInfo)} · ${escapeHtml(statusLabel)}</span>
                    `;
                    row.addEventListener('click', async () => {
                        setUrlReportParams(r.client_id, r.id);
                        await loadStoredReportAndRender();
                    });
                    listEl.appendChild(row);
                });
            } catch (e) {
                emptyEl.textContent = 'Failed to load reports.';
                emptyEl.style.display = 'block';
            }
        }

        function showApp() {
            document.getElementById('appShell').style.display = 'flex';
            document.getElementById('founderEmail').textContent = window.Auth?.getStoredUserInfo?.()?.email || '';
            loadClients().then(async () => {
                const loaded = await loadStoredReportAndRender();
                if (!loaded) existingBrandImportSection.hidden = !existingBrandSelect.value;
            });
        }

        function init() {
            document.getElementById('logoutButton').addEventListener('click', () => {
                if (window.Auth?.handleLogout) window.Auth.handleLogout();
            });
            if (typeof window.Auth !== 'undefined' && typeof window.Auth.checkAuth === 'function') {
                window.Auth.checkAuth().then(showApp).catch(() => {});
            } else {
                showApp();
            }
        }
        init();
    </script>
</body>
</html>
