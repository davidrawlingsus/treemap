<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founder Tools – Creative MRI</title>
    <link rel="icon" href="/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/styles/founder-admin.css">
    <link rel="stylesheet" href="/styles/founder-creative-mri.css">
    <link rel="stylesheet" href="/styles/ads.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script src="/config.js"></script>
    <script src="/auth.js"></script>
</head>
<body>
    <div id="loginOverlay" class="login-overlay hidden">
        <div class="login-container">
            <div id="loginFormSection">
                <h2>Sign in</h2>
                <p class="login-subtext">Enter your work email and we'll email you a secure magic link.</p>
                <input type="email" id="loginEmail" placeholder="you@company.com" autocomplete="email">
                <button id="loginButton" type="button">Send Magic Link</button>
                <div id="loginError" class="login-error"></div>
                <div id="loginSuccess" class="login-success"></div>
            </div>
        </div>
    </div>

    <div id="appShell" style="display: none;">
        <header>
            <div>
                <nav class="breadcrumbs">
                    <a href="/founder_admin.html">Founder Admin</a>
                    <span class="breadcrumbs-separator">›</span>
                    <span>Creative MRI</span>
                </nav>
                <h1>Creative Effectiveness Command Center</h1>
                <div class="subtitle">What exists and how it behaves · Why it performs · What to do next.</div>
            </div>
            <div class="founder-meta">
                <span id="founderEmail"></span>
                <button class="btn btn-secondary" id="logoutButton">Logout</button>
            </div>
        </header>

        <main id="mriMain" class="mri-main">
            <div id="mriSetupSidebarSlot" class="mri-setup-sidebar-slot">
                <div class="panel mri-panel brands-imports-panel" id="brandsImportsPanel">
                <h2>Brands & Imports</h2>
                <p class="mri-panel-desc">Add diagnosis-only brands and import ads from Meta Ads Library. These brands do not appear in the visualization app.</p>
                <div class="mri-tabs mri-tabs--primary" role="tablist" aria-label="Brand type">
                    <button class="mri-tab mri-tab--active" role="tab" id="tabNewBrand" data-tab="new">New Brand</button>
                    <button class="mri-tab" role="tab" id="tabExistingBrand" data-tab="existing">Existing Brand</button>
                    <button class="mri-tab" role="tab" id="tabHistory" data-tab="history">History</button>
                </div>

                <div id="paneNewBrand" class="mri-tab-pane mri-tab-pane--active" role="tabpanel">
                    <div class="mri-form-section">
                        <div class="mri-form-row">
                            <label for="brandNameInput">Brand name</label>
                            <input type="text" id="brandNameInput" placeholder="e.g. Acme Corp" />
                        </div>
                        <div class="mri-form-row">
                            <label for="newBrandUrlInput">Meta Ads Library URL</label>
                            <input type="url" id="newBrandUrlInput" placeholder="https://www.facebook.com/ads/library/..." />
                        </div>
                        <button class="btn btn-primary" id="addAndImportButton">Import and Run</button>
                        <div id="addAndImportMessage" class="mri-message" style="display: none;"></div>
                    </div>
                </div>

                <div id="paneExistingBrand" class="mri-tab-pane" role="tabpanel" hidden>
                    <div class="mri-form-row">
                        <label for="existingBrandSelect">Brand</label>
                        <select id="existingBrandSelect">
                            <option value="">Select a brand</option>
                        </select>
                    </div>
                    <div id="existingBrandImportSection" class="mri-existing-import-section" hidden>
                        <div class="mri-tabs mri-tabs--secondary" role="tablist" aria-label="Import type">
                            <button class="mri-tab mri-tab--active" role="tab" id="tabExistingImport" data-tab="existing-import">Existing Import</button>
                            <button class="mri-tab" role="tab" id="tabNewImport" data-tab="new-import">New Import</button>
                        </div>
                        <div id="paneExistingImport" class="mri-tab-pane mri-tab-pane--active" role="tabpanel">
                        <div class="mri-form-row">
                            <label for="importSelect">Ad Library import</label>
                            <select id="importSelect">
                                <option value="">Use latest import</option>
                            </select>
                        </div>
                        <div id="recentReportsSection" class="mri-form-row" style="display: none;">
                            <label>Load saved report</label>
                            <select id="recentReportsSelect">
                                <option value="">— No saved reports —</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="runReportButton">Run report</button>
                    </div>
                    <div id="paneNewImport" class="mri-tab-pane" role="tabpanel" hidden>
                        <div class="mri-form-row">
                            <label for="existingBrandUrlInput">Meta Ads Library URL</label>
                            <input type="url" id="existingBrandUrlInput" placeholder="https://www.facebook.com/ads/library/..." />
                        </div>
                        <div class="mri-form-row mri-form-row--inline">
                            <label for="importScrollsInput">Scrolls (1–20)</label>
                            <input type="number" id="importScrollsInput" min="1" max="20" value="5" class="mri-input-narrow" />
                        </div>
                        <button class="btn btn-primary" id="importAdsButton">Import Ads</button>
                        <div id="importAdsMessage" class="mri-message" style="display: none;"></div>
                    </div>
                    </div>
                </div>

                <div id="paneHistory" class="mri-tab-pane" role="tabpanel" hidden>
                    <p class="mri-panel-desc">Previous reports you can reopen. Click a report to view it.</p>
                    <div id="historyReportsList" class="mri-history-list">
                        <p class="mri-history-empty" id="historyEmpty">Loading…</p>
                    </div>
                </div>
                </div>
            </div>

            <div class="mri-setup-modal-overlay" id="mriSetupModalOverlay" aria-hidden="true">
                <div class="mri-setup-modal-backdrop" id="mriSetupModalBackdrop"></div>
                <div class="mri-setup-modal">
                    <button type="button" class="mri-setup-modal__close" id="mriSetupModalClose" aria-label="Close">×</button>
                    <div class="mri-setup-modal__body" id="mriSetupModalBody"></div>
                </div>
            </div>

            <div class="panel mri-results" id="mriResults" style="display: none;">
                <div class="mri-report-header">
                    <h2 id="mriReportTitle" class="mri-report-title">Ad Creative MRI</h2>
                    <div class="mri-report-header-actions">
                        <button type="button" class="mri-edit-pencil-btn" id="mriEditButton" title="Edit report" aria-label="Edit report">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </button>
                        <button type="button" class="btn btn-primary mri-save-btn" id="mriSaveButton">Save</button>
                        <button type="button" class="btn btn-secondary mri-cancel-btn" id="mriCancelEditButton">Cancel</button>
                        <button type="button" class="btn btn-secondary mri-back-to-setup" id="backToSetupButton" style="display: none;">
                            Back to setup
                        </button>
                    </div>
                </div>
                <p class="mri-panel-desc" id="mriLabel">Copy-based effectiveness diagnostics.</p>
                <div id="mriLoading" class="mri-loading mri-loading--active" style="display: none;">
                    <div class="mri-loading-prelude">
                        <div class="mri-loading-spinner" aria-hidden="true"></div>
                        <p class="mri-loading-title">Running report…</p>
                        <p class="mri-loading-detail" id="mriLoadingDetail">Claude analyzes each ad (plus Gemini for video and images). This can take 1–2 minutes for many ads.</p>
                    </div>
                    <div class="mri-progress-container" style="margin-top: 0; max-width: 360px; width: 100%;">
                        <div class="mri-progress-track">
                            <div class="mri-progress-fill" id="mriProgressFill" style="width: 0%"></div>
                        </div>
                        <p class="mri-progress-message" id="mriProgressMessage"></p>
                        <p class="mri-loading-stuck" id="mriLoadingStuck" style="display: none;"></p>
                    </div>
                </div>
                <div id="mriContent" style="display: none;">
                    <div class="command-center-section health-summary command-center-section--full">
                        <h3 class="mri-section-heading">Health Summary</h3>
                        <div class="mri-summary" id="mriSummary"></div>
                    </div>
                    <div class="command-center-section impact-scoreboard">
                        <div class="impact-scoreboard-grid" id="mriImpactScoreboard"></div>
                    </div>
                    <h3 class="mri-section-heading">Charts</h3>
                    <div class="mri-charts">
                        <div class="mri-chart" id="mriChartSubscores">
                            <h4 class="mri-chart-title mri-subsection-heading">Subscores (average)</h4>
                            <div class="mri-chart-bars" id="mriChartSubscoresBars"></div>
                        </div>
                        <div class="mri-chart" id="mriChartHooks">
                            <h4 class="mri-chart-title mri-subsection-heading">Hook type distribution</h4>
                            <div class="mri-chart-bars" id="mriChartHooksBars"></div>
                        </div>
                        <div class="mri-chart" id="mriChartFunnel">
                            <h4 class="mri-chart-title mri-subsection-heading">Funnel stage distribution</h4>
                            <div class="mri-chart-bars" id="mriChartFunnelBars"></div>
                        </div>
                        <div class="mri-chart mri-chart--d3">
                            <h4 class="mri-chart-title mri-subsection-heading">1. Launch cadence (launches/week)</h4>
                            <div id="mriChartLaunchCadence"></div>
                        </div>
                        <div class="mri-chart mri-chart--d3">
                            <h4 class="mri-chart-title mri-subsection-heading">2. Rotation depth (active creatives/week)</h4>
                            <div id="mriChartRotationDepth"></div>
                        </div>
                        <div class="mri-chart mri-chart--d3">
                            <h4 class="mri-chart-title mri-subsection-heading">3. Creative half-life (run length days)</h4>
                            <div id="mriChartHalfLife"></div>
                        </div>
                        <div class="mri-chart mri-chart--d3">
                            <h4 class="mri-chart-title mri-subsection-heading">4. Format mix over time</h4>
                            <div id="mriChartFormatMix"></div>
                        </div>
                        <div class="mri-chart mri-chart--d3">
                            <h4 class="mri-chart-title mri-subsection-heading">5. Funnel mix over time</h4>
                            <div id="mriChartFunnelMix"></div>
                        </div>
                        <div class="mri-chart mri-chart--d3">
                            <h4 class="mri-chart-title mri-subsection-heading">6. Hook × Funnel</h4>
                            <div id="mriChartHookFunnel"></div>
                        </div>
                        <div class="mri-chart mri-chart--d3">
                            <h4 class="mri-chart-title mri-subsection-heading">7. Hook quality (overall by type)</h4>
                            <div id="mriChartHookQuality"></div>
                        </div>
                        <div class="mri-chart mri-chart--d3">
                            <h4 class="mri-chart-title mri-subsection-heading">8. Copy tradeoff (specificity vs emotional pull)</h4>
                            <div id="mriChartCopyTradeoff"></div>
                        </div>
                    </div>
                    <h3 class="mri-section-heading">Ad Critique</h3>
                    <div id="mriAdsList" class="mri-ads-grid"></div>
                </div>
                <div id="mriEmpty" class="mri-loading" style="display: none;">Run a report to see results.</div>
            </div>
        </main>
    </div>

    <script type="module">
        import { renderAllMriCharts } from '/js/renderers/mri-charts.js';
        import { renderFBAdMockup, formatCTA, extractDomain, formatPrimaryText } from '/js/renderers/fb-ad-mockup.js';
        import { toPascalCase } from '/js/utils/format.js';
        import { updateCreativeMriReport } from '/js/services/api-creative-mri.js';

        const API_BASE_URL = window.APP_CONFIG?.API_BASE_URL || 'http://localhost:8000';

        if (/mri_debug=1/i.test(window.location.search || '')) {
            window.addEventListener('error', (e) => {
                console.error('[MRI-DEBUG] uncaught error:', e.message, e.filename, e.lineno, e.colno, e.error);
            });
            window.addEventListener('unhandledrejection', (e) => {
                console.error('[MRI-DEBUG] unhandled rejection:', e.reason);
            });
        }

        function getAuthHeaders() {
            if (typeof window.Auth !== 'undefined' && typeof window.Auth.getAuthHeaders === 'function') {
                return window.Auth.getAuthHeaders();
            }
            return {};
        }

        const existingBrandSelect = document.getElementById('existingBrandSelect');
        const importSelect = document.getElementById('importSelect');
        const runReportButton = document.getElementById('runReportButton');
        const mriResults = document.getElementById('mriResults');
        const mriLoading = document.getElementById('mriLoading');
        const mriContent = document.getElementById('mriContent');
        const mriEmpty = document.getElementById('mriEmpty');
        const mriSummary = document.getElementById('mriSummary');
        const mriAdsList = document.getElementById('mriAdsList');
        const mriImpactScoreboard = document.getElementById('mriImpactScoreboard');
        let mriMasonryInstance = null;
        let currentReportData = null;

        async function loadClients() {
            const res = await fetch(`${API_BASE_URL}/api/clients`, { headers: getAuthHeaders() });
            if (!res.ok) return;
            const clients = await res.json();
            const optionHtml = (c) => {
                const label = c.name || c.client_name || c.id || 'Unknown';
                const suffix = c.ad_library_only ? ' (Diagnosis)' : '';
                return { value: c.id || c.client_id, text: label + suffix };
            };
            existingBrandSelect.innerHTML = '<option value="">Select a brand</option>';
            (clients || []).forEach(c => {
                const { value, text } = optionHtml(c);
                const opt = document.createElement('option');
                opt.value = value;
                opt.textContent = text;
                existingBrandSelect.appendChild(opt);
            });
        }

        function slugify(s) {
            if (!s || typeof s !== 'string') return '';
            return s.toLowerCase().trim()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '') || 'brand';
        }

        async function loadImports() {
            const clientId = existingBrandSelect.value;
            if (!clientId) {
                importSelect.innerHTML = '<option value="">Select a client first</option>';
                return;
            }
            const res = await fetch(`${API_BASE_URL}/api/clients/${clientId}/ad-library-imports`, { headers: getAuthHeaders() });
            if (!res.ok) {
                importSelect.innerHTML = '<option value="">Use latest import</option>';
                return;
            }
            const data = await res.json();
            importSelect.innerHTML = '<option value="">Use latest import</option>';
            (data.items || []).forEach(imp => {
                const opt = document.createElement('option');
                opt.value = imp.id;
                opt.textContent = `Import ${imp.ad_count || 0} ads · ${imp.imported_at ? new Date(imp.imported_at).toLocaleDateString() : ''}`;
                importSelect.appendChild(opt);
            });
        }

        const existingBrandImportSection = document.getElementById('existingBrandImportSection');
        existingBrandSelect.addEventListener('change', () => {
            const hasBrand = !!existingBrandSelect.value;
            existingBrandImportSection.hidden = !hasBrand;
            if (hasBrand) {
                loadImports();
                loadRecentReports();
            } else {
                document.getElementById('recentReportsSection').style.display = 'none';
            }
        });

        document.getElementById('recentReportsSelect').addEventListener('change', async () => {
            const reportId = document.getElementById('recentReportsSelect').value;
            const clientId = existingBrandSelect.value;
            if (!reportId || !clientId) return;
            closeSetupModal();
            setUrlReportParams(clientId, reportId);
            await loadStoredReportAndRender();
        });

        function switchPrimaryTab(tab) {
            const isNew = tab === 'new';
            const isExisting = tab === 'existing';
            const isHistory = tab === 'history';
            document.getElementById('tabNewBrand').classList.toggle('mri-tab--active', isNew);
            document.getElementById('tabExistingBrand').classList.toggle('mri-tab--active', isExisting);
            document.getElementById('tabHistory').classList.toggle('mri-tab--active', isHistory);
            document.getElementById('paneNewBrand').classList.toggle('mri-tab-pane--active', isNew);
            document.getElementById('paneNewBrand').hidden = !isNew;
            document.getElementById('paneExistingBrand').classList.toggle('mri-tab-pane--active', isExisting);
            document.getElementById('paneExistingBrand').hidden = !isExisting;
            document.getElementById('paneHistory').classList.toggle('mri-tab-pane--active', isHistory);
            document.getElementById('paneHistory').hidden = !isHistory;
            if (isHistory) loadHistoryReports();
        }
        function switchSecondaryTab(tab) {
            const isExisting = tab === 'existing-import';
            document.getElementById('tabExistingImport').classList.toggle('mri-tab--active', isExisting);
            document.getElementById('tabNewImport').classList.toggle('mri-tab--active', !isExisting);
            const paneExisting = document.getElementById('paneExistingImport');
            const paneNew = document.getElementById('paneNewImport');
            paneExisting.classList.toggle('mri-tab-pane--active', isExisting);
            paneExisting.hidden = !isExisting;
            paneNew.classList.toggle('mri-tab-pane--active', !isExisting);
            paneNew.hidden = isExisting;
        }
        document.getElementById('tabNewBrand').addEventListener('click', () => switchPrimaryTab('new'));
        document.getElementById('tabExistingBrand').addEventListener('click', () => switchPrimaryTab('existing'));
        document.getElementById('tabHistory').addEventListener('click', () => switchPrimaryTab('history'));
        document.getElementById('tabExistingImport').addEventListener('click', () => switchSecondaryTab('existing-import'));
        document.getElementById('tabNewImport').addEventListener('click', () => switchSecondaryTab('new-import'));

        document.getElementById('addAndImportButton').addEventListener('click', async () => {
            const nameInput = document.getElementById('brandNameInput');
            const urlInput = document.getElementById('newBrandUrlInput');
            const msgEl = document.getElementById('addAndImportMessage');
            const name = (nameInput?.value || '').trim();
            const url = (urlInput?.value || '').trim();
            if (!name) {
                msgEl.textContent = 'Enter a brand name.';
                msgEl.style.display = 'block';
                msgEl.className = 'mri-message mri-message--error';
                return;
            }
            if (!url) {
                msgEl.textContent = 'Enter a Meta Ads Library URL (must include view_all_page_id).';
                msgEl.style.display = 'block';
                msgEl.className = 'mri-message mri-message--error';
                return;
            }
            const slug = slugify(name) || 'brand';
            msgEl.style.display = 'none';
            const btn = document.getElementById('addAndImportButton');
            btn.disabled = true;
            try {
                const createRes = await fetch(`${API_BASE_URL}/api/clients`, {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, slug, ad_library_only: true }),
                });
                const createData = await createRes.json().catch(() => ({}));
                if (!createRes.ok) {
                    msgEl.textContent = createData.detail || `Error ${createRes.status}`;
                    msgEl.className = 'mri-message mri-message--error';
                    msgEl.style.display = 'block';
                    return;
                }
                const brandId = createData.id || createData.client_id;
                const importRes = await fetch(`${API_BASE_URL}/api/clients/${brandId}/ad-library-imports`, {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_url: url, max_scrolls: 5 }),
                });
                const importData = await importRes.json().catch(() => ({}));
                if (!importRes.ok) {
                    msgEl.textContent = importData.detail || `Brand created, but import failed: ${importRes.status}`;
                    msgEl.className = 'mri-message mri-message--error';
                    msgEl.style.display = 'block';
                    await loadClients();
                    return;
                }
                msgEl.textContent = `Brand "${name}" created. Importing ads… Report will run automatically when ready.`;
                msgEl.className = 'mri-message mri-message--success';
                msgEl.style.display = 'block';
                nameInput.value = '';
                urlInput.value = '';
                await loadClients();
                existingBrandSelect.value = brandId;
                existingBrandImportSection.hidden = false;
                await loadImports();
                const pollInterval = 10000;
                const maxWait = 3 * 60 * 1000;
                const startedAt = Date.now();
                const pollUntilReady = async () => {
                    while (Date.now() - startedAt < maxWait) {
                        await new Promise((r) => setTimeout(r, pollInterval));
                        const impRes = await fetch(`${API_BASE_URL}/api/clients/${brandId}/ad-library-imports`, { headers: getAuthHeaders() });
                        if (!impRes.ok) continue;
                        const impData = await impRes.json();
                        const items = impData.items || [];
                        if (items.length >= 1 && (items[0].ad_count || 0) > 0) {
                            await loadImports();
                            importSelect.value = items[0].id;
                            closeSetupModal();
                            mriResults.style.display = 'block';
                            enterReportView();
                            mriLoading.style.display = 'flex';
                            mriContent.style.display = 'none';
                            mriEmpty.style.display = 'none';
                            document.getElementById('mriProgressFill').style.width = '0%';
                            document.getElementById('mriProgressMessage').textContent = '';
                            mriLoading.classList.remove('mri-loading--progress');
                            document.getElementById('mriLoadingDetail').textContent = 'Starting report…';
                            runReportButton.click();
                            return;
                        }
                        msgEl.textContent = `Importing ads… (${Math.round((Date.now() - startedAt) / 1000)}s elapsed). Report will run when ready.`;
                    }
                    msgEl.textContent = `Import is taking longer than expected. Switch to Existing Brand and run report manually when ready.`;
                    msgEl.className = 'mri-message mri-message--error';
                };
                await pollUntilReady();
            } finally {
                btn.disabled = false;
            }
        });

        document.getElementById('importAdsButton').addEventListener('click', async () => {
            const brandId = existingBrandSelect.value;
            const urlInput = document.getElementById('existingBrandUrlInput');
            const scrollsInput = document.getElementById('importScrollsInput');
            const msgEl = document.getElementById('importAdsMessage');
            const url = (urlInput?.value || '').trim();
            if (!brandId) {
                msgEl.textContent = 'Select a brand first.';
                msgEl.className = 'mri-message mri-message--error';
                msgEl.style.display = 'block';
                return;
            }
            if (!url) {
                msgEl.textContent = 'Enter a Meta Ads Library URL (must include view_all_page_id).';
                msgEl.className = 'mri-message mri-message--error';
                msgEl.style.display = 'block';
                return;
            }
            const scrolls = Math.min(20, Math.max(1, parseInt(scrollsInput.value, 10) || 5));
            msgEl.style.display = 'none';
            const btn = document.getElementById('importAdsButton');
            btn.disabled = true;
            try {
                const res = await fetch(`${API_BASE_URL}/api/clients/${brandId}/ad-library-imports`, {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_url: url, max_scrolls: scrolls }),
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    msgEl.textContent = data.detail || `Error ${res.status}`;
                    msgEl.className = 'mri-message mri-message--error';
                    msgEl.style.display = 'block';
                    return;
                }
                msgEl.textContent = 'Import started. This may take 1–2 minutes. Switch to Existing Import when done to run a report.';
                msgEl.className = 'mri-message mri-message--success';
                msgEl.style.display = 'block';
                urlInput.value = '';
                await loadImports();
            } finally {
                btn.disabled = false;
            }
        });

        runReportButton.addEventListener('click', async () => {
            const clientId = existingBrandSelect.value;
            if (!clientId) {
                alert('Select a brand first.');
                return;
            }
            closeSetupModal();
            mriResults.style.display = 'block';
            enterReportView();
            const brandLabel = existingBrandSelect.options[existingBrandSelect.selectedIndex]?.textContent || '—';
            const reportTitleEl = document.getElementById('mriReportTitle');
            if (reportTitleEl && brandLabel && brandLabel !== '—') {
                reportTitleEl.textContent = `${brandLabel}'s Ad Creative MRI`;
            }
            mriLoading.style.display = 'flex';
            mriContent.style.display = 'none';
            mriEmpty.style.display = 'none';
            document.getElementById('mriProgressFill').style.width = '0%';
            document.getElementById('mriProgressMessage').textContent = '';
            mriLoading.classList.remove('mri-loading--progress');
            document.getElementById('mriLoadingDetail').textContent = 'Starting report…';
            runReportButton.disabled = true;
            const importLabel = importSelect.options[importSelect.selectedIndex]?.textContent || 'Latest';
            try {
                const body = {};
                const importId = importSelect.value;
                if (importId) body.ad_library_import_id = importId;
                const res = await fetch(`${API_BASE_URL}/api/clients/${clientId}/creative-mri/report`, {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    mriLoading.style.display = 'none';
                    mriEmpty.style.display = 'block';
                    mriEmpty.textContent = err.detail || `Error ${res.status}`;
                    return;
                }
                const data = await res.json();
                const reportId = data.report_id;
                if (!reportId) {
                    mriLoading.style.display = 'none';
                    mriEmpty.style.display = 'block';
                    mriEmpty.textContent = 'No report ID returned.';
                    return;
                }
                setUrlReportParams(clientId, reportId);
                await loadStoredReportAndRender();
            } catch (e) {
                mriLoading.style.display = 'none';
                mriEmpty.style.display = 'block';
                mriEmpty.textContent = 'Report failed: ' + (e.message || String(e));
                console.error(e);
            } finally {
                runReportButton.disabled = false;
            }
        });

        function enterReportView() {
            document.getElementById('mriMain').classList.add('mri-report-view');
            document.getElementById('backToSetupButton').style.display = '';
        }
        function exitReportView() {
            document.getElementById('mriMain').classList.remove('mri-report-view');
            document.getElementById('backToSetupButton').style.display = 'none';
        }

        const brandsImportsPanel = document.getElementById('brandsImportsPanel');
        const mriSetupModalOverlay = document.getElementById('mriSetupModalOverlay');
        const mriSetupModalBody = document.getElementById('mriSetupModalBody');
        const mriSetupSidebarSlot = document.getElementById('mriSetupSidebarSlot');
        function openSetupModal() {
            mriSetupModalBody.appendChild(brandsImportsPanel);
            mriSetupModalOverlay.classList.add('mri-setup-modal--open');
            mriSetupModalOverlay.setAttribute('aria-hidden', 'false');
        }
        function closeSetupModal() {
            mriSetupModalOverlay.classList.remove('mri-setup-modal--open');
            mriSetupModalOverlay.setAttribute('aria-hidden', 'true');
            mriSetupSidebarSlot.appendChild(brandsImportsPanel);
        }
        document.getElementById('backToSetupButton').addEventListener('click', openSetupModal);
        document.getElementById('mriSetupModalClose').addEventListener('click', closeSetupModal);
        document.getElementById('mriSetupModalBackdrop').addEventListener('click', closeSetupModal);

        let editModeOriginalSummary = '';
        let editModeOriginalScoreboard = '';
        const mriEditButton = document.getElementById('mriEditButton');
        const mriSaveButton = document.getElementById('mriSaveButton');
        const mriCancelEditButton = document.getElementById('mriCancelEditButton');
        const mriReportHeaderActions = document.querySelector('.mri-report-header-actions');

        function enterEditMode() {
            if (!currentReportData || !mriSummary || !mriImpactScoreboard) return;
            editModeOriginalSummary = mriSummary.innerHTML;
            editModeOriginalScoreboard = mriImpactScoreboard.innerHTML;
            mriSummary.contentEditable = 'true';
            mriImpactScoreboard.contentEditable = 'true';
            mriContent.classList.add('mri-edit-mode');
            mriReportHeaderActions?.classList.add('is-edit-mode');
        }

        function exitEditMode() {
            mriSummary.contentEditable = 'false';
            mriImpactScoreboard.contentEditable = 'false';
            mriContent.classList.remove('mri-edit-mode');
            mriReportHeaderActions?.classList.remove('is-edit-mode');
        }

        mriEditButton?.addEventListener('click', () => {
            if (!currentReportData) return;
            enterEditMode();
        });

        mriCancelEditButton?.addEventListener('click', () => {
            mriSummary.innerHTML = editModeOriginalSummary;
            mriImpactScoreboard.innerHTML = editModeOriginalScoreboard;
            exitEditMode();
        });

        mriSaveButton?.addEventListener('click', async () => {
            if (!currentReportData) return;
            const { report, clientId, reportId } = currentReportData;
            const updatedReport = {
                ...report,
                edited_sections: {
                    summary: mriSummary.innerHTML,
                    impact_scoreboard: mriImpactScoreboard.innerHTML,
                },
            };
            mriSaveButton.disabled = true;
            try {
                await updateCreativeMriReport(clientId, reportId, updatedReport, getAuthHeaders);
                currentReportData = { ...currentReportData, report: updatedReport };
                exitEditMode();
            } catch (err) {
                console.error('Failed to save report:', err);
                alert('Failed to save: ' + (err.message || 'Unknown error'));
            } finally {
                mriSaveButton.disabled = false;
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && mriSetupModalOverlay.classList.contains('mri-setup-modal--open')) {
                closeSetupModal();
            }
        });

        function escapeHtml(s) {
            if (s == null) return '';
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function getUrlReportParams() {
            const params = new URLSearchParams(window.location.search);
            const clientId = params.get('client_id');
            const reportId = params.get('report_id');
            return { clientId, reportId };
        }

        function setUrlReportParams(clientId, reportId) {
            const url = new URL(window.location.href);
            url.searchParams.set('client_id', clientId);
            url.searchParams.set('report_id', reportId);
            window.history.replaceState({}, '', url.toString());
        }

        function renderReport(report, brandLabel, importLabel) {
            const MRI_DEBUG = /mri_debug=1/i.test(window.location.search || '');
            const dbg = (msg, data) => {
                if (!MRI_DEBUG) return;
                const payload = { t: Date.now(), ...(data || {}) };
                console.log('[MRI-DEBUG]', msg, JSON.stringify(payload));
                // #region agent log
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    fetch('http://127.0.0.1:7242/ingest/0ea04ade-be37-4438-ba64-4de28c7d11e9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'founder_creative_mri.html:renderReport',message:msg,data:payload,timestamp:Date.now()})}).catch(()=>{});
                }
                // #endregion
            };
            dbg('renderReport START', { adsCount: (report?.ads || []).length, ua: navigator.userAgent });
            const reportTitleEl = document.getElementById('mriReportTitle');
            if (reportTitleEl) {
                reportTitleEl.textContent = (brandLabel && brandLabel !== '—')
                    ? `${brandLabel}'s Ad Creative MRI`
                    : 'Ad Creative MRI';
            }
            const exec = report.executive_summary || {};
            const ads = report.ads || [];
            const analysis = report.analysis || {};
            // Diagnostic: count ads with video transcripts (for debugging missing transcripts)
            const ds = analysis?.analysis?.dataset_summary || {};
            const funnelShare = ds.funnel?.stage_share || {};

            const edited = report.edited_sections || {};
            if (edited.summary) mriSummary.innerHTML = edited.summary;
            if (edited.impact_scoreboard) mriImpactScoreboard.innerHTML = edited.impact_scoreboard;

            const synth = report.synthesized_summary || {};
            if (synth.executive_summary || synth.dataset_overview || synth.top_5_high_impact_actions) {
                renderSynthesizedSummary(synth, edited);
            } else {
                renderLegacySummary(exec, funnelShare, edited);
            }

            function renderBarRow(label, value, maxVal, fillClass = '') {
                const pct = maxVal ? Math.round((value / maxVal) * 100) : 0;
                return `
                    <div class="mri-bar-row">
                        <span class="mri-bar-label" title="${escapeHtml(label)}">${escapeHtml(label)}</span>
                        <div class="mri-bar-track"><div class="mri-bar-fill ${fillClass}" style="width: ${pct}%"></div></div>
                        <span class="mri-bar-value">${value}</span>
                    </div>`;
            }

            const subscoresSummary = exec.subscores_summary || [];
            document.getElementById('mriChartSubscoresBars').innerHTML = subscoresSummary
                .map(s => renderBarRow(toPascalCase(s.name), s.average.toFixed(1), 100)).join('');

            const ALL_HOOK_TYPES = ['direct_benefit','pain_agitation','authority','social_proof','ranking','newness','contrarian','identity','instructional','urgency_scarcity','story','offer_led','question','curiosity_gap','comparison','mechanism_tease','unknown'];
            const ALL_FUNNEL_STAGES = ['tofu','mofu','bofu'];
            const hookCounts = {};
            ALL_HOOK_TYPES.forEach(h => { hookCounts[h] = 0; });
            ads.forEach(ad => { const h = (ad.hook_type || 'unknown').toLowerCase();
                if (hookCounts[h] !== undefined) hookCounts[h]++; else hookCounts['unknown']++; });
            const hookMax = Math.max(...Object.values(hookCounts), 1);
            document.getElementById('mriChartHooksBars').innerHTML = ALL_HOOK_TYPES
                .map(h => ({ name: h, count: hookCounts[h] ?? 0 }))
                .sort((a, b) => b.count - a.count)
                .map(({ name, count }) => renderBarRow(toPascalCase(name), count, hookMax, 'mri-bar-fill--hook')).join('');

            const funnelCounts = { tofu: 0, mofu: 0, bofu: 0 };
            ads.forEach(ad => { const f = (ad.funnel_stage || 'tofu').toLowerCase();
                if (funnelCounts[f] !== undefined) funnelCounts[f]++; });
            const funnelMax = Math.max(...Object.values(funnelCounts), 1);
            document.getElementById('mriChartFunnelBars').innerHTML = ALL_FUNNEL_STAGES
                .map(f => ({ name: f, count: funnelCounts[f] ?? 0 }))
                .map(({ name, count }) => renderBarRow(name.toUpperCase(), count, funnelMax, 'mri-bar-fill--funnel')).join('');

            function formatSummaryText(str) {
                if (str == null || str === '') return '';
                return escapeHtml(String(str)).replace(/\n/g, '<br>');
            }

            function renderSynthesizedSummary(synth, edited = {}) {
                const exec = synth.executive_summary || {};
                const dataset = synth.dataset_overview || {};
                const actions = synth.top_5_high_impact_actions || [];
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/0ea04ade-be37-4438-ba64-4de28c7d11e9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'founder_creative_mri.html:renderSynthesizedSummary',message:'Impact actions render',data:{actionsCount:actions.length,synthKeys:Object.keys(synth),hypothesisId:'H4_H5'},timestamp:Date.now()})}).catch(()=>{});
                // #endregion
                const funnel = synth.funnel_analysis || {};
                const hook = synth.hook_analysis || {};
                const proof = synth.proof_and_credibility || {};
                const offer = synth.offer_and_conversion || {};
                const roadmap = synth['90_day_creative_roadmap'] || {};

                if (!edited.summary) {
                document.getElementById('mriSummary').innerHTML = `
                    ${exec.core_diagnosis ? `<div class="mri-summary-block"><p><strong>Core diagnosis:</strong> ${formatSummaryText(exec.core_diagnosis)}</p></div>` : ''}
                    ${exec.primary_constraint ? `<div class="mri-summary-block"><p><strong>Primary constraint:</strong> ${formatSummaryText(exec.primary_constraint)}</p></div>` : ''}
                    ${(exec.secondary_constraints || []).length ? `<div class="mri-summary-block"><p><strong>Secondary constraints:</strong></p><ul>${exec.secondary_constraints.map(c => `<li>${formatSummaryText(c)}</li>`).join('')}</ul></div>` : ''}
                    ${(exec.hidden_strengths || []).length ? `<div class="mri-summary-block"><p><strong>Hidden strengths:</strong></p><ul>${exec.hidden_strengths.map(s => `<li>${formatSummaryText(s)}</li>`).join('')}</ul></div>` : ''}
                    ${funnel.structural_gap ? `<div class="mri-summary-block"><p><strong>Funnel gap:</strong> ${formatSummaryText(funnel.structural_gap)}</p></div>` : ''}
                    ${hook.implication ? `<div class="mri-summary-block"><p><strong>Hook implication:</strong> ${formatSummaryText(hook.implication)}</p></div>` : ''}
                    ${proof.risk ? `<div class="mri-summary-block"><p><strong>Proof credibility risk:</strong> ${formatSummaryText(proof.risk)}</p></div>` : ''}
                    ${offer.conversion_structural_risk ? `<div class="mri-summary-block"><p><strong>Conversion risk:</strong> ${formatSummaryText(offer.conversion_structural_risk)}</p></div>` : ''}
                `;
                }

                const actionCells = (actions || []).slice(0, 5).map((a, i) => `
                    <div class="impact-scoreboard-cell mri-action-item">
                        <div class="mri-action-header">
                            <span class="mri-action-number">${i + 1}</span>
                            <div class="mri-action-header-content">
                                <strong>${escapeHtml(a.action_title || 'Action ' + (i + 1))}</strong>
                                <span class="mri-action-meta">${escapeHtml(a.impact_confidence || '')} impact · ${escapeHtml(a.effort_level || '')} effort</span>
                            </div>
                        </div>
                        ${a.why_it_matters ? `<p class="mri-action-why">${formatSummaryText(a.why_it_matters)}</p>` : ''}
                        ${a.what_to_produce?.creative_brief?.length ? `<ul class="mri-action-brief">${(a.what_to_produce.creative_brief || []).map(b => `<li>${formatSummaryText(b)}</li>`).join('')}</ul>` : ''}
                    </div>
                `).join('');
                const roadmapHtml = roadmap.phase_1_weeks_1_4?.focus ? `
                    <div class="impact-scoreboard-cell mri-roadmap-cell">
                        <h4 class="mri-subsection-heading">90-day roadmap</h4>
                        <div class="mri-roadmap-phases">
                            <p><strong>Phase 1 (weeks 1–4):</strong> ${formatSummaryText(roadmap.phase_1_weeks_1_4.focus)}</p>
                            <p><strong>Phase 2 (weeks 5–8):</strong> ${formatSummaryText(roadmap.phase_2_weeks_5_8?.focus || '—')}</p>
                            <p><strong>Phase 3 (weeks 9–12):</strong> ${formatSummaryText(roadmap.phase_3_weeks_9_12?.focus || '—')}</p>
                        </div>
                    </div>
                ` : '';
                const cells = actionCells + roadmapHtml;
                if (!edited.impact_scoreboard) {
                    document.getElementById('mriImpactScoreboard').innerHTML = cells
                        ? `<h3 class="mri-section-heading">Top 5 high-impact actions</h3><div class="impact-scoreboard-grid-inner">${cells}</div>`
                        : '<p class="muted">No synthesized summary available. Run a new report with the synthesize prompt configured.</p>';
                }
            }

            function renderLegacySummary(exec, funnelShare, edited = {}) {
                if (!edited.summary) {
                mriSummary.innerHTML = `
                    <p class="muted" style="margin-bottom: 12px;">Legacy summary — synthesized strategic summary not in this report. Run a new report with the "Ad Creative MRI - Synthesized Summary" prompt configured in Prompt Engineering to see the strategic diagnosis.</p>
                    <h3 class="mri-section-heading">Executive summary</h3>
                    <p><span class="score">${exec.overall_effectiveness_score ?? 0}</span> / 100 (copy-based effectiveness)</p>
                    <p><strong>Subscores:</strong></p>
                    <ul>${(exec.subscores_summary || []).map(s => `<li>${s.name}: ${s.average}</li>`).join('')}</ul>
                    <p><strong>Top strengths:</strong></p>
                    <ul>${(exec.top_strengths || []).map(s => `<li>${s.subscore} (avg ${s.average}) – ${(s.headline || '').slice(0, 60)}…</li>`).join('')}</ul>
                    <p><strong>Top leaks:</strong></p>
                    <ul>${(exec.top_leaks || []).map(s => `<li>${s.subscore} (avg ${s.average}) – ${(s.headline || '').slice(0, 60)}…</li>`).join('')}</ul>
                    <p><strong>Fast wins:</strong></p>
                    <ul>${(exec.fast_wins || []).map(w => `<li>${w}</li>`).join('')}</ul>
                `;
                }
                if (!edited.impact_scoreboard) {
                document.getElementById('mriImpactScoreboard').innerHTML = `
                    <p><strong>Performance lift potential:</strong> +${Math.round(exec.overall_effectiveness_score || 0) - 50}% (copy-based proxy)</p>
                    <p><strong>Biggest drags:</strong></p>
                    <ul>${(exec.top_leaks || []).slice(0, 3).map(l => `<li>${l.subscore}</li>`).join('')}</ul>
                    <p><strong>Quick wins:</strong></p>
                    <ul>${(exec.fast_wins || []).slice(0, 3).map(w => `<li>${escapeHtml(w)}</li>`).join('')}</ul>
                    <p class="muted">Funnel mix: TOFU ${Math.round((funnelShare.tofu || 0) * 100)}% / MOFU ${Math.round((funnelShare.mofu || 0) * 100)}% / BOFU ${Math.round((funnelShare.bofu || 0) * 100)}%</p>
                `;
                }
            }

            dbg('before renderAllMriCharts');
            try {
                renderAllMriCharts(report);
                dbg('renderAllMriCharts DONE');
            } catch (e) {
                dbg('renderAllMriCharts ERROR', { err: String(e), stack: e?.stack });
                console.error('[MRI-DEBUG] renderAllMriCharts threw:', e);
            }

            const firstMediaUrl = (ad) => {
                const items = ad.media_items || [];
                const first = items[0];
                const url = first?.url || ad.media_thumbnail_url || null;
                if (MRI_DEBUG) {
                    console.debug('[MRI media]', {
                        ad_id: ad.id,
                        media_items_count: items.length,
                        media_thumbnail_url: !!ad.media_thumbnail_url,
                        resolved_url: url ? url.substring(0, 80) + '...' : null,
                        source: url ? (first?.url ? 'media_items[0]' : 'media_thumbnail_url') : 'none',
                    });
                }
                return url;
            };
            const getVideoTranscript = (ad) => {
                const items = ad.media_items || [];
                const video = items.find(m => (m || {}).media_type === 'video');
                const analysis = video?.video_analysis_json;
                if (!analysis || typeof analysis !== 'object') {
                    if (MRI_DEBUG && video) {
                        console.debug('[MRI transcript]', {
                            ad_id: ad.id,
                            has_video: true,
                            has_analysis: !!analysis,
                            analysis_type: typeof analysis,
                            video_keys: video ? Object.keys(video) : [],
                        });
                    }
                    return null;
                }
                const transcript = analysis.transcript || analysis.timeline_first_2s?.transcript_excerpt || null;
                if (MRI_DEBUG) {
                    console.debug('[MRI transcript]', {
                        ad_id: ad.id,
                        has_transcript: !!transcript,
                        transcript_len: transcript ? transcript.length : 0,
                        transcript_preview: transcript ? transcript.substring(0, 60) + '...' : null,
                        analysis_keys: Object.keys(analysis),
                    });
                }
                return transcript;
            };
            const KNOWN_CTA_PHRASES = ['shop now', 'learn more', 'sign up', 'get offer', 'download', 'watch more', 'send message', 'apply now', 'book now', 'start trial', 'take quiz'];
            const isLikelyHeadline = (s) => !s || s.length > 25 || !KNOWN_CTA_PHRASES.includes(s.toLowerCase().trim());
            const getCtaForButton = (ad) => {
                if (ad.llm?.cta_type) return formatCTA(ad.llm.cta_type);
                const c = (ad.cta || '').trim();
                if (isLikelyHeadline(c)) return 'Learn more';
                return formatCTA(c.replace(/\s+/g, '_'));
            };
            const getHeadlineForMockup = (ad) => {
                const h = (ad.headline || '').trim();
                if (h) return h;
                const c = (ad.cta || '').trim();
                return isLikelyHeadline(c) ? c : '';
            };
            if (!ads.length) {
                mriAdsList.innerHTML = '<p class="muted">No ads in this report.</p>';
                if (mriMasonryInstance) { mriMasonryInstance.destroy(); mriMasonryInstance = null; }
                dbg('no ads, early return');
                return;
            }
            dbg('before ads.map', { adsLength: ads.length });
            let cardsHtml;
            try {
            cardsHtml = ads.map(ad => {
                const llm = ad.llm || {};
                const angle = llm.angle || ad.angle || '—';
                const whatToChange = (llm.what_to_change || ad.what_to_change || []);
                const mofuJob = (ad.funnel_stage || '').toLowerCase() === 'mofu' ? (llm.mofu_job_type || '') : '';
                const claimAudit = llm.claim_audit || {};
                const topRisk = (claimAudit.top_risks || [])[0];
                const vf2s = llm.video_first_2s || {};
                const isVideo = (ad.ad_format || '').toLowerCase() === 'video' || (ad.media_items || []).some(m => (m || {}).media_type === 'video');
                const first2sBadge = isVideo && vf2s.applicable ? (vf2s.quality || 'missing') : '';
                const videoTranscript = getVideoTranscript(ad);
                const mockup = renderFBAdMockup({
                    adId: ad.id || '',
                    primaryText: formatPrimaryText(ad.primary_text || ''),
                    headline: escapeHtml(getHeadlineForMockup(ad)),
                    description: escapeHtml(ad.description || ''),
                    cta: getCtaForButton(ad),
                    displayUrl: extractDomain(ad.destination_url || ''),
                    logoSrc: '',
                    clientName: brandLabel || 'Sponsored',
                    imageUrl: firstMediaUrl(ad),
                    readOnly: true
                });
                const labelsParts = [
                    `Score: ${ad.overall_score ?? '—'}`,
                    `Stage: ${escapeHtml(ad.funnel_stage ?? '—')}${mofuJob ? ` · ${escapeHtml(mofuJob)}` : ''}`,
                    `Hook: ${escapeHtml(ad.hook_type ?? '—')}`,
                    first2sBadge ? `1st2s: ${escapeHtml(first2sBadge)}` : '',
                    topRisk ? `⚠ ${escapeHtml(topRisk)}` : '',
                    angle !== '—' ? `Angle: ${escapeHtml(angle)}` : ''
                ].filter(Boolean);
                const whatToChangeHtml = whatToChange.length ? `<ul class="ads-card__voc-list">${whatToChange.map(w => `<li class="ads-card__voc-item">${escapeHtml(w)}</li>`).join('')}</ul>` : '<p class="ads-card__detail-value">No suggestions</p>';
                const transcriptHtml = videoTranscript ? `<div class="mri-ad-card__transcript-body">${escapeHtml(videoTranscript)}</div>` : '';
                const accordions = [
                    { title: 'What to change', body: whatToChangeHtml },
                    ...(videoTranscript ? [{ title: 'Video transcript', body: transcriptHtml }] : [])
                ];
                const accordionsHtml = accordions.map(acc => `
                    <div class="ads-accordion">
                        <button class="ads-accordion__trigger" type="button">
                            <span class="ads-accordion__title">${escapeHtml(acc.title)}</span>
                            <svg class="ads-accordion__chevron" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <div class="ads-accordion__content">
                            <div class="ads-accordion__body">${acc.body}</div>
                        </div>
                    </div>
                `).join('');
                return `
                    <div class="mri-ad-card mri-ad-card--masonry ads-card">
                        <div class="mri-ad-card__header ads-card__header">
                            <div class="mri-ad-card__labels">${labelsParts.map(l => `<span class="mri-ad-card__label">${l}</span>`).join('')}</div>
                        </div>
                        <div class="mri-ad-card__mockup ads-card__mockup">${mockup}</div>
                        <div class="ads-card__accordions">${accordionsHtml}</div>
                    </div>
                `;
            }).join('');
            dbg('ads.map DONE', { cardsHtmlLen: cardsHtml?.length });
            } catch (e) {
                dbg('ads.map ERROR', { err: String(e), stack: e?.stack });
                console.error('[MRI-DEBUG] ads.map threw:', e);
                mriAdsList.innerHTML = '<p class="muted">Failed to build ads. Check console.</p>';
                return;
            }
            dbg('before innerHTML');
            mriAdsList.innerHTML = `
                <div class="mri-ads-grid-sizer"></div>
                <div class="mri-ads-gutter-sizer"></div>
                ${cardsHtml}
            `;
            dbg('innerHTML set');
            mriAdsList.classList.add('mri-ads-grid--fallback');
            if (!mriAdsList._accordionHandler) {
                mriAdsList._accordionHandler = true;
                mriAdsList.addEventListener('click', (e) => {
                    const trigger = e.target.closest('.ads-accordion__trigger');
                    if (trigger) {
                        const accordion = trigger.closest('.ads-accordion');
                        if (accordion) {
                            accordion.classList.toggle('expanded');
                            setTimeout(() => mriMasonryInstance?.layout?.(), 260);
                        }
                    }
                });
            }
            dbg('renderReport END');
        }

        async function loadReportById(clientId, reportId) {
            const res = await fetch(`${API_BASE_URL}/api/clients/${clientId}/creative-mri/reports/${reportId}`, { headers: getAuthHeaders() });
            if (!res.ok) return null;
            return res.json();
        }

        async function loadStoredReportAndRender() {
            const { clientId, reportId } = getUrlReportParams();
            if (!clientId || !reportId) return false;

            mriResults.style.display = 'block';
            enterReportView();
            mriLoading.style.display = 'flex';
            mriContent.style.display = 'none';
            mriEmpty.style.display = 'none';
            document.getElementById('mriLoadingDetail').textContent = 'Loading report…';

            const data = await loadReportById(clientId, reportId);
            if (!data) {
                mriLoading.style.display = 'none';
                mriEmpty.style.display = 'block';
                mriEmpty.textContent = 'Report not found.';
                return true;
            }

            if (data.status === 'complete' && data.report) {
                mriLoading.style.display = 'none';
                mriContent.style.display = 'block';
                existingBrandSelect.value = clientId;
                existingBrandImportSection.hidden = false;
                await loadImports();
                await loadRecentReports();
                switchPrimaryTab('existing');
                const clientOpt = existingBrandSelect.options[existingBrandSelect.selectedIndex];
                const meta = data.report.meta || {};
                const adCount = meta.total_ads ?? '?';
                currentReportData = { report: data.report, clientId, reportId };
                renderReport(data.report, clientOpt?.textContent || '—', `${adCount} ads`);
                return true;
            }

            if (data.status === 'failed') {
                mriLoading.style.display = 'none';
                mriEmpty.style.display = 'block';
                mriEmpty.textContent = data.error_message || 'Report failed.';
                return true;
            }

            // status === 'running' (or pending)
            const STUCK_REPORT_MINUTES = 15;
            function updateProgressUI(data) {
                const total = data.progress_total ?? 1;
                const current = data.progress_current ?? 0;
                const msg = data.progress_message || 'Report is still being generated. Checking every 5 seconds…';
                const isSynthesizing = /synthesiz/i.test(msg);
                const adPhaseComplete = total > 0 && current >= total;

                if (isSynthesizing || adPhaseComplete) {
                    mriLoading.classList.remove('mri-loading--progress');
                    mriLoading.classList.add('mri-loading--synthesize');
                    document.getElementById('mriLoadingDetail').textContent = 'Synthesising data, won\'t be long';
                    document.querySelector('.mri-loading-title').textContent = 'Synthesising…';
                    document.getElementById('mriProgressMessage').textContent = '';
                } else {
                    mriLoading.classList.remove('mri-loading--synthesize');
                    const pct = total > 0 ? Math.round((current / total) * 100) : 0;
                    document.getElementById('mriProgressFill').style.width = pct + '%';
                    document.getElementById('mriLoadingDetail').textContent = msg;
                    document.getElementById('mriProgressMessage').textContent = msg;
                    document.querySelector('.mri-loading-title').textContent = 'Running report…';
                    if (total > 0 || msg) {
                        mriLoading.classList.add('mri-loading--progress');
                    }
                }
                const stuckEl = document.getElementById('mriLoadingStuck');
                if (data.created_at) {
                    const started = new Date(data.created_at).getTime();
                    const minutes = Math.floor((Date.now() - started) / 60000);
                    if (minutes >= STUCK_REPORT_MINUTES) {
                        stuckEl.textContent = `This report may be stuck. It's been running for ${minutes} minutes (most complete in 1–2 min). You can go back and try again.`;
                        stuckEl.style.display = 'block';
                    } else {
                        stuckEl.style.display = 'none';
                    }
                } else {
                    stuckEl.style.display = 'none';
                }
            }
            updateProgressUI(data);
            const pollStoredReport = async () => {
                const d = await loadReportById(clientId, reportId);
                if (!d) return;
                if (d.status === 'complete' && d.report) {
                    mriLoading.style.display = 'none';
                    mriContent.style.display = 'block';
                    existingBrandSelect.value = clientId;
                    existingBrandImportSection.hidden = false;
                    await loadImports();
                    await loadRecentReports();
                    switchPrimaryTab('existing');
                    const clientOpt = existingBrandSelect.options[existingBrandSelect.selectedIndex];
                    const meta = d.report.meta || {};
                    const adCount = meta.total_ads ?? '?';
                    currentReportData = { report: d.report, clientId, reportId };
                    renderReport(d.report, clientOpt?.textContent || '—', `${adCount} ads`);
                    return;
                }
                if (d.status === 'failed') {
                    mriLoading.style.display = 'none';
                    mriEmpty.style.display = 'block';
                    mriEmpty.textContent = d.error_message || 'Report failed.';
                    return;
                }
                updateProgressUI(d);
                setTimeout(pollStoredReport, 5000);
            };
            setTimeout(pollStoredReport, 5000);
            return true;
        }

        async function loadRecentReports() {
            const clientId = existingBrandSelect.value;
            const sel = document.getElementById('recentReportsSelect');
            const section = document.getElementById('recentReportsSection');
            if (!clientId) {
                section.style.display = 'none';
                return;
            }
            const res = await fetch(`${API_BASE_URL}/api/clients/${clientId}/creative-mri/reports?limit=20`, { headers: getAuthHeaders() });
            if (!res.ok) {
                section.style.display = 'none';
                return;
            }
            const data = await res.json();
            const items = data.items || [];
            sel.innerHTML = '<option value="">— No saved reports —</option>';
            items.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                let status = r.status === 'complete' ? 'complete' : r.status;
                if (r.status === 'running') {
                    const minutes = r.created_at ? Math.floor((Date.now() - new Date(r.created_at).getTime()) / 60000) : 0;
                    status = minutes >= 15 ? 'running (possibly stuck)' : 'running';
                }
                const date = r.created_at ? new Date(r.created_at).toLocaleString() : '';
                opt.textContent = `${status} · ${date}`;
                sel.appendChild(opt);
            });
            section.style.display = items.length ? 'block' : 'none';
        }

        async function loadHistoryReports() {
            const listEl = document.getElementById('historyReportsList');
            const emptyEl = document.getElementById('historyEmpty');
            emptyEl.textContent = 'Loading…';
            emptyEl.style.display = 'block';
            listEl.querySelectorAll('.mri-history-item').forEach(el => el.remove());
            try {
                const res = await fetch(`${API_BASE_URL}/api/creative-mri/reports?limit=50`, { headers: getAuthHeaders() });
                if (!res.ok) {
                    emptyEl.textContent = 'Failed to load reports.';
                    return;
                }
                const data = await res.json();
                const items = data.items || [];
                emptyEl.style.display = items.length ? 'none' : 'block';
                emptyEl.textContent = items.length ? '' : 'No previous reports yet. Run a report from New Brand or Existing Brand.';
                items.forEach(r => {
                    const row = document.createElement('button');
                    row.type = 'button';
                    row.className = 'mri-history-item';
                    const date = r.created_at ? new Date(r.created_at).toLocaleString() : '—';
                    const adInfo = r.ad_count != null ? ` · ${r.ad_count} ads` : '';
                    let statusLabel = r.status === 'complete' ? 'Complete' : r.status === 'failed' ? 'Failed' : r.status;
                    if (r.status === 'running') {
                        const minutes = r.created_at ? Math.floor((Date.now() - new Date(r.created_at).getTime()) / 60000) : 0;
                        statusLabel = minutes >= 15 ? 'Running (possibly stuck)' : 'Running';
                    }
                    row.innerHTML = `
                        <span class="mri-history-brand">${escapeHtml(r.client_name || '—')}</span>
                        <span class="mri-history-meta">${escapeHtml(date)}${escapeHtml(adInfo)} · ${escapeHtml(statusLabel)}</span>
                    `;
                    row.addEventListener('click', async () => {
                        closeSetupModal();
                        setUrlReportParams(r.client_id, r.id);
                        await loadStoredReportAndRender();
                    });
                    listEl.appendChild(row);
                });
            } catch (e) {
                emptyEl.textContent = 'Failed to load reports.';
                emptyEl.style.display = 'block';
            }
        }

        function showApp() {
            document.getElementById('appShell').style.display = 'flex';
            document.getElementById('founderEmail').textContent = window.Auth?.getStoredUserInfo?.()?.email || '';
            loadClients().then(async () => {
                const loaded = await loadStoredReportAndRender();
                if (!loaded) existingBrandImportSection.hidden = !existingBrandSelect.value;
            });
        }

        function init() {
            document.getElementById('logoutButton').addEventListener('click', () => {
                if (window.Auth?.handleLogout) window.Auth.handleLogout();
            });
            if (typeof window.Auth !== 'undefined' && typeof window.Auth.checkAuth === 'function') {
                window.Auth.checkAuth().then(showApp).catch(() => {});
            } else {
                showApp();
            }
        }
        init();
    </script>
</body>
</html>
