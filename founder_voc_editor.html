<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZHSFGWQMSN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZHSFGWQMSN');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founder Admin - VOC Process Editor</title>
    <script src="/config.js"></script>
    <script src="/auth.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', sans-serif;
            background: #fafafa;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* Login Screen */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }

        .login-container h2 {
            margin: 0 0 24px 0;
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }

        .login-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .login-container button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .login-container button:hover {
            opacity: 0.9;
        }

        .login-container button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-error {
            color: #e74c3c;
            margin-top: 8px;
            font-size: 14px;
            display: none;
        }

        /* Main Container */
        .container {
            width: 100%;
            min-height: 100vh;
            background: #fafafa;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .logout-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .content {
            flex: 1;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Filters */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .filter-group input,
        .filter-group select,
        .filter-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .filter-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #666;
            border-bottom: 2px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #333;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .id-cell {
            width: 80px;
            font-family: monospace;
            font-size: 12px;
        }

        .editable-cell {
            min-width: 200px;
        }

        .editable-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .editable-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .text-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f5f5f5;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-input {
            width: 60px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Status Messages */
        .status-message {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.show {
            display: block;
        }

        /* Bulk Edit Section */
        .bulk-edit-section {
            margin-bottom: 20px;
        }

        .bulk-edit-card {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
        }

        .bulk-edit-card h3 {
            margin: 0 0 10px 0;
            color: #856404;
            font-size: 18px;
        }

        .bulk-edit-info {
            color: #856404;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .bulk-edit-fields {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        /* Collapsible Sections */
        .collapsible-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 15px 20px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .collapsible-header:hover {
            background: #e9e9e9;
        }

        .collapsible-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .collapsible-toggle {
            font-size: 20px;
            color: #666;
            transition: transform 0.2s;
        }

        .collapsible-section.collapsed .collapsible-toggle {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            padding: 20px;
            display: block;
        }

        .collapsible-section.collapsed .collapsible-content {
            display: none;
        }

        /* Field Selector */
        .field-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .field-selector h4 {
            margin: 0 0 15px 0;
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .field-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .field-category {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .field-category h5 {
            margin: 0 0 8px 0;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }

        .field-checkbox {
            display: flex;
            align-items: center;
            padding: 4px 0;
            font-size: 13px;
        }

        .field-checkbox input[type="checkbox"] {
            margin-right: 6px;
        }

        .field-checkbox label {
            cursor: pointer;
            margin: 0;
        }

        /* Dynamic Field Inputs */
        .dynamic-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .dynamic-field {
            display: none;
        }

        .dynamic-field.visible {
            display: block;
        }

        .field-type-badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 3px;
            background: #e0e0e0;
            color: #555;
            margin-left: 5px;
        }

        .field-type-badge.string { background: #e3f2fd; color: #1976d2; }
        .field-type-badge.integer { background: #fff3e0; color: #f57c00; }
        .field-type-badge.datetime { background: #f3e5f5; color: #7b1fa2; }
        .field-type-badge.text { background: #e8f5e9; color: #388e3c; }
        .field-type-badge.json { background: #fce4ec; color: #c2185b; }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-container">
            <h2>Founder Login</h2>
            <input type="email" id="loginEmail" placeholder="Email" autocomplete="email">
            <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
            <button id="loginButton" onclick="handleLogin()">Login</button>
            <div id="loginError" class="login-error"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="container" style="display: none;">
        <div class="header">
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
            <h1>VOC Process Editor</h1>
            <p>Manage and bulk update Process VOC data.</p>
        </div>

        <div class="content">
            <!-- Status Messages -->
            <div id="statusMessage" class="status-message"></div>

            <!-- Filters Section (Collapsible) -->
            <div class="collapsible-section" id="filtersSection">
                <div class="collapsible-header" onclick="toggleSection('filtersSection')">
                    <h3>üîç Filters</h3>
                    <span class="collapsible-toggle">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="filters">
                        <div class="filter-group">
                            <label>Client Name</label>
                            <input type="text" id="filterClientName" placeholder="Search client_name (partial match)">
                        </div>
                        <div class="filter-group">
                            <label>Project ID</label>
                            <input type="text" id="filterProjectId" placeholder="Search project_id (partial match)">
                        </div>
                        <div class="filter-group">
                            <label>Project Name</label>
                            <input type="text" id="filterProjectName" placeholder="Search project_name (partial match)">
                        </div>
                        <div class="filter-group">
                            <label>Dimension Ref</label>
                            <input type="text" id="filterDimensionRef" placeholder="Search dimension_ref (partial match)">
                        </div>
                        <div class="filter-group">
                            <label>Dimension Name</label>
                            <input type="text" id="filterDimensionName" placeholder="Search dimension_name (partial match)">
                        </div>
                        <div class="filter-group">
                            <label>Data Source</label>
                            <input type="text" id="filterDataSource" placeholder="Search data_source (partial match)">
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Edit Section (Collapsible, shown when filters are active) -->
            <div id="bulkEditSection" class="collapsible-section" style="display: none;">
                <div class="collapsible-header" onclick="toggleSection('bulkEditSection')">
                    <h3>‚úèÔ∏è Bulk Edit All Filtered Rows</h3>
                    <span class="collapsible-toggle">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="bulk-edit-card">
                        <p class="bulk-edit-info" id="bulkEditInfo">
                            Update all rows matching current filters
                        </p>
                        
                        <!-- Field Selector -->
                        <div class="field-selector" id="fieldSelector">
                            <h4>Select Fields to Edit:</h4>
                            <div class="field-categories" id="fieldCategories">
                                <!-- Dynamically populated -->
                            </div>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-secondary" onclick="selectAllFields()" style="font-size: 12px; padding: 6px 12px;">Select All</button>
                                <button class="btn btn-secondary" onclick="deselectAllFields()" style="font-size: 12px; padding: 6px 12px;">Deselect All</button>
                            </div>
                        </div>

                        <!-- Dynamic Field Inputs -->
                        <div class="dynamic-fields" id="dynamicFields">
                            <!-- Dynamically populated based on selected fields -->
                        </div>

                        <!-- Action Buttons -->
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="applyBulkEdit()">
                                Update All Filtered Rows
                            </button>
                            <button class="btn btn-danger" onclick="deleteBulkRows()">
                                Delete All Filtered Rows
                            </button>
                            <button class="btn btn-secondary" onclick="clearBulkEdit()">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2>Process VOC Data</h2>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="saveBulkEdits()">Save Selected Changes</button>
                        <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                        <button class="btn btn-secondary" onclick="deselectAll()">Deselect None</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th class="checkbox-cell"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                                <th class="id-cell">ID</th>
                                <th class="editable-cell">Client Name</th>
                                <th>Project ID</th>
                                <th class="editable-cell">Project Name</th>
                                <th>Dimension Ref</th>
                                <th class="editable-cell">Data Source</th>
                                <th class="editable-cell">Dimension Name</th>
                                <th class="editable-cell">Question Text</th>
                                <th class="text-cell">Value</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="10" class="loading">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <div class="pagination-info" id="paginationInfo">
                    Showing 0 - 0 of 0 rows
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" onclick="goToFirstPage()">First</button>
                    <button class="pagination-btn" onclick="goToPrevPage()">Previous</button>
                    <span>Page</span>
                    <input type="number" id="pageInput" class="page-input" min="1" value="1" onchange="goToPage()">
                    <span id="totalPagesSpan">of 1</span>
                    <button class="pagination-btn" onclick="goToNextPage()">Next</button>
                    <button class="pagination-btn" onclick="goToLastPage()">Last</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = window.APP_CONFIG?.API_BASE_URL || 'http://localhost:8000';
        const AUTH_TOKEN_KEY = 'visualizd_auth_token';
        
        // State
        let currentPage = 1;
        let pageSize = 100;
        let totalPages = 1;
        let totalRows = 0;
        let currentFilters = {
            project_id: '',
            project_name: '',
            dimension_ref: '',
            dimension_name: '',
            client_name: '',
            data_source: ''
        };
        let editedRows = new Map(); // Track edited values: rowId -> {project_name, dimension_name}
        let fieldMetadata = []; // Store field metadata from API
        let selectedFields = new Set(); // Track which fields are selected for bulk edit

        // Authentication
        function getAuthToken() {
            return localStorage.getItem(AUTH_TOKEN_KEY);
        }

        function setAuthToken(token) {
            localStorage.setItem(AUTH_TOKEN_KEY, token);
        }

        function clearAuth() {
            localStorage.removeItem(AUTH_TOKEN_KEY);
        }

        function getAuthHeaders() {
            const token = getAuthToken();
            return token ? {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            } : {
                'Content-Type': 'application/json'
            };
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginButton = document.getElementById('loginButton');
            const loginError = document.getElementById('loginError');
            
            if (!email) {
                loginError.textContent = 'Please enter your email';
                loginError.style.display = 'block';
                return;
            }
            
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';
            loginError.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Login failed');
                }
                
                const data = await response.json();
                setAuthToken(data.access_token);
                
                // Verify user is founder
                const userResponse = await fetch(`${API_BASE_URL}/api/auth/me`, {
                    headers: getAuthHeaders()
                });
                
                if (userResponse.ok) {
                    const userInfo = await userResponse.json();
                    if (!userInfo.is_founder) {
                        throw new Error('Access denied: Founder privileges required');
                    }
                }
                
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainContainer').style.display = 'flex';
                await loadFieldMetadata();
                loadData();
                
            } catch (error) {
                loginError.textContent = error.message || 'Login failed. Please try again.';
                loginError.style.display = 'block';
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Login';
            }
        }

        async function checkAuth() {
            const token = getAuthToken();
            if (!token) {
                showLogin();
                return false;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/me`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Invalid token');
                }
                
                const userInfo = await response.json();
                if (!userInfo.is_founder) {
                    throw new Error('Access denied: Founder privileges required');
                }
                
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainContainer').style.display = 'flex';
                return true;
                
            } catch (error) {
                clearAuth();
                showLogin();
                return false;
            }
        }

        function showLogin() {
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('mainContainer').style.display = 'none';
        }

        function handleLogout() {
            clearAuth();
            window.location.href = 'https://marketably.ai';
        }

        // Data Loading
        async function loadData() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '<tr><td colspan="10" class="loading">Loading data...</td></tr>';
            
            try {
                const params = new URLSearchParams();
                if (currentFilters.project_id) {
                    params.append('filter_project_id', currentFilters.project_id);
                }
                if (currentFilters.project_name) {
                    params.append('filter_project_name', currentFilters.project_name);
                }
                if (currentFilters.dimension_ref) {
                    params.append('filter_dimension_ref', currentFilters.dimension_ref);
                }
                if (currentFilters.dimension_name) {
                    params.append('filter_dimension_name', currentFilters.dimension_name);
                }
                if (currentFilters.client_name) {
                    params.append('filter_client_name', currentFilters.client_name);
                }
                if (currentFilters.data_source) {
                    params.append('filter_data_source', currentFilters.data_source);
                }
                params.append('page', currentPage.toString());
                params.append('page_size', pageSize.toString());
                
                const response = await fetch(`${API_BASE_URL}/api/founder-admin/voc-data?${params.toString()}`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        handleLogout();
                        return;
                    }
                    throw new Error(`Failed to load data: ${response.status}`);
                }
                
                const data = await response.json();
                
                totalRows = data.total;
                totalPages = data.total_pages;
                currentPage = data.page;
                
                renderTable(data.items);
                updatePagination();
                updateBulkEditSection();
                
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="10" style="color: #e74c3c;">Error: ${error.message}</td></tr>`;
                showStatus('Error loading data: ' + error.message, 'error');
            }
        }

        function renderTable(items) {
            const tbody = document.getElementById('tableBody');
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="loading">No data found</td></tr>';
                return;
            }
            
            tbody.innerHTML = items.map(row => {
                const edited = editedRows.get(row.id) || {};
                const projectName = edited.project_name !== undefined ? edited.project_name : (row.project_name || '');
                const dimensionName = edited.dimension_name !== undefined ? edited.dimension_name : (row.dimension_name || '');
                const dataSource = edited.data_source !== undefined ? edited.data_source : (row.data_source || '');
                const clientName = edited.client_name !== undefined ? edited.client_name : (row.client_name || '');
                const questionText = edited.question_text !== undefined ? edited.question_text : (row.question_text || '');
                
                return `
                    <tr data-row-id="${row.id}">
                        <td class="checkbox-cell">
                            <input type="checkbox" class="row-checkbox" data-row-id="${row.id}" 
                                   ${editedRows.has(row.id) ? 'checked' : ''}>
                        </td>
                        <td class="id-cell">${row.id}</td>
                        <td class="editable-cell">
                            <input type="text" 
                                   class="editable-input client-name-input" 
                                   data-row-id="${row.id}"
                                   value="${escapeHtml(clientName)}"
                                   onchange="markRowEdited(${row.id}, 'client_name', this.value)">
                        </td>
                        <td>${row.project_id || ''}</td>
                        <td class="editable-cell">
                            <input type="text" 
                                   class="editable-input project-name-input" 
                                   data-row-id="${row.id}"
                                   value="${escapeHtml(projectName)}"
                                   onchange="markRowEdited(${row.id}, 'project_name', this.value)">
                        </td>
                        <td>${escapeHtml(row.dimension_ref || '')}</td>
                        <td class="editable-cell">
                            <input type="text" 
                                   class="editable-input data-source-input" 
                                   data-row-id="${row.id}"
                                   value="${escapeHtml(dataSource)}"
                                   onchange="markRowEdited(${row.id}, 'data_source', this.value)">
                        </td>
                        <td class="editable-cell">
                            <input type="text" 
                                   class="editable-input dimension-name-input" 
                                   data-row-id="${row.id}"
                                   value="${escapeHtml(dimensionName)}"
                                   onchange="markRowEdited(${row.id}, 'dimension_name', this.value)">
                        </td>
                        <td class="editable-cell">
                            <input type="text" 
                                   class="editable-input question-text-input" 
                                   data-row-id="${row.id}"
                                   value="${escapeHtml(questionText)}"
                                   onchange="markRowEdited(${row.id}, 'question_text', this.value)">
                        </td>
                        <td class="text-cell" title="${escapeHtml(row.value || '')}">${escapeHtml((row.value || '').substring(0, 50))}</td>
                    </tr>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function markRowEdited(rowId, field, value) {
            if (!editedRows.has(rowId)) {
                editedRows.set(rowId, {});
            }
            const edited = editedRows.get(rowId);
            edited[field] = value;
            
            // Check checkbox
            const checkbox = document.querySelector(`.row-checkbox[data-row-id="${rowId}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        }

        // Filters
        function applyFilters() {
            currentFilters.project_id = document.getElementById('filterProjectId').value.trim();
            currentFilters.project_name = document.getElementById('filterProjectName').value.trim();
            currentFilters.dimension_ref = document.getElementById('filterDimensionRef').value.trim();
            currentFilters.dimension_name = document.getElementById('filterDimensionName').value.trim();
            currentFilters.client_name = document.getElementById('filterClientName').value.trim();
            currentFilters.data_source = document.getElementById('filterDataSource').value.trim();
            currentPage = 1;
            editedRows.clear();
            loadData();
        }

        function clearFilters() {
            document.getElementById('filterProjectId').value = '';
            document.getElementById('filterProjectName').value = '';
            document.getElementById('filterDimensionRef').value = '';
            document.getElementById('filterDimensionName').value = '';
            document.getElementById('filterClientName').value = '';
            document.getElementById('filterDataSource').value = '';
            currentFilters.project_id = '';
            currentFilters.project_name = '';
            currentFilters.dimension_ref = '';
            currentFilters.dimension_name = '';
            currentFilters.client_name = '';
            currentFilters.data_source = '';
            currentPage = 1;
            editedRows.clear();
            clearBulkEdit();
            loadData();
        }

        // Selection
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
        }

        function selectAll() {
            document.getElementById('selectAllCheckbox').checked = true;
            toggleSelectAll();
        }

        function deselectAll() {
            document.getElementById('selectAllCheckbox').checked = false;
            toggleSelectAll();
        }

        // Bulk Save
        async function saveBulkEdits() {
            if (editedRows.size === 0) {
                showStatus('No changes to save', 'error');
                return;
            }

            const checkedBoxes = Array.from(document.querySelectorAll('.row-checkbox:checked'));
            if (checkedBoxes.length === 0) {
                showStatus('Please select at least one row to save', 'error');
                return;
            }

            const updates = [];
            checkedBoxes.forEach(checkbox => {
                const rowId = parseInt(checkbox.getAttribute('data-row-id'));
                const edited = editedRows.get(rowId);
                if (edited) {
                    updates.push({
                        id: rowId,
                        project_name: edited.project_name !== undefined ? edited.project_name : null,
                        dimension_name: edited.dimension_name !== undefined ? edited.dimension_name : null,
                        data_source: edited.data_source !== undefined ? edited.data_source : null,
                        client_name: edited.client_name !== undefined ? edited.client_name : null,
                        question_text: edited.question_text !== undefined ? edited.question_text : null
                    });
                }
            });

            if (updates.length === 0) {
                showStatus('No valid changes to save', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/founder-admin/voc-data/bulk-update`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ updates })
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        handleLogout();
                        return;
                    }
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save changes');
                }

                const result = await response.json();
                showStatus(`Successfully updated ${result.updated_count} row(s)`, 'success');
                
                // Clear edited rows and reload
                editedRows.clear();
                loadData();

            } catch (error) {
                showStatus('Error saving changes: ' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type} show`;
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 5000);
        }

        // Pagination
        function updatePagination() {
            const start = totalRows === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalRows);
            document.getElementById('paginationInfo').textContent = 
                `Showing ${start} - ${end} of ${totalRows} rows`;
            
            document.getElementById('totalPagesSpan').textContent = `of ${totalPages}`;
            document.getElementById('pageInput').value = currentPage;
        }

        function goToPage() {
            const page = parseInt(document.getElementById('pageInput').value);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadData();
            }
        }

        function goToFirstPage() {
            currentPage = 1;
            loadData();
        }

        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadData();
            }
        }

        function goToNextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadData();
            }
        }

        function goToLastPage() {
            currentPage = totalPages;
            loadData();
        }

        // Bulk Edit Functions
        function updateBulkEditSection() {
            const hasFilters = currentFilters.project_id || currentFilters.project_name || currentFilters.dimension_ref || currentFilters.dimension_name || currentFilters.client_name || currentFilters.data_source;
            const bulkSection = document.getElementById('bulkEditSection');
            const bulkInfo = document.getElementById('bulkEditInfo');
            
            if (hasFilters) {
                bulkSection.style.display = 'block';
                const filterText = [];
                if (currentFilters.project_id) {
                    filterText.push(`Project ID: ${currentFilters.project_id}`);
                }
                if (currentFilters.project_name) {
                    filterText.push(`Project Name: ${currentFilters.project_name}`);
                }
                if (currentFilters.dimension_ref) {
                    filterText.push(`Dimension Ref: ${currentFilters.dimension_ref}`);
                }
                if (currentFilters.dimension_name) {
                    filterText.push(`Dimension Name: ${currentFilters.dimension_name}`);
                }
                if (currentFilters.client_name) {
                    filterText.push(`Client Name: ${currentFilters.client_name}`);
                }
                if (currentFilters.data_source) {
                    filterText.push(`Data Source: ${currentFilters.data_source}`);
                }
                bulkInfo.textContent = `Will update all rows matching: ${filterText.join(', ')} (${totalRows} rows)`;
            } else {
                bulkSection.style.display = 'none';
            }
        }

        async function applyBulkEdit() {
            if (!currentFilters.project_id && !currentFilters.project_name && !currentFilters.dimension_ref && !currentFilters.dimension_name && !currentFilters.client_name && !currentFilters.data_source) {
                showStatus('Please apply filters before bulk editing', 'error');
                return;
            }
            
            // Collect updates from all selected fields
            const updates = {};
            let hasUpdates = false;
            
            selectedFields.forEach(fieldName => {
                const input = document.getElementById(`bulk_${fieldName}`);
                if (input) {
                    let value = input.value.trim();
                    if (value) {
                        // Handle datetime-local inputs - convert to ISO format
                        const fieldMeta = fieldMetadata.find(f => f.name === fieldName);
                        if (fieldMeta && fieldMeta.type === 'datetime' && input.type === 'datetime-local') {
                            // datetime-local format is "YYYY-MM-DDTHH:mm" - convert to ISO format
                            // Add seconds if not present
                            if (value && value.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/)) {
                                value = value + ':00';
                            }
                            // Convert to ISO format with timezone (backend expects ISO format)
                            // datetime.fromisoformat can handle "YYYY-MM-DDTHH:mm:ss" format
                        }
                        updates[fieldName] = value;
                        hasUpdates = true;
                    }
                }
            });
            
            if (!hasUpdates) {
                showStatus('Please provide at least one value to update', 'error');
                return;
            }
            
            if (!confirm(`This will update ${totalRows} row(s). Are you sure?`)) {
                return;
            }
            
            try {
                const params = new URLSearchParams();
                if (currentFilters.project_id) {
                    params.append('filter_project_id', currentFilters.project_id);
                }
                if (currentFilters.project_name) {
                    params.append('filter_project_name', currentFilters.project_name);
                }
                if (currentFilters.dimension_ref) {
                    params.append('filter_dimension_ref', currentFilters.dimension_ref);
                }
                if (currentFilters.dimension_name) {
                    params.append('filter_dimension_name', currentFilters.dimension_name);
                }
                if (currentFilters.client_name) {
                    params.append('filter_client_name', currentFilters.client_name);
                }
                if (currentFilters.data_source) {
                    params.append('filter_data_source', currentFilters.data_source);
                }
                
                const response = await fetch(`${API_BASE_URL}/api/founder-admin/voc-data/bulk-update-filtered?${params.toString()}`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ updates })
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        handleLogout();
                        return;
                    }
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update rows');
                }
                
                const result = await response.json();
                showStatus(`Successfully updated ${result.updated_count} row(s)`, 'success');
                
                // Clear bulk edit fields and reload data
                clearBulkEdit();
                loadData();
                
            } catch (error) {
                showStatus('Error updating rows: ' + error.message, 'error');
            }
        }

        function clearBulkEdit() {
            // Clear all dynamic field inputs
            selectedFields.forEach(fieldName => {
                const input = document.getElementById(`bulk_${fieldName}`);
                if (input) input.value = '';
            });
            // Deselect all fields
            deselectAllFields();
        }

        async function deleteBulkRows() {
            if (!currentFilters.project_id && !currentFilters.project_name && !currentFilters.dimension_ref && !currentFilters.dimension_name && !currentFilters.client_name && !currentFilters.data_source) {
                showStatus('Please apply filters before deleting rows', 'error');
                return;
            }
            
            // Double confirmation for deletion
            const confirmMessage = `‚ö†Ô∏è WARNING: This will permanently delete ${totalRows} row(s). This action cannot be undone!\n\nAre you absolutely sure you want to proceed?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Second confirmation
            const secondConfirm = prompt(`Type "DELETE" to confirm deletion of ${totalRows} row(s):`);
            if (secondConfirm !== 'DELETE') {
                showStatus('Deletion cancelled', 'error');
                return;
            }
            
            try {
                const params = new URLSearchParams();
                if (currentFilters.project_id) {
                    params.append('filter_project_id', currentFilters.project_id);
                }
                if (currentFilters.project_name) {
                    params.append('filter_project_name', currentFilters.project_name);
                }
                if (currentFilters.dimension_ref) {
                    params.append('filter_dimension_ref', currentFilters.dimension_ref);
                }
                if (currentFilters.dimension_name) {
                    params.append('filter_dimension_name', currentFilters.dimension_name);
                }
                if (currentFilters.client_name) {
                    params.append('filter_client_name', currentFilters.client_name);
                }
                if (currentFilters.data_source) {
                    params.append('filter_data_source', currentFilters.data_source);
                }
                
                const response = await fetch(`${API_BASE_URL}/api/founder-admin/voc-data/bulk-delete?${params.toString()}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        handleLogout();
                        return;
                    }
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete rows');
                }
                
                const result = await response.json();
                showStatus(`Successfully deleted ${result.updated_count} row(s)`, 'success');
                
                // Reload data to show updated results
                loadData();
                
            } catch (error) {
                showStatus('Error deleting rows: ' + error.message, 'error');
            }
        }

        // Enter key handlers
        document.addEventListener('DOMContentLoaded', () => {
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            
            if (emailInput) {
                emailInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
            }
        });

        // Collapsible Section Toggle
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }

        // Load Field Metadata
        async function loadFieldMetadata() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/founder-admin/field-metadata`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load field metadata');
                }
                
                const data = await response.json();
                fieldMetadata = data.fields;
                renderFieldSelector();
                
            } catch (error) {
                console.error('Error loading field metadata:', error);
            }
        }

        // Render Field Selector
        function renderFieldSelector() {
            const container = document.getElementById('fieldCategories');
            const categories = {};
            
            // Group fields by category
            fieldMetadata.forEach(field => {
                if (!categories[field.category]) {
                    categories[field.category] = [];
                }
                categories[field.category].push(field);
            });
            
            // Render categories
            container.innerHTML = Object.entries(categories).map(([category, fields]) => `
                <div class="field-category">
                    <h5>${category}</h5>
                    ${fields.map(field => `
                        <div class="field-checkbox">
                            <input type="checkbox" 
                                   id="field_${field.name}" 
                                   value="${field.name}"
                                   onchange="toggleFieldInput('${field.name}', this.checked)">
                            <label for="field_${field.name}">
                                ${field.name}
                                <span class="field-type-badge ${field.type}">${field.type}</span>
                            </label>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // Toggle Field Input Visibility
        function toggleFieldInput(fieldName, show) {
            if (show) {
                selectedFields.add(fieldName);
                showFieldInput(fieldName);
            } else {
                selectedFields.delete(fieldName);
                hideFieldInput(fieldName);
            }
        }

        // Show Field Input
        function showFieldInput(fieldName) {
            const fieldMeta = fieldMetadata.find(f => f.name === fieldName);
            if (!fieldMeta) return;
            
            const container = document.getElementById('dynamicFields');
            const existing = document.getElementById(`dynamic_field_${fieldName}`);
            if (existing) {
                existing.classList.add('visible');
                return;
            }
            
            let inputHtml = '';
            const placeholder = fieldMeta.nullable ? 'Leave empty to keep existing' : 'Required';
            
            if (fieldMeta.type === 'integer') {
                inputHtml = `<input type="number" id="bulk_${fieldName}" placeholder="${placeholder}">`;
            } else if (fieldMeta.type === 'datetime') {
                // datetime-local format: YYYY-MM-DDTHH:mm
                inputHtml = `<input type="datetime-local" id="bulk_${fieldName}" placeholder="${placeholder}" step="1">`;
            } else if (fieldMeta.type === 'text') {
                inputHtml = `<textarea id="bulk_${fieldName}" rows="2" placeholder="${placeholder}"></textarea>`;
            } else if (fieldMeta.type === 'json') {
                inputHtml = `<textarea id="bulk_${fieldName}" rows="3" placeholder='${placeholder} (JSON format)'></textarea>`;
            } else {
                inputHtml = `<input type="text" id="bulk_${fieldName}" placeholder="${placeholder}">`;
            }
            
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'filter-group dynamic-field visible';
            fieldDiv.id = `dynamic_field_${fieldName}`;
            fieldDiv.innerHTML = `
                <label>
                    ${fieldName}
                    <span class="field-type-badge ${fieldMeta.type}">${fieldMeta.type}</span>
                </label>
                ${inputHtml}
            `;
            
            container.appendChild(fieldDiv);
        }

        // Hide Field Input
        function hideFieldInput(fieldName) {
            const fieldDiv = document.getElementById(`dynamic_field_${fieldName}`);
            if (fieldDiv) {
                fieldDiv.classList.remove('visible');
                // Clear the input value
                const input = document.getElementById(`bulk_${fieldName}`);
                if (input) input.value = '';
            }
        }

        // Select/Deselect All Fields
        function selectAllFields() {
            fieldMetadata.forEach(field => {
                const checkbox = document.getElementById(`field_${field.name}`);
                if (checkbox) {
                    checkbox.checked = true;
                    toggleFieldInput(field.name, true);
                }
            });
        }

        function deselectAllFields() {
            fieldMetadata.forEach(field => {
                const checkbox = document.getElementById(`field_${field.name}`);
                if (checkbox) {
                    checkbox.checked = false;
                    toggleFieldInput(field.name, false);
                }
            });
        }

        // Initialize
        const token = getAuthToken();
        if (!token) {
            showLogin();
        } else {
            checkAuth().then(authenticated => {
                if (authenticated) {
                    loadFieldMetadata();
                    loadData();
                }
            });
        }
    </script>
</body>
</html>

