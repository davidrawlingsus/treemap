<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZHSFGWQMSN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZHSFGWQMSN');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founder Admin - Prompt Engineering</title>
    <script src="/config.js"></script>
    <style>
        :root {
            --bg: #f5f7fb;
            --surface: #ffffff;
            --border: #e2e8f0;
            --border-strong: #cbd5f5;
            --primary: #667eea;
            --primary-dark: #4c51bf;
            --danger: #e53e3e;
            --success: #38a169;
            --text: #1a202c;
            --muted: #718096;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Inter", "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        body.slideout-open {
            overflow: hidden;
        }

        .login-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.85);
            z-index: 999;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-card {
            background: var(--surface);
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(56, 66, 106, 0.35);
            width: min(380px, 92vw);
        }

        .login-card h2 {
            margin-bottom: 12px;
        }

        .login-card p {
            margin-bottom: 16px;
            color: var(--muted);
            font-size: 14px;
            line-height: 1.5;
        }

        .login-card input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 12px;
            transition: border 0.2s;
        }

        .login-card input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.15s, box-shadow 0.2s, background 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: #edf2f7;
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-ghost {
            background: transparent;
            color: var(--primary);
        }

        .btn-ghost:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #appShell {
            display: none;
            min-height: 100vh;
            flex-direction: column;
        }

        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        header h1 {
            font-size: 26px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 14px;
            color: var(--muted);
            margin-top: 6px;
            max-width: 640px;
        }

        .founder-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        #founderEmail {
            font-size: 12px;
            color: var(--muted);
        }

        main {
            flex: 1;
            padding: 32px;
            display: flex;
            justify-content: center;
        }

        .content {
            width: min(1100px, 100%);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .toolbar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
        }

        .status-message {
            padding: 14px 18px;
            border-radius: 10px;
            font-size: 14px;
            display: none;
        }

        .status-message.success {
            background: #f0fff4;
            border: 1px solid #c6f6d5;
            color: var(--success);
        }

        .status-message.error {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: var(--danger);
        }

        .domains-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .domain-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 20px 45px -24px rgba(15, 23, 42, 0.35);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .domain-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .domain-header h2 {
            font-size: 18px;
            font-weight: 600;
            word-break: break-word;
        }

        .domain-meta {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .description {
            font-size: 14px;
            color: var(--muted);
        }

        .client-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .client-chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: rgba(102, 126, 234, 0.12);
            font-size: 12px;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            color: var(--muted);
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 48px 24px;
            background: rgba(255, 255, 255, 0.7);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 40px 24px;
        }

        .modal-backdrop.visible {
            display: flex;
        }

        /* When slideout is open, adjust modal backdrop to only cover left side and center modal */
        body.slideout-open .modal-backdrop {
            right: 500px; /* Leave space for slideout panel */
            justify-content: center;
        }

        .modal {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 30px 60px -24px rgba(15, 23, 42, 0.45);
            border: 1px solid var(--border-strong);
            width: min(800px, calc(100vw - 500px - 80px)); /* Full width minus slideout and padding */
            max-width: 800px;
            max-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }

        .modal header {
            position: static;
            border-bottom: 1px solid var(--border);
            padding: 24px 32px;
            background: #f7f9ff;
            border-radius: 16px 16px 0 0;
        }

        .modal header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .modal form {
            padding: 32px 32px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--muted);
            margin-bottom: 2px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 200px;
            line-height: 1.6;
        }

        .client-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            max-height: 220px;
            overflow-y: auto;
            padding: 6px 2px;
        }

        .client-option {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 13px;
            padding: 6px 8px;
            border: 1px solid transparent;
            border-radius: 8px;
        }

        .client-option:hover {
            border-color: rgba(102, 126, 234, 0.3);
            background: rgba(102, 126, 234, 0.08);
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 20px 32px;
            border-top: 1px solid var(--border);
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
        }

        .split-button-container {
            display: flex;
            gap: 0;
            position: relative;
        }

        .split-button-main {
            border-radius: 8px 0 0 8px;
            border-right: none;
        }

        .split-button-dropdown {
            border-radius: 0 8px 8px 0;
            padding: 10px 12px;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
        }

        .split-button-dropdown-menu {
            display: none;
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 8px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 160px;
            z-index: 1001;
            overflow: hidden;
        }

        .split-button-dropdown-menu.visible {
            display: block;
        }

        .split-button-dropdown-menu-item {
            display: block;
            width: 100%;
            padding: 10px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .split-button-dropdown-menu-item:hover {
            background: var(--bg);
        }

        .version-selector {
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .version-selector:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Slideout Panel Styles */
        .ai-insights-panel {
            position: fixed;
            right: -520px;
            top: 0;
            width: 500px;
            height: 100vh;
            background: oklch(1 0 0);
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 10001;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            border-top: 3px solid #B9F040;
        }

        .ai-insights-panel.open {
            right: 0;
        }

        .ai-insights-header {
            padding: 1.25rem 1.5rem 1rem 1.5rem;
            border-bottom: 1px solid oklch(0.922 0 0);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: oklch(1 0 0);
            gap: 12px;
        }

        .ai-insights-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            padding-bottom: 0;
            transition: opacity 0.2s ease;
        }

        .ai-insights-chat {
            border-top: 1px solid oklch(0.922 0 0);
            padding: 16px;
            background: oklch(0.98 0 0);
            display: none; /* Hidden by default */
        }

        /* Only show chat input in prompt engineering context */
        .ai-insights-panel.prompt-engineering-context .ai-insights-chat {
            display: block;
        }

        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid oklch(0.85 0 0);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            line-height: 1.5;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .chat-send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            min-width: 44px;
            height: 44px;
        }

        .chat-send-btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-send-btn svg {
            display: block;
        }

        .ai-close-btn {
            background: none;
            border: none;
            color: oklch(0.556 0 0);
            font-size: 1.75rem;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            font-family: 'Lato', sans-serif;
        }

        .ai-close-btn:hover {
            background: oklch(0.97 0 0);
            color: oklch(0.145 0 0);
        }

        .filter-menu {
            position: relative;
        }

        .filter-button {
            position: relative;
            width: 44px;
            height: 44px;
            padding: 0;
            background: oklch(1 0 0);
            border: 1px solid oklch(0.85 0 0);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .filter-button:hover {
            background: oklch(0.98 0 0);
            border-color: oklch(0.75 0 0);
        }

        .filter-button:focus,
        .filter-button:focus-visible {
            outline: 2px solid oklch(0.6 0.2 250);
            outline-offset: 2px;
        }

        .filter-button img {
            width: 20px;
            height: 20px;
            display: block;
        }

        .filter-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: oklch(0.5 0.2 20);
            color: white;
            border-radius: 10px;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            padding: 0 4px;
            display: none; /* Hidden by default, shown when filters are active */
        }

        .filter-badge.active {
            display: flex;
        }

        .filter-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 350px;
            max-width: 450px;
            z-index: 1000;
            max-height: 500px;
            overflow-y: auto;
        }

        .filter-section {
            margin-bottom: 16px;
        }

        .filter-section:last-child {
            margin-bottom: 0;
        }

        .filter-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .filter-checkbox-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .filter-checkbox-item label {
            cursor: pointer;
            user-select: none;
        }

        .ai-insights-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 500px; /* Only cover the slideout panel width */
            background: rgba(15, 23, 42, 0.6); /* Match modal backdrop color */
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .ai-insights-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        /* When modal is also open, hide slideout overlay to avoid double overlay */
        .modal-backdrop.visible ~ .ai-insights-overlay.visible {
            opacity: 0;
            pointer-events: none;
        }

        .prompt-result-content {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-x: auto;
        }

        .prompt-output-item {
            margin-bottom: 24px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            background: var(--surface);
        }

        .prompt-output-item-new {
            border-color: #B9F040;
            border-width: 2px;
        }

        .prompt-output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
        }

        .prompt-output-meta {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
            font-size: 13px;
        }

        .prompt-output-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-copy-output,
        .btn-delete-output {
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            transition: all 0.2s;
        }

        .btn-copy-output:hover {
            background: #f0f4f8;
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-delete-output:hover {
            background: #fff5f5;
            border-color: var(--danger);
            color: var(--danger);
        }

        .btn-copy-output img,
        .btn-delete-output img {
            display: block;
        }

        .prompt-result-metadata {
            margin-bottom: 16px;
            padding: 12px;
            background: #f0f4f8;
            border-radius: 6px;
            font-size: 13px;
            color: var(--muted);
        }

        .ai-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .ai-loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e4e6eb;
            border-top-color: #b9f040;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .founder-meta {
                align-items: flex-start;
            }

            main {
                padding: 24px;
            }

            .domains-grid {
                grid-template-columns: 1fr;
            }

            .ai-insights-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <h2>Founder Login</h2>
            <p>Use your founder email to manage prompts and version control.</p>
            <div id="loginError" class="status-message error" style="display: none;"></div>
            <input type="email" id="loginEmail" placeholder="founder@example.com" autocomplete="email">
            <input type="password" id="loginPassword" placeholder="Password (if configured)" autocomplete="current-password">
            <button class="btn btn-primary" id="loginButton">Login</button>
        </div>
    </div>

    <div id="appShell">
        <header>
            <div>
                <h1>Prompt Engineering</h1>
                <div class="subtitle">
                    Manage system prompts for transforming insights into actions with version control.
                </div>
            </div>
            <div class="founder-meta">
                <span id="founderEmail"></span>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" id="refreshButton">Refresh</button>
                    <button class="btn btn-ghost" id="logoutButton">Logout</button>
                </div>
            </div>
        </header>
        <main>
            <div class="content">
                <div class="toolbar">
                    <div>
                        <h2 style="font-size: 18px; font-weight: 600;">Prompts</h2>
                        <p style="font-size: 14px; color: var(--muted); margin-top: 6px;">
                            Create and manage system prompts with version control for transforming insights into actions.
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="statusFilter" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                            <option value="">All Statuses</option>
                            <option value="live">Live</option>
                            <option value="test">Test</option>
                            <option value="archived">Archived</option>
                        </select>
                        <select id="purposeFilter" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                            <option value="">All Purposes</option>
                            <option value="summarize">Summarize</option>
                            <option value="headlines">Headlines</option>
                            <option value="ux-fixes">UX Fixes</option>
                            <option value="risk-reversal">Risk Reversal</option>
                            <option value="microcopy">Microcopy</option>
                        </select>
                        <button class="btn btn-primary" id="newPromptButton">New Prompt</button>
                    </div>
                </div>
                <div id="statusMessage" class="status-message"></div>
                <div id="promptsContainer" class="domains-grid"></div>
            </div>
        </main>
    </div>

    <div id="modalBackdrop" class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <header>
                <h2 id="modalTitle">New Prompt</h2>
            </header>
            <form id="promptForm" style="max-height: calc(92vh - 180px); overflow-y: auto;">
                <div class="form-group">
                    <label for="nameInput">Name</label>
                    <input type="text" id="nameInput" placeholder="e.g., summarize-data, generate-headlines" required>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Human-readable identifier for the prompt</p>
                </div>
                <div class="form-group">
                    <label for="versionInput">Version</label>
                    <input type="number" id="versionInput" placeholder="1" min="1" required>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Version number for this prompt</p>
                </div>
                <div class="form-group">
                    <label for="promptPurposeInput">Purpose</label>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <select id="promptPurposeInput" required style="flex: 1;">
                            <option value="">Select purpose...</option>
                            <option value="summarize">Summarize</option>
                            <option value="headlines">Headlines</option>
                            <option value="ux-fixes">UX Fixes</option>
                            <option value="risk-reversal">Risk Reversal</option>
                            <option value="microcopy">Microcopy</option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="addPurposeButton" style="padding: 12px 16px; white-space: nowrap;" title="Add new purpose">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="statusInput">Status</label>
                    <select id="statusInput" required>
                        <option value="test">Test</option>
                        <option value="live">Live</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="llmModelInput">LLM Model</label>
                    <input type="text" id="llmModelInput" placeholder="gpt-4o-mini" value="gpt-4o-mini" required>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Model identifier (e.g., gpt-4o-mini, gpt-4)</p>
                </div>
                <div class="form-group">
                    <label for="systemMessageInput">System Message</label>
                    <textarea id="systemMessageInput" placeholder="Enter the system prompt text here..." style="min-height: 300px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.6;" required></textarea>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">The system message that will be sent to the LLM</p>
                </div>
                <div class="form-group">
                    <label for="userMessageInput">Prompt Messages</label>
                    <textarea id="userMessageInput" placeholder="Enter user message (e.g., URL, verbatim JSON, etc.)" style="min-height: 200px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.6;"></textarea>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">The user input that will be sent with the system message to the LLM</p>
                </div>
            </form>
            <div id="addPurposeModal" class="modal-backdrop" style="display: none;">
                <div class="modal" style="width: min(450px, 90vw);">
                    <header>
                        <h2>Add New Purpose</h2>
                    </header>
                    <form id="addPurposeForm" style="padding: 32px;">
                        <div class="form-group">
                            <label for="newPurposeInput">Purpose Name</label>
                            <input type="text" id="newPurposeInput" placeholder="e.g., email-copy, social-media" required style="text-transform: lowercase;">
                            <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Use lowercase with hyphens (e.g., email-copy)</p>
                        </div>
                    </form>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancelAddPurposeButton" type="button">Cancel</button>
                        <button class="btn btn-primary" id="savePurposeButton" type="button">Add Purpose</button>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="newVersionButton" type="button" style="display: none;">New Version</button>
                    <button class="btn btn-secondary" id="cancelModalButton" type="button">Cancel</button>
                </div>
                <div class="split-button-container">
                    <button class="btn btn-primary split-button-main" id="saveAndRunButton" type="button">Save and Run</button>
                    <button class="btn btn-primary split-button-dropdown" id="saveButtonDropdown" type="button" aria-label="More options">▼</button>
                    <div class="split-button-dropdown-menu" id="saveButtonMenu">
                        <button class="split-button-dropdown-menu-item" id="saveChangesButton" type="button">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Slideout Panel for Prompt Results -->
    <div id="slideoutPanel" class="ai-insights-panel">
        <div class="ai-insights-header">
            <div style="flex: 1;">
                <div id="slideoutTitle" style="font-size: 1.5rem; font-weight: 600; font-family: 'Lato', sans-serif; color: oklch(0.145 0 0);">LLM Outputs</div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="filter-menu" style="position: relative;">
                    <button id="promptFiltersBtn" class="filter-button" type="button" aria-label="Open filters" style="display: none;">
                        <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/filter_list.svg" alt="" aria-hidden="true">
                        <span id="promptFilterBadge" class="filter-badge" aria-hidden="true"></span>
                    </button>
                    <div id="promptFiltersDropdown" class="filter-dropdown" style="display: none;">
                        <div style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;">
                            <strong style="font-size: 14px;">Filter LLM Outputs</strong>
                            <button id="clearAllPromptFilters" style="padding: 4px 8px; background: transparent; border: none; color: #667eea; cursor: pointer; font-size: 12px; font-weight: 500;">Clear All</button>
                        </div>
                        <div style="padding: 16px;">
                            <div class="filter-section">
                                <label style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 8px; display: block;">Filter by Prompt</label>
                                <div id="promptNameFilters" class="filter-checkboxes"></div>
                            </div>
                            <div class="filter-section" style="margin-top: 16px;">
                                <label style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 8px; display: block;">Filter by Version</label>
                                <div id="promptVersionFilters" class="filter-checkboxes"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="closeSlideoutPanel" class="ai-close-btn">&times;</button>
            </div>
        </div>
        <div id="slideoutContent" class="ai-insights-content">
            <!-- Content loaded dynamically -->
        </div>
        <div class="ai-insights-chat">
            <div class="chat-input-container">
                <textarea id="slideoutChatInput" class="chat-input" placeholder="Enter prompt message (e.g., URL, verbatim JSON, etc.)..." rows="2"></textarea>
                <button id="slideoutChatSend" class="chat-send-btn" title="Send">
                    <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/send_icon.png" alt="Send" width="20" height="20" id="slideoutChatSendIcon">
                </button>
            </div>
        </div>
    </div>
    
    <div id="slideoutOverlay" class="ai-insights-overlay"></div>

    <script>
        const API_BASE_URL = window.APP_CONFIG?.API_BASE_URL || 'http://localhost:8000';
        const AUTH_TOKEN_KEY = 'visualizd_auth_token';

        // Initialize elements with debugging
        function getElement(id, required = true) {
            const el = document.getElementById(id);
            if (required && !el) {
                console.error(`[DEBUG] Required element not found: #${id}`);
            } else if (!el) {
                console.warn(`[DEBUG] Optional element not found: #${id}`);
            } else {
                console.log(`[DEBUG] Element found: #${id}`);
            }
            return el;
        }

        const elements = {
            loginOverlay: getElement('loginOverlay'),
            loginEmail: getElement('loginEmail'),
            loginPassword: getElement('loginPassword'),
            loginButton: getElement('loginButton'),
            loginError: getElement('loginError'),
            appShell: getElement('appShell'),
            founderEmail: getElement('founderEmail'),
            logoutButton: getElement('logoutButton'),
            refreshButton: getElement('refreshButton'),
            newPromptButton: getElement('newPromptButton'),
            statusMessage: getElement('statusMessage'),
            promptsContainer: getElement('promptsContainer'),
            statusFilter: getElement('statusFilter'),
            purposeFilter: getElement('purposeFilter'),
            modalBackdrop: getElement('modalBackdrop'),
            modalTitle: getElement('modalTitle'),
            promptForm: getElement('promptForm'),
            nameInput: getElement('nameInput'),
            versionInput: getElement('versionInput'),
            promptPurposeInput: getElement('promptPurposeInput'),
            statusInput: getElement('statusInput'),
            llmModelInput: getElement('llmModelInput'),
            systemMessageInput: getElement('systemMessageInput'),
            userMessageInput: getElement('userMessageInput'),
            cancelModalButton: getElement('cancelModalButton'),
            submitPromptButton: getElement('submitPromptButton', false),
            addPurposeButton: getElement('addPurposeButton'),
            addPurposeModal: getElement('addPurposeModal'),
            newPurposeInput: getElement('newPurposeInput'),
            cancelAddPurposeButton: getElement('cancelAddPurposeButton'),
            savePurposeButton: getElement('savePurposeButton'),
            saveAndRunButton: getElement('saveAndRunButton'),
            saveButtonDropdown: getElement('saveButtonDropdown'),
            saveButtonMenu: getElement('saveButtonMenu'),
            saveChangesButton: getElement('saveChangesButton'),
            newVersionButton: getElement('newVersionButton'),
            slideoutPanel: getElement('slideoutPanel'),
            slideoutOverlay: getElement('slideoutOverlay'),
            slideoutContent: getElement('slideoutContent'),
            slideoutTitle: getElement('slideoutTitle'),
            closeSlideoutPanel: getElement('closeSlideoutPanel'),
            slideoutChatInput: getElement('slideoutChatInput'),
            slideoutChatSend: getElement('slideoutChatSend'),
            promptFiltersBtn: getElement('promptFiltersBtn'),
            promptFiltersDropdown: getElement('promptFiltersDropdown'),
            promptFilterBadge: getElement('promptFilterBadge'),
            clearAllPromptFilters: getElement('clearAllPromptFilters'),
            promptNameFilters: getElement('promptNameFilters'),
            promptVersionFilters: getElement('promptVersionFilters'),
        };

        console.log('[DEBUG] Elements initialization complete');

        const state = {
            founder: null,
            prompts: [],
            currentMode: 'create',
            currentPromptId: null,
            actionMode: 'save-and-run', // 'save-and-run' or 'save-only'
            slideoutPromptId: null, // Track which prompt is being viewed in slideout
            allActions: [], // All actions from all prompts
            filterState: {
                promptNames: new Set(), // Selected prompt names
                promptVersions: new Set(), // Selected prompt versions (format: "name:v1")
            },
        };

        const getAuthToken = () => localStorage.getItem(AUTH_TOKEN_KEY);
        const setAuthToken = (token) => localStorage.setItem(AUTH_TOKEN_KEY, token);
        const clearAuth = () => localStorage.removeItem(AUTH_TOKEN_KEY);

        const authHeaders = () => {
            const token = getAuthToken();
            return token
                ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                : { 'Content-Type': 'application/json' };
        };

        function showLoginError(message) {
            if (!message) {
                elements.loginError.style.display = 'none';
                elements.loginError.textContent = '';
                return;
            }
            elements.loginError.textContent = message;
            elements.loginError.style.display = 'block';
        }

        function showStatus(message, type = 'success') {
            if (!message) {
                elements.statusMessage.style.display = 'none';
                elements.statusMessage.textContent = '';
                elements.statusMessage.classList.remove('success', 'error');
                return;
            }
            elements.statusMessage.textContent = message;
            elements.statusMessage.style.display = 'block';
            elements.statusMessage.classList.remove('success', 'error');
            elements.statusMessage.classList.add(type);
        }

        async function validateFounderSession() {
            const response = await fetch(`${API_BASE_URL}/api/auth/me`, {
                headers: authHeaders(),
            });
            if (!response.ok) {
                throw new Error('Could not validate founder session.');
            }
            const data = await response.json();
            if (!data.is_founder) {
                throw new Error('Access denied: founder privileges required.');
            }
            state.founder = data;
            return data;
        }

        function renderFounderInfo() {
            if (state.founder?.email) {
                elements.founderEmail.textContent = state.founder.email;
            } else {
                elements.founderEmail.textContent = '';
            }
        }

        function showAppShell() {
            elements.loginOverlay.classList.add('hidden');
            elements.appShell.style.display = 'flex';
            renderFounderInfo();
        }

        function resetLoginForm() {
            elements.loginButton.disabled = false;
            elements.loginButton.textContent = 'Login';
        }

        async function loginFounder() {
            const email = elements.loginEmail.value.trim();
            const password = elements.loginPassword.value;

            if (!email) {
                showLoginError('Please enter your founder email.');
                return;
            }

            elements.loginButton.disabled = true;
            elements.loginButton.textContent = 'Logging in...';
            showLoginError();

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Login failed');
                }

                const data = await response.json();
                setAuthToken(data.access_token);

                await validateFounderSession();
                showAppShell();
                await loadInitialData();
            } catch (error) {
                console.error('Founder login failed', error);
                showLoginError(error.message || 'Unable to log in.');
                clearAuth();
            } finally {
                resetLoginForm();
            }
        }

        function logout() {
            clearAuth();
            state.founder = null;
            state.domains = [];
            state.clients = [];
            window.location.href = 'https://marketably.ai';
        }

        async function attemptExistingSession() {
            const token = getAuthToken();
            if (!token) return false;
            try {
                await validateFounderSession();
                showAppShell();
                await loadInitialData();
                return true;
            } catch (error) {
                console.warn('Existing founder session invalid', error);
                clearAuth();
                return false;
            }
        }

        async function loadInitialData() {
            showStatus('Loading prompts…', 'success');
            try {
                await loadPrompts();
                showStatus();
            } catch (error) {
                console.error('Failed to load initial data', error);
                showStatus(error.message || 'Unable to load data.', 'error');
            }
        }

        async function loadPrompts() {
            const statusFilter = elements.statusFilter.value;
            const purposeFilter = elements.purposeFilter.value;
            let url = `${API_BASE_URL}/api/founder/prompts?`;
            const params = new URLSearchParams();
            if (statusFilter) params.append('status', statusFilter);
            if (purposeFilter) params.append('prompt_purpose', purposeFilter);
            url += params.toString();

            const response = await fetch(url, {
                headers: authHeaders(),
            });
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }
                throw new Error('Failed to load prompts.');
            }
            state.prompts = await response.json();
            renderPrompts();
        }

        function renderPrompts() {
            if (!state.prompts.length) {
                elements.promptsContainer.innerHTML = `
                    <div class="empty-state">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No prompts yet</h3>
                        <p style="font-size: 14px;">Create your first prompt to start transforming insights into actions.</p>
                    </div>
                `;
                return;
            }

            // Group prompts by name to show version history
            const promptsByName = {};
            state.prompts.forEach(prompt => {
                if (!promptsByName[prompt.name]) {
                    promptsByName[prompt.name] = [];
                }
                promptsByName[prompt.name].push(prompt);
            });

            elements.promptsContainer.innerHTML = Object.entries(promptsByName)
                .map(([name, versions]) => {
                    const sortedVersions = versions.sort((a, b) => b.version - a.version);
                    const latest = sortedVersions[0];
                    const versionCount = versions.length;
                    const statusBadge = `<span class="client-chip" style="background: ${latest.status === 'live' ? '#f0fff4' : latest.status === 'test' ? '#fffbf0' : '#f7fafc'}; border-color: ${latest.status === 'live' ? '#c6f6d5' : latest.status === 'test' ? '#fbd38d' : '#e2e8f0'}; color: ${latest.status === 'live' ? '#22543d' : latest.status === 'test' ? '#744210' : '#4a5568'};">${latest.status.toUpperCase()}</span>`;
                    const updatedAt = latest.updated_at ? new Date(latest.updated_at).toLocaleString() : 'Unknown';
                    const createdAt = latest.created_at ? new Date(latest.created_at).toLocaleDateString() : 'Unknown';
                    const purposeChip = `<span class="client-chip">${latest.prompt_purpose}</span>`;
                    const modelChip = `<span class="client-chip" style="background: #edf2f7; border-color: #cbd5e0; color: #4a5568;">${latest.llm_model}</span>`;

                    // Build version selector if multiple versions exist
                    let versionSelector = '';
                    if (versionCount > 1) {
                        const versionOptions = sortedVersions.map(v => 
                            `<option value="${v.id}" ${v.id === latest.id ? 'selected' : ''}>v${v.version} - ${v.status}${v.updated_at ? ' (' + new Date(v.updated_at).toLocaleDateString() + ')' : ''}</option>`
                        ).join('');
                        versionSelector = `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <label style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); display: block; margin-bottom: 6px;">Version History</label>
                                <select class="version-selector" data-prompt-name="${name}" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: white;">
                                    ${versionOptions}
                                </select>
                            </div>
                        `;
                    }

                    return `
                        <article class="domain-card" data-prompt-name="${name}">
                            <div class="domain-header">
                                <div>
                                    <h2>${name}</h2>
                                    <div class="domain-meta">
                                        <span>Version ${latest.version}${versionCount > 1 ? ` (${versionCount} versions)` : ''}</span>
                                        <span>Created ${createdAt}</span>
                                        <span>Updated ${updatedAt}</span>
                                    </div>
                                </div>
                                <button class="btn btn-secondary" data-action="edit-prompt" data-prompt-id="${latest.id}">Edit</button>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                                ${statusBadge} ${purposeChip} ${modelChip}
                            </div>
                            <div class="description" style="font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto; background: #f7fafc; padding: 8px; border-radius: 6px; white-space: pre-wrap; word-break: break-word;">${latest.system_message.substring(0, 200)}${latest.system_message.length > 200 ? '...' : ''}</div>
                            ${versionSelector}
                        </article>
                    `;
                })
                .join('');

            elements.promptsContainer.querySelectorAll('[data-action="edit-prompt"]').forEach((button) => {
                button.addEventListener('click', () => {
                    const promptId = button.getAttribute('data-prompt-id');
                    openPromptModal('edit', promptId);
                });
            });

            // Add event listeners for version selectors
            elements.promptsContainer.querySelectorAll('.version-selector').forEach((select) => {
                select.addEventListener('change', (e) => {
                    const promptId = e.target.value;
                    openPromptModal('edit', promptId);
                });
            });
        }

        function loadCustomPurposes() {
            const customPurposes = JSON.parse(localStorage.getItem('customPromptPurposes') || '[]');
            const existingOptions = Array.from(elements.promptPurposeInput.options).map(opt => opt.value);
            
            customPurposes.forEach(purpose => {
                if (purpose && !existingOptions.includes(purpose)) {
                    const option = document.createElement('option');
                    option.value = purpose;
                    option.textContent = purpose.split('-').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    elements.promptPurposeInput.appendChild(option);
                }
            });
        }

        function addCustomPurpose(purpose) {
            if (!purpose) return;
            
            // Normalize to lowercase with hyphens
            const normalizedPurpose = purpose.toLowerCase().trim().replace(/\s+/g, '-');
            
            // Get existing custom purposes
            const customPurposes = JSON.parse(localStorage.getItem('customPromptPurposes') || '[]');
            
            // Add if not already present
            if (!customPurposes.includes(normalizedPurpose)) {
                customPurposes.push(normalizedPurpose);
                localStorage.setItem('customPromptPurposes', JSON.stringify(customPurposes));
                
                // Add to dropdown if not already there
                const existingOptions = Array.from(elements.promptPurposeInput.options).map(opt => opt.value);
                if (!existingOptions.includes(normalizedPurpose)) {
                    const option = document.createElement('option');
                    option.value = normalizedPurpose;
                    option.textContent = normalizedPurpose.split('-').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    elements.promptPurposeInput.appendChild(option);
                }
            }
            
            // Select the new purpose
            elements.promptPurposeInput.value = normalizedPurpose;
        }

        function openPromptModal(mode, promptId = null) {
            state.currentMode = mode;
            state.currentPromptId = promptId;
            elements.promptForm.reset();
            
            // Reload custom purposes
            loadCustomPurposes();

            if (mode === 'edit' && promptId) {
                const prompt = state.prompts.find((item) => item.id === promptId);
                if (!prompt) {
                    showStatus('Selected prompt could not be found.', 'error');
                    return;
                }
                elements.modalTitle.textContent = `Edit ${prompt.name} (v${prompt.version})`;
                elements.nameInput.value = prompt.name;
                elements.versionInput.value = prompt.version;
                elements.promptPurposeInput.value = prompt.prompt_purpose;
                elements.statusInput.value = prompt.status;
                elements.llmModelInput.value = prompt.llm_model;
                elements.systemMessageInput.value = prompt.system_message;
                elements.userMessageInput.value = ''; // User message is not stored, always empty
                
                // Show "New Version" button when editing
                if (elements.newVersionButton) {
                    elements.newVersionButton.style.display = 'block';
                }
                
                // Show modal first
                elements.modalBackdrop.classList.add('visible');
                
                // Store prompt ID for slideout chat
                state.slideoutPromptId = promptId;
                
                // Load and display execution history in slideout
                // Use setTimeout to ensure modal is rendered first
                setTimeout(() => {
                    openSlideout('LLM Outputs');
                    displayAllPromptResults();
                }, 50);
            } else {
                elements.modalTitle.textContent = 'New Prompt';
                elements.nameInput.value = '';
                elements.versionInput.value = '1';
                elements.promptPurposeInput.value = '';
                elements.statusInput.value = 'test';
                elements.llmModelInput.value = 'gpt-4o-mini';
                elements.systemMessageInput.value = '';
                elements.userMessageInput.value = '';
                
                // Hide "New Version" button when creating new prompt
                if (elements.newVersionButton) {
                    elements.newVersionButton.style.display = 'none';
                }
            }

            elements.modalBackdrop.classList.add('visible');

            state.actionMode = 'save-and-run';
            setTimeout(() => elements.nameInput.focus(), 50);
        }

        function openAddPurposeModal() {
            elements.newPurposeInput.value = '';
            elements.addPurposeModal.style.display = 'flex';
            setTimeout(() => elements.newPurposeInput.focus(), 50);
        }

        function closeAddPurposeModal() {
            elements.addPurposeModal.style.display = 'none';
            elements.newPurposeInput.value = '';
        }

        function handleAddPurpose() {
            const newPurpose = elements.newPurposeInput.value.trim();
            if (!newPurpose) {
                showStatus('Please enter a purpose name.', 'error');
                return;
            }
            
            addCustomPurpose(newPurpose);
            closeAddPurposeModal();
            showStatus('Purpose added successfully.', 'success');
            setTimeout(() => showStatus(), 2000);
        }

        function closePromptModal() {
            state.currentMode = 'create';
            state.currentPromptId = null;
            elements.modalBackdrop.classList.remove('visible');
            if (elements.newVersionButton) {
                elements.newVersionButton.style.display = 'none';
            }
        }

        function createNewVersion() {
            if (!state.currentPromptId) {
                showStatus('No prompt selected to create version from.', 'error');
                return;
            }

            const currentPrompt = state.prompts.find((item) => item.id === state.currentPromptId);
            if (!currentPrompt) {
                showStatus('Current prompt could not be found.', 'error');
                return;
            }

            // Find the highest version for this prompt name
            const sameNamePrompts = state.prompts.filter(p => p.name === currentPrompt.name);
            const maxVersion = Math.max(...sameNamePrompts.map(p => p.version));
            const newVersion = maxVersion + 1;

            // Pre-fill form with current prompt data but with new version
            elements.modalTitle.textContent = `New Version: ${currentPrompt.name} (v${newVersion})`;
            elements.nameInput.value = currentPrompt.name;
            elements.versionInput.value = newVersion;
            elements.promptPurposeInput.value = currentPrompt.prompt_purpose;
            elements.statusInput.value = 'test'; // New versions start as test
            elements.llmModelInput.value = currentPrompt.llm_model;
            elements.systemMessageInput.value = currentPrompt.system_message;
            elements.userMessageInput.value = '';

            // Change mode to create
            state.currentMode = 'create';
            state.currentPromptId = null;
            
            // Hide "New Version" button since we're now creating
            if (elements.newVersionButton) {
                elements.newVersionButton.style.display = 'none';
            }
        }

        async function handlePromptFormSubmit(event) {
            event.preventDefault();
            await savePrompt(state.actionMode === 'save-and-run');
        }

        async function savePrompt(shouldExecute = false) {
            elements.saveAndRunButton.disabled = true;
            elements.saveChangesButton.disabled = true;
            
            const nameValue = elements.nameInput.value.trim();
            const versionValue = parseInt(elements.versionInput.value);
            const promptPurposeValue = elements.promptPurposeInput.value;
            const statusValue = elements.statusInput.value;
            const llmModelValue = elements.llmModelInput.value.trim();
            const systemMessageValue = elements.systemMessageInput.value.trim();

            if (!nameValue || !promptPurposeValue || !systemMessageValue || !llmModelValue) {
                showStatus('All required fields must be filled.', 'error');
                elements.saveAndRunButton.disabled = false;
                elements.saveChangesButton.disabled = false;
                return;
            }

            if (isNaN(versionValue) || versionValue < 1) {
                showStatus('Version must be a positive integer.', 'error');
                elements.saveAndRunButton.disabled = false;
                elements.saveChangesButton.disabled = false;
                return;
            }

            const payload = {
                name: nameValue,
                version: versionValue,
                prompt_purpose: promptPurposeValue,
                status: statusValue,
                llm_model: llmModelValue,
                system_message: systemMessageValue,
            };

            try {
                let savedPrompt;
                if (state.currentMode === 'edit' && state.currentPromptId) {
                    savedPrompt = await updatePrompt(state.currentPromptId, payload);
                    showStatus('Prompt updated successfully.', 'success');
                } else {
                    savedPrompt = await createPrompt(payload);
                    showStatus('Prompt created successfully.', 'success');
                }
                
                if (shouldExecute) {
                    const userMessage = elements.userMessageInput.value.trim();
                    closePromptModal();
                    await loadPrompts();
                    await executePrompt(savedPrompt.id, userMessage);
                } else {
                    closePromptModal();
                    await loadPrompts();
                }
            } catch (error) {
                console.error('Prompt save failed', error);
                showStatus(error.message || 'Unable to save prompt.', 'error');
            } finally {
                elements.saveAndRunButton.disabled = false;
                elements.saveChangesButton.disabled = false;
            }
        }

        async function executePrompt(promptId, userMessage) {
            console.log('[DEBUG] executePrompt called', { promptId, userMessage });
            console.log('[DEBUG] slideoutContent element:', elements.slideoutContent);
            
            if (!elements.slideoutContent) {
                console.error('[DEBUG] slideoutContent is null! Cannot display results.');
                showStatus('Error: Slideout panel not found. Please refresh the page.', 'error');
                return;
            }

            // Store prompt ID for slideout chat
            state.slideoutPromptId = promptId;

            openSlideout('LLM Outputs');
            
            // Show loading state
            console.log('[DEBUG] Setting loading state in slideoutContent');
            elements.slideoutContent.innerHTML = `
                <div class="ai-loading">
                    <div class="ai-loading-spinner"></div>
                    <p>Executing prompt...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE_URL}/api/founder/prompts/${promptId}/execute`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ user_message: userMessage || '' }),
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Failed to execute prompt');
                }

                const result = await response.json();
                // Result is already saved to DB by the execute endpoint, so just reload history
                await displayAllPromptResults();
            } catch (error) {
                console.error('Prompt execution failed', error);
                elements.slideoutContent.innerHTML = `
                    <div style="padding: 24px;">
                        <h3 style="color: var(--danger); margin-bottom: 12px;">Error</h3>
                        <p style="color: var(--text);">${error.message || 'Failed to execute prompt'}</p>
                    </div>
                `;
            }
        }

        async function displayAllPromptResults() {
            console.log('[DEBUG displayAllPromptResults] Starting...');
            if (!elements.slideoutContent) {
                console.error('[DEBUG displayAllPromptResults] slideoutContent is null!');
                showStatus('Error: Slideout panel not found. Please refresh the page.', 'error');
                return;
            }

            console.log('[DEBUG displayAllPromptResults] promptFiltersBtn element:', elements.promptFiltersBtn);
            console.log('[DEBUG displayAllPromptResults] promptNameFilters element:', elements.promptNameFilters);
            console.log('[DEBUG displayAllPromptResults] promptVersionFilters element:', elements.promptVersionFilters);

            try {
                // Load all actions from all prompts
                console.log('[DEBUG displayAllPromptResults] Fetching actions from:', `${API_BASE_URL}/api/founder/prompts/all/actions`);
                const actionsResponse = await fetch(`${API_BASE_URL}/api/founder/prompts/all/actions`, {
                    headers: authHeaders(),
                });

                console.log('[DEBUG displayAllPromptResults] Response status:', actionsResponse.status, actionsResponse.ok);

                let allActions = [];
                if (actionsResponse.ok) {
                    allActions = await actionsResponse.json();
                    console.log('[DEBUG displayAllPromptResults] Received actions:', allActions.length, allActions);
                } else {
                    const errorText = await actionsResponse.text();
                    console.error('[DEBUG displayAllPromptResults] Response not OK:', errorText);
                }

                state.allActions = allActions;
                console.log('[DEBUG displayAllPromptResults] State after setting actions:', state);

                // Build filter UI (this will also call applyFiltersAndDisplay after initializing filter state)
                buildFilterUI(allActions);
            } catch (error) {
                console.error('[DEBUG displayAllPromptResults] Failed to load execution history', error);
                elements.slideoutContent.innerHTML = `
                    <div style="padding: 24px;">
                        <h3 style="color: var(--danger); margin-bottom: 12px;">Error</h3>
                        <p style="color: var(--text);">${error.message || 'Failed to load execution history'}</p>
                    </div>
                `;
            }
        }

        function buildFilterUI(actions) {
            console.log('[DEBUG buildFilterUI] Starting with', actions.length, 'actions');
            console.log('[DEBUG buildFilterUI] Filter elements exist:', {
                promptFiltersBtn: !!elements.promptFiltersBtn,
                promptFiltersDropdown: !!elements.promptFiltersDropdown,
                promptNameFilters: !!elements.promptNameFilters,
                promptVersionFilters: !!elements.promptVersionFilters
            });
            
            // Collect unique prompt names and versions
            const promptNames = new Set();
            const promptVersions = new Map(); // name -> Set of versions

            actions.forEach(action => {
                if (action.prompt_name) {
                    promptNames.add(action.prompt_name);
                    if (!promptVersions.has(action.prompt_name)) {
                        promptVersions.set(action.prompt_name, new Set());
                    }
                    if (action.prompt_version !== null && action.prompt_version !== undefined) {
                        promptVersions.get(action.prompt_name).add(action.prompt_version);
                    }
                }
            });

            console.log('[DEBUG buildFilterUI] Collected:', {
                promptNames: Array.from(promptNames),
                promptVersions: Array.from(promptVersions.entries()).map(([name, versions]) => [name, Array.from(versions)])
            });

            // When filterState is empty, we want all items checked by default (show all)
            // So we'll check all boxes and populate the filterState accordingly
            const shouldCheckAll = state.filterState.promptNames.size === 0 && state.filterState.promptVersions.size === 0;
            
            // Build prompt name checkboxes
            let nameFiltersHtml = '';
            Array.from(promptNames).sort().forEach(name => {
                const isChecked = shouldCheckAll || state.filterState.promptNames.has(name);
                if (isChecked && shouldCheckAll) {
                    state.filterState.promptNames.add(name);
                }
                nameFiltersHtml += `
                    <div class="filter-checkbox-item">
                        <input type="checkbox" id="filter-name-${name}" data-prompt-name="${name}" ${isChecked ? 'checked' : ''}>
                        <label for="filter-name-${name}">${name}</label>
                    </div>
                `;
            });
            elements.promptNameFilters.innerHTML = nameFiltersHtml || '<span style="color: var(--muted); font-size: 12px;">No prompts found</span>';

            // Build version checkboxes
            let versionFiltersHtml = '';
            Array.from(promptVersions.entries()).sort().forEach(([name, versions]) => {
                Array.from(versions).sort((a, b) => a - b).forEach(version => {
                    const versionKey = `${name}:v${version}`;
                    const isChecked = shouldCheckAll || state.filterState.promptVersions.has(versionKey);
                    if (isChecked && shouldCheckAll) {
                        state.filterState.promptVersions.add(versionKey);
                    }
                    versionFiltersHtml += `
                        <div class="filter-checkbox-item">
                            <input type="checkbox" id="filter-version-${name}-${version}" data-version-key="${versionKey}" data-prompt-name="${name}" data-version="${version}" ${isChecked ? 'checked' : ''}>
                            <label for="filter-version-${name}-${version}">${name} v${version}</label>
                        </div>
                    `;
                });
            });
            elements.promptVersionFilters.innerHTML = versionFiltersHtml || '<span style="color: var(--muted); font-size: 12px;">No versions found</span>';

            // Show/hide filter button based on whether there are actions
            console.log('[DEBUG buildFilterUI] Actions length:', actions.length, 'filter button exists:', !!elements.promptFiltersBtn);
            if (elements.promptFiltersBtn) {
                if (actions.length > 0) {
                    console.log('[DEBUG buildFilterUI] Showing filter button');
                    elements.promptFiltersBtn.style.display = 'flex';
                } else {
                    console.log('[DEBUG buildFilterUI] Hiding filter button');
                    elements.promptFiltersBtn.style.display = 'none';
                }
            } else {
                console.error('[DEBUG buildFilterUI] promptFiltersBtn element is null!');
            }
            
            // Update filter badge
            updateFilterBadge();

            // Attach filter event listeners (this will initialize filter state from checked boxes)
            console.log('[DEBUG buildFilterUI] Calling attachFilterListeners');
            attachFilterListeners();
            
            // Now apply filters and display (after state is initialized from checked boxes)
            console.log('[DEBUG buildFilterUI] Calling applyFiltersAndDisplay');
            applyFiltersAndDisplay(actions);
        }

        function attachFilterListeners() {
            console.log('[DEBUG attachFilterListeners] Starting');
            console.log('[DEBUG attachFilterListeners] Elements:', {
                promptNameFilters: elements.promptNameFilters,
                promptVersionFilters: elements.promptVersionFilters
            });
            
            // Initialize filter state based on checked checkboxes
            state.filterState.promptNames.clear();
            state.filterState.promptVersions.clear();
            
            // Prompt name filters
            const nameCheckboxes = elements.promptNameFilters ? elements.promptNameFilters.querySelectorAll('input[type="checkbox"]') : [];
            console.log('[DEBUG attachFilterListeners] Found', nameCheckboxes.length, 'name checkboxes');
            nameCheckboxes.forEach(checkbox => {
                // Initialize state from checked checkboxes
                if (checkbox.checked) {
                    const promptName = checkbox.getAttribute('data-prompt-name');
                    console.log('[DEBUG attachFilterListeners] Adding checked name:', promptName);
                    state.filterState.promptNames.add(promptName);
                }
                
                checkbox.addEventListener('change', (e) => {
                    const promptName = e.target.getAttribute('data-prompt-name');
                    if (e.target.checked) {
                        state.filterState.promptNames.add(promptName);
                    } else {
                        state.filterState.promptNames.delete(promptName);
                    }
                    console.log('[DEBUG attachFilterListeners] Name filter changed:', Array.from(state.filterState.promptNames));
                    applyFiltersAndDisplay(state.allActions);
                    updateFilterBadge();
                });
            });

            // Version filters
            const versionCheckboxes = elements.promptVersionFilters ? elements.promptVersionFilters.querySelectorAll('input[type="checkbox"]') : [];
            console.log('[DEBUG attachFilterListeners] Found', versionCheckboxes.length, 'version checkboxes');
            versionCheckboxes.forEach(checkbox => {
                // Initialize state from checked checkboxes
                if (checkbox.checked) {
                    const versionKey = checkbox.getAttribute('data-version-key');
                    console.log('[DEBUG attachFilterListeners] Adding checked version:', versionKey);
                    state.filterState.promptVersions.add(versionKey);
                }
                
                checkbox.addEventListener('change', (e) => {
                    const versionKey = e.target.getAttribute('data-version-key');
                    if (e.target.checked) {
                        state.filterState.promptVersions.add(versionKey);
                    } else {
                        state.filterState.promptVersions.delete(versionKey);
                    }
                    console.log('[DEBUG attachFilterListeners] Version filter changed:', Array.from(state.filterState.promptVersions));
                    applyFiltersAndDisplay(state.allActions);
                    updateFilterBadge();
                    updateFilterBadge();
                });
            });
            
            console.log('[DEBUG attachFilterListeners] Final state:', {
                promptNames: Array.from(state.filterState.promptNames),
                promptVersions: Array.from(state.filterState.promptVersions)
            });
        }

        function applyFiltersAndDisplay(actions) {
            console.log('[DEBUG applyFiltersAndDisplay] Starting with', actions.length, 'actions');
            console.log('[DEBUG applyFiltersAndDisplay] Filter state:', {
                promptNames: Array.from(state.filterState.promptNames),
                promptVersions: Array.from(state.filterState.promptVersions)
            });
            
            // Filter actions based on selected filters
            let filteredActions = actions;

            // Filter by prompt name (if any are selected)
            if (state.filterState.promptNames.size > 0) {
                console.log('[DEBUG applyFiltersAndDisplay] Filtering by names:', Array.from(state.filterState.promptNames));
                filteredActions = filteredActions.filter(action => 
                    action.prompt_name && state.filterState.promptNames.has(action.prompt_name)
                );
                console.log('[DEBUG applyFiltersAndDisplay] After name filter:', filteredActions.length);
            } else {
                console.log('[DEBUG applyFiltersAndDisplay] No name filter (showing all)');
            }

            // Filter by version (if any are selected)
            // Note: Version filter is applied in addition to name filter (AND logic)
            if (state.filterState.promptVersions.size > 0) {
                console.log('[DEBUG applyFiltersAndDisplay] Filtering by versions:', Array.from(state.filterState.promptVersions));
                filteredActions = filteredActions.filter(action => {
                    if (!action.prompt_name || action.prompt_version === null || action.prompt_version === undefined) {
                        return false;
                    }
                    const versionKey = `${action.prompt_name}:v${action.prompt_version}`;
                    return state.filterState.promptVersions.has(versionKey);
                });
                console.log('[DEBUG applyFiltersAndDisplay] After version filter:', filteredActions.length);
            } else {
                console.log('[DEBUG applyFiltersAndDisplay] No version filter');
            }

            // Build HTML for filtered outputs
            console.log('[DEBUG applyFiltersAndDisplay] Final filtered count:', filteredActions.length);
            let outputsHtml = '';

            if (filteredActions.length === 0) {
                console.log('[DEBUG applyFiltersAndDisplay] No results, showing empty message');
                outputsHtml = '<p style="color: var(--muted); padding: 24px; text-align: center;">No execution results match the selected filters.</p>';
            } else {
                console.log('[DEBUG applyFiltersAndDisplay] Building HTML for', filteredActions.length, 'actions');
                filteredActions.forEach((action, index) => {
                    const actionContent = action.actions?.content || '';
                    const content = typeof actionContent === 'string' 
                        ? actionContent 
                        : JSON.stringify(actionContent, null, 2);
                    
                    const createdAt = action.created_at 
                        ? new Date(action.created_at).toLocaleString() 
                        : 'Unknown';
                    
                    const metadata = action.actions || {};
                    
                    // Parse prompt_text_sent to extract system and user messages
                    const promptTextSent = action.prompt_text_sent || '';
                    let systemMessage = '';
                    let userMessage = '';
                    
                    if (promptTextSent.includes('System:') && promptTextSent.includes('User:')) {
                        const parts = promptTextSent.split('User:');
                        systemMessage = parts[0].replace('System:', '').trim();
                        userMessage = parts.slice(1).join('User:').trim();
                    } else {
                        // Fallback: use prompt_system_message if available, otherwise use prompt_text_sent
                        systemMessage = action.prompt_system_message || promptTextSent;
                        userMessage = '';
                    }

                    // Use prompt details from action if available
                    const promptName = action.prompt_name || 'Unknown';
                    const promptVersion = action.prompt_version !== null && action.prompt_version !== undefined ? `v${action.prompt_version}` : '';
                    
                    outputsHtml += `
                        <div class="prompt-output-item" data-action-id="${action.id}" data-prompt-name="${promptName}" data-prompt-version="${action.prompt_version || ''}">
                            <div class="prompt-output-header">
                                <div class="prompt-output-meta">
                                    <div style="margin-bottom: 4px;">
                                        <strong>${promptName} ${promptVersion}</strong>
                                        <span style="color: var(--muted); font-size: 12px; margin-left: 12px;">${createdAt}</span>
                                        ${metadata.model ? `<span style="color: var(--muted); font-size: 12px; margin-left: 8px;">• ${metadata.model}</span>` : ''}
                                        ${metadata.tokens_used ? `<span style="color: var(--muted); font-size: 12px; margin-left: 8px;">• ${metadata.tokens_used} tokens</span>` : ''}
                                    </div>
                                    ${userMessage ? `<div style="font-size: 12px; color: var(--text); margin-top: 4px;"><strong>User Message:</strong> ${escapeHtml(userMessage)}</div>` : ''}
                                    ${systemMessage ? `
                                        <div style="margin-top: 8px;">
                                            <button class="toggle-system-message" data-action-id="${action.id}" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 12px; padding: 0; text-decoration: underline;">
                                                <span class="toggle-text">Show</span> System Message
                                            </button>
                                            <div class="system-message-content" id="system-msg-${action.id}" style="display: none; margin-top: 8px; padding: 12px; background: #f7fafc; border-radius: 6px; font-size: 12px; color: var(--text); white-space: pre-wrap; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;">${escapeHtml(systemMessage)}</div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="prompt-output-actions">
                                    <button class="btn-copy-output" data-action-id="${action.id}" title="Copy to clipboard">
                                        <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/copy_button.png" alt="Copy" width="16" height="16">
                                    </button>
                                    <button class="btn-delete-output" data-action-id="${action.id}" title="Delete">
                                        <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/delete_button.png" alt="Delete" width="16" height="16">
                                    </button>
                                </div>
                            </div>
                            <div class="prompt-result-content">${escapeHtml(content)}</div>
                        </div>
                    `;
                });
            }

            console.log('[DEBUG applyFiltersAndDisplay] Setting HTML, length:', outputsHtml.length);
            elements.slideoutContent.innerHTML = outputsHtml;

            // Attach event listeners
            console.log('[DEBUG applyFiltersAndDisplay] Attaching listeners');
            attachOutputActionListeners();
            attachSystemMessageToggleListeners();
            
            // Auto-scroll to bottom to show newest output
            // Use requestAnimationFrame to ensure DOM is fully rendered
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    if (elements.slideoutContent) {
                        elements.slideoutContent.scrollTop = elements.slideoutContent.scrollHeight;
                    }
                });
            });
            
            console.log('[DEBUG applyFiltersAndDisplay] Complete');
        }

        function attachSystemMessageToggleListeners() {
            elements.slideoutContent.querySelectorAll('.toggle-system-message').forEach(button => {
                button.addEventListener('click', (e) => {
                    const actionId = button.getAttribute('data-action-id');
                    const systemMsgDiv = document.getElementById(`system-msg-${actionId}`);
                    const toggleText = button.querySelector('.toggle-text');
                    
                    if (systemMsgDiv) {
                        if (systemMsgDiv.style.display === 'none') {
                            systemMsgDiv.style.display = 'block';
                            toggleText.textContent = 'Hide';
                        } else {
                            systemMsgDiv.style.display = 'none';
                            toggleText.textContent = 'Show';
                        }
                    }
                });
            });
        }

        async function displayPromptResultWithHistory(promptId, newResult = null) {
            console.log('[DEBUG] displayPromptResultWithHistory called', { promptId, newResult });
            
            if (!elements.slideoutContent) {
                console.error('[DEBUG] slideoutContent is null!');
                showStatus('Error: Slideout panel not found. Please refresh the page.', 'error');
                return;
            }

            try {
                // Load historical outputs
                const actionsResponse = await fetch(`${API_BASE_URL}/api/founder/prompts/${promptId}/actions`, {
                    headers: authHeaders(),
                });

                let actions = [];
                if (actionsResponse.ok) {
                    actions = await actionsResponse.json();
                }

                // Build HTML for all outputs (oldest to newest)
                let outputsHtml = '';

                if (actions.length === 0 && !newResult) {
                    outputsHtml = '<p style="color: var(--muted); padding: 24px; text-align: center;">No execution history yet. Execute the prompt to see results here.</p>';
                } else {
                    // Display historical outputs (oldest first)
                    actions.forEach((action, index) => {
                        const actionContent = action.actions?.content || '';
                        const content = typeof actionContent === 'string' 
                            ? actionContent 
                            : JSON.stringify(actionContent, null, 2);
                        
                        const createdAt = action.created_at 
                            ? new Date(action.created_at).toLocaleString() 
                            : 'Unknown';
                        
                        const metadata = action.actions || {};
                        
                        outputsHtml += `
                            <div class="prompt-output-item" data-action-id="${action.id}">
                                <div class="prompt-output-header">
                                    <div class="prompt-output-meta">
                                        <strong>Execution #${index + 1}</strong>
                                        <span style="color: var(--muted); font-size: 12px; margin-left: 12px;">${createdAt}</span>
                                        ${metadata.model ? `<span style="color: var(--muted); font-size: 12px; margin-left: 8px;">• ${metadata.model}</span>` : ''}
                                        ${metadata.tokens_used ? `<span style="color: var(--muted); font-size: 12px; margin-left: 8px;">• ${metadata.tokens_used} tokens</span>` : ''}
                                    </div>
                                    <div class="prompt-output-actions">
                                        <button class="btn-copy-output" data-action-id="${action.id}" title="Copy to clipboard">
                                            <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/copy_button.png" alt="Copy" width="16" height="16">
                                        </button>
                                        <button class="btn-delete-output" data-action-id="${action.id}" title="Delete">
                                            <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/delete_button.png" alt="Delete" width="16" height="16">
                                        </button>
                                    </div>
                                </div>
                                <div class="prompt-result-content">${escapeHtml(content)}</div>
                            </div>
                        `;
                    });

                    // Note: newResult is no longer displayed separately since it's already saved to DB
                    // and will appear in the actions list above. This prevents duplication.
                }

                elements.slideoutContent.innerHTML = outputsHtml;

                // Attach event listeners for copy and delete buttons
                attachOutputActionListeners();
            } catch (error) {
                console.error('Failed to load execution history', error);
                elements.slideoutContent.innerHTML = `
                    <div style="padding: 24px;">
                        <h3 style="color: var(--danger); margin-bottom: 12px;">Error</h3>
                        <p style="color: var(--text);">${error.message || 'Failed to load execution history'}</p>
                    </div>
                `;
            }
        }

        function attachOutputActionListeners() {
            // Copy buttons
            elements.slideoutContent.querySelectorAll('.btn-copy-output').forEach((button) => {
                button.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const actionId = button.getAttribute('data-action-id');
                    const dataContentRaw = button.getAttribute('data-content-raw');
                    
                    let textToCopy = '';
                    
                    if (dataContentRaw) {
                        // New result (not yet saved) - decode HTML entities
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = dataContentRaw;
                        textToCopy = tempDiv.textContent || tempDiv.innerText;
                    } else if (actionId) {
                        // Historical result - get content from the action
                        const outputItem = button.closest('.prompt-output-item');
                        const contentDiv = outputItem?.querySelector('.prompt-result-content');
                        if (contentDiv) {
                            textToCopy = contentDiv.textContent || contentDiv.innerText;
                        }
                    }
                    
                    if (textToCopy) {
                        try {
                            await navigator.clipboard.writeText(textToCopy);
                            showStatus('Copied to clipboard!', 'success');
                            setTimeout(() => showStatus(), 2000);
                        } catch (err) {
                            console.error('Failed to copy:', err);
                            showStatus('Failed to copy to clipboard', 'error');
                        }
                    }
                });
            });

            // Delete buttons
            elements.slideoutContent.querySelectorAll('.btn-delete-output').forEach((button) => {
                button.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const actionId = button.getAttribute('data-action-id');
                    
                    if (!actionId) return;
                    
                    if (!confirm('Are you sure you want to delete this execution result?')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/founder/prompts/actions/${actionId}`, {
                            method: 'DELETE',
                            headers: authHeaders(),
                        });
                        
                        if (!response.ok) {
                            const error = await response.json().catch(() => ({}));
                            throw new Error(error.detail || 'Failed to delete action');
                        }
                        
                        // Reload the history
                        await displayAllPromptResults();
                        showStatus('Execution result deleted', 'success');
                        setTimeout(() => showStatus(), 2000);
                    } catch (error) {
                        console.error('Failed to delete action', error);
                        showStatus(error.message || 'Failed to delete execution result', 'error');
                    }
                });
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeHtmlForAttribute(text) {
            // Escape for HTML attribute (handles quotes and special chars)
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function updateFilterBadge() {
            if (!elements.promptFilterBadge) return;
            
            const totalFilters = state.filterState.promptNames.size + state.filterState.promptVersions.size;
            if (totalFilters > 0) {
                elements.promptFilterBadge.textContent = totalFilters;
                elements.promptFilterBadge.classList.add('active');
            } else {
                elements.promptFilterBadge.classList.remove('active');
            }
        }
        
        function setupFilterButton() {
            if (!elements.promptFiltersBtn || !elements.promptFiltersDropdown) {
                return;
            }
            
            // Remove existing listeners to avoid duplicates by cloning the button
            const existingBtn = elements.promptFiltersBtn;
            const newBtn = existingBtn.cloneNode(true);
            existingBtn.parentNode.replaceChild(newBtn, existingBtn);
            elements.promptFiltersBtn = newBtn;
            
            // Toggle dropdown
            elements.promptFiltersBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = elements.promptFiltersDropdown.style.display !== 'none';
                elements.promptFiltersDropdown.style.display = isVisible ? 'none' : 'block';
            });
            
            // Close dropdown when clicking outside
            const closeHandler = (e) => {
                if (elements.promptFiltersBtn && elements.promptFiltersDropdown &&
                    !elements.promptFiltersBtn.contains(e.target) && 
                    !elements.promptFiltersDropdown.contains(e.target)) {
                    elements.promptFiltersDropdown.style.display = 'none';
                }
            };
            // Remove old listener if it exists (we'll add a new one)
            document.addEventListener('click', closeHandler);
            
            // Clear all filters button
            if (elements.clearAllPromptFilters) {
                // Remove old listener by cloning
                const existingClearBtn = elements.clearAllPromptFilters;
                const newClearBtn = existingClearBtn.cloneNode(true);
                existingClearBtn.parentNode.replaceChild(newClearBtn, existingClearBtn);
                elements.clearAllPromptFilters = newClearBtn;
                
                elements.clearAllPromptFilters.addEventListener('click', () => {
                    state.filterState.promptNames.clear();
                    state.filterState.promptVersions.clear();
                    
                    // Uncheck all checkboxes
                    if (elements.promptNameFilters) {
                        elements.promptNameFilters.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    }
                    if (elements.promptVersionFilters) {
                        elements.promptVersionFilters.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    }
                    
                    // Re-apply filters (will show all)
                    applyFiltersAndDisplay(state.allActions);
                    updateFilterBadge();
                });
            }
        }

        function openSlideout(title) {
            console.log('[DEBUG] openSlideout called', { title });
            console.log('[DEBUG] slideoutTitle:', elements.slideoutTitle);
            console.log('[DEBUG] slideoutPanel:', elements.slideoutPanel);
            console.log('[DEBUG] slideoutOverlay:', elements.slideoutOverlay);
            
            if (elements.slideoutTitle) {
                elements.slideoutTitle.textContent = title || 'LLM Outputs';
            } else {
                console.warn('[DEBUG] slideoutTitle is null');
            }
            
            if (elements.slideoutPanel) {
                elements.slideoutPanel.classList.add('open');
                // Add prompt engineering context class so chat input is visible
                elements.slideoutPanel.classList.add('prompt-engineering-context');
                console.log('[DEBUG] Added "open" class to slideoutPanel');
            } else {
                console.error('[DEBUG] slideoutPanel is null!');
            }
            
            if (elements.slideoutOverlay) {
                elements.slideoutOverlay.classList.add('visible');
                console.log('[DEBUG] Added "visible" class to slideoutOverlay');
            } else {
                console.error('[DEBUG] slideoutOverlay is null!');
            }
            
            document.body.classList.add('slideout-open');
            
            // Setup filter button click handler
            setupFilterButton();
        }

        function closeSlideout() {
            if (elements.slideoutPanel) {
                elements.slideoutPanel.classList.remove('open');
                // Remove prompt engineering context class when closing
                elements.slideoutPanel.classList.remove('prompt-engineering-context');
            }
            if (elements.slideoutOverlay) {
                elements.slideoutOverlay.classList.remove('visible');
            }
            if (elements.slideoutChatInput) {
                elements.slideoutChatInput.value = '';
            }
            state.slideoutPromptId = null;
            document.body.classList.remove('slideout-open');
        }

        async function handleSlideoutChatSubmit() {
            if (!state.slideoutPromptId) {
                showStatus('No prompt selected for execution.', 'error');
                return;
            }

            const userMessage = elements.slideoutChatInput.value.trim();
            if (!userMessage) {
                showStatus('Please enter a prompt message.', 'error');
                return;
            }

            // Disable send button and show loading
            elements.slideoutChatSend.disabled = true;
            const sendIcon = document.getElementById('slideoutChatSendIcon');
            if (sendIcon) {
                sendIcon.style.display = 'none';
            }
            elements.slideoutChatSend.innerHTML = '<div class="ai-loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>';

            try {
                // Execute the prompt
                const response = await fetch(`${API_BASE_URL}/api/founder/prompts/${state.slideoutPromptId}/execute`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ user_message: userMessage }),
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Failed to execute prompt');
                }

                const result = await response.json();
                
                // Clear the input
                elements.slideoutChatInput.value = '';
                
                // Show done icon
                elements.slideoutChatSend.innerHTML = '<img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/done_icon.png" alt="Done" width="20" height="20" id="slideoutChatSendIcon">';
                
                // Refresh the history display (result is already saved to DB, so no need to pass it)
                await displayAllPromptResults();
                
                showStatus('Prompt executed successfully!', 'success');
                setTimeout(() => showStatus(), 2000);
                
                // Reset to send icon after 2 seconds
                setTimeout(() => {
                    if (elements.slideoutChatSend) {
                        elements.slideoutChatSend.innerHTML = '<img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/send_icon.png" alt="Send" width="20" height="20" id="slideoutChatSendIcon">';
                        elements.slideoutChatSend.disabled = false;
                    }
                }, 2000);
            } catch (error) {
                console.error('Prompt execution failed', error);
                showStatus(error.message || 'Failed to execute prompt', 'error');
                // Reset to send icon on error
                elements.slideoutChatSend.innerHTML = '<img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/send_icon.png" alt="Send" width="20" height="20" id="slideoutChatSendIcon">';
                elements.slideoutChatSend.disabled = false;
            }
        }

        async function createPrompt(payload) {
            const response = await fetch(`${API_BASE_URL}/api/founder/prompts`, {
                method: 'POST',
                headers: authHeaders(),
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || 'Failed to create prompt.');
            }
            return response.json();
        }

        async function updatePrompt(promptId, payload) {
            const response = await fetch(`${API_BASE_URL}/api/founder/prompts/${promptId}`, {
                method: 'PUT',
                headers: authHeaders(),
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || 'Failed to update prompt.');
            }
            return response.json();
        }

        elements.loginButton.addEventListener('click', loginFounder);
        elements.logoutButton.addEventListener('click', logout);
        elements.refreshButton.addEventListener('click', loadInitialData);
        elements.newPromptButton.addEventListener('click', () => openPromptModal('create'));
        elements.cancelModalButton.addEventListener('click', closePromptModal);
        elements.promptForm.addEventListener('submit', handlePromptFormSubmit);
        elements.saveAndRunButton.addEventListener('click', () => {
            state.actionMode = 'save-and-run';
            elements.promptForm.requestSubmit();
        });
        elements.saveChangesButton.addEventListener('click', () => {
            state.actionMode = 'save-only';
            elements.promptForm.requestSubmit();
        });
        elements.saveButtonDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
            elements.saveButtonMenu.classList.toggle('visible');
        });
        if (elements.newVersionButton) {
            elements.newVersionButton.addEventListener('click', createNewVersion);
        }
        if (elements.closeSlideoutPanel) {
            elements.closeSlideoutPanel.addEventListener('click', closeSlideout);
        } else {
            console.error('[DEBUG] closeSlideoutPanel is null, cannot attach event listener');
        }
        
        if (elements.slideoutOverlay) {
            elements.slideoutOverlay.addEventListener('click', (e) => {
                // Only close if clicking on the overlay itself, not if modal is open
                if (e.target === elements.slideoutOverlay && !elements.modalBackdrop?.classList.contains('visible')) {
                    closeSlideout();
                }
            });
        } else {
            console.error('[DEBUG] slideoutOverlay is null, cannot attach event listener');
        }

        // Chat input event listeners
        if (elements.slideoutChatSend) {
            elements.slideoutChatSend.addEventListener('click', handleSlideoutChatSubmit);
        }

        if (elements.slideoutChatInput) {
            elements.slideoutChatInput.addEventListener('keydown', (e) => {
                // Submit on Enter (but allow Shift+Enter for new line)
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSlideoutChatSubmit();
                }
            });
        }
        
        // Close dropdown menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!elements.saveButtonDropdown.contains(e.target) && !elements.saveButtonMenu.contains(e.target)) {
                elements.saveButtonMenu.classList.remove('visible');
            }
        });
        
        // Close slideout on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && elements.slideoutPanel && elements.slideoutPanel.classList.contains('open')) {
                closeSlideout();
            }
        });
        elements.statusFilter.addEventListener('change', loadPrompts);
        elements.purposeFilter.addEventListener('change', loadPrompts);
        elements.addPurposeButton.addEventListener('click', openAddPurposeModal);
        elements.cancelAddPurposeButton.addEventListener('click', closeAddPurposeModal);
        elements.savePurposeButton.addEventListener('click', handleAddPurpose);
        
        // Allow Enter key to submit add purpose form
        elements.newPurposeInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleAddPurpose();
            }
        });
        
        // Close add purpose modal when clicking backdrop
        elements.addPurposeModal.addEventListener('click', (event) => {
            if (event.target === elements.addPurposeModal) {
                closeAddPurposeModal();
            }
        });

        elements.modalBackdrop.addEventListener('click', (event) => {
            if (event.target === elements.modalBackdrop) {
                closePromptModal();
            }
        });

        elements.loginEmail.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                loginFounder();
            }
        });

        elements.loginPassword.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                loginFounder();
            }
        });

        // Load custom purposes on page load
        loadCustomPurposes();
        
        // Also load existing purposes from database to populate filter dropdown
        async function loadExistingPurposes() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/founder/prompts`, {
                    headers: authHeaders(),
                });
                if (response.ok) {
                    const prompts = await response.json();
                    const uniquePurposes = [...new Set(prompts.map(p => p.prompt_purpose))].sort();
                    
                    // Add to filter dropdown
                    uniquePurposes.forEach(purpose => {
                        const existingOptions = Array.from(elements.purposeFilter.options).map(opt => opt.value);
                        if (!existingOptions.includes(purpose)) {
                            const option = document.createElement('option');
                            option.value = purpose;
                            option.textContent = purpose.split('-').map(word => 
                                word.charAt(0).toUpperCase() + word.slice(1)
                            ).join(' ');
                            elements.purposeFilter.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.warn('Could not load existing purposes for filter:', error);
            }
        }

        attemptExistingSession().then((hasSession) => {
            if (!hasSession) {
                elements.loginOverlay.classList.remove('hidden');
                elements.appShell.style.display = 'none';
            } else {
                loadExistingPurposes();
            }
        });
    </script>
</body>
</html>
