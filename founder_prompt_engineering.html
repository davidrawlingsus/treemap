<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZHSFGWQMSN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZHSFGWQMSN');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founder Admin - Prompt Engineering</title>
    <link rel="icon" href="/images/favicon.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/styles/founder-admin.css">
    <!-- Prompt engineering styles (split for maintainability) -->
    <link rel="stylesheet" href="/styles/prompt-engineering/common.css">
    <link rel="stylesheet" href="/styles/prompt-engineering/slideout.css">
    <link rel="stylesheet" href="/styles/prompt-engineering/filters.css">
    <link rel="stylesheet" href="/styles/prompt-engineering/results.css">
    <link rel="stylesheet" href="/styles/prompt-engineering/idea-cards.css">
    <script src="/config.js"></script>
    <script src="/auth.js"></script>
    <!-- Image loading monitor for debugging intermittent Vercel Blob issues -->
    <script src="/js/utils/image-monitor.js"></script>
    <!-- Shared utilities and components -->
    <script src="/js/founder-admin-common.js"></script>
    <script src="/js/founder-admin-components.js"></script>
    <!-- Prompt engineering modules -->
    <script src="/js/prompt-engineering/state.js"></script>
    <script src="/js/prompt-engineering/api.js"></script>
    <script src="/js/prompt-engineering/purposes.js"></script>
    <!-- UI rendering modules (split for maintainability) -->
    <script src="/js/prompt-engineering/rendering/markdown-converter.js"></script>
    <script src="/js/prompt-engineering/rendering/streaming-renderer.js"></script>
    <script src="/js/prompt-engineering/rendering/prompt-list-renderer.js"></script>
    <script src="/js/prompt-engineering/rendering/action-renderer.js"></script>
    <script src="/js/prompt-engineering/rendering/ui-helpers.js"></script>
    <script src="/js/prompt-engineering/filters.js"></script>
    <script src="/js/prompt-engineering/slideout.js"></script>
    <script src="/js/prompt-engineering/modals.js"></script>
    <script src="/js/prompt-engineering/main.js"></script>
</head>
<body>
    <div id="loginOverlay" class="login-overlay hidden">
        <div class="login-container">
            <div id="loginFormSection">
                <h2>Sign in</h2>
                <p class="login-subtext">
                    Enter your work email and we'll email you a secure magic link.
                </p>
                <input type="email" id="loginEmail" placeholder="you@company.com" autocomplete="email">
                <button id="loginButton" type="button">Send Magic Link</button>
                <div id="loginError" class="login-error"></div>
                <div id="loginSuccess" class="login-success"></div>
            </div>
        </div>
    </div>

    <div id="appShell">
        <header>
            <div>
                <nav class="breadcrumbs">
                    <a href="/">Visualizations</a>
                    <span class="breadcrumbs-separator">›</span>
                    <a href="/founder_admin.html">Founder Admin</a>
                    <span class="breadcrumbs-separator">›</span>
                    <span>Prompt Engineering</span>
                </nav>
                <h1>Prompt Engineering</h1>
                <div class="subtitle">
                    Manage system prompts for transforming insights into actions with version control.
                </div>
            </div>
            <div class="founder-meta">
                <span id="founderEmail"></span>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" id="refreshButton">Refresh</button>
                    <button class="btn btn-secondary" id="logoutButton">Logout</button>
                </div>
            </div>
        </header>
        <main>
            <div class="content">
                <div class="toolbar">
                    <div>
                        <h2 style="font-size: 18px; font-weight: 600;">Prompts</h2>
                        <p style="font-size: 14px; color: var(--muted); margin-top: 6px;">
                            Create and manage system prompts with version control for transforming insights into actions.
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="statusFilter" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                            <option value="">All Statuses</option>
                            <option value="live">Live</option>
                            <option value="test">Test</option>
                            <option value="archived">Archived</option>
                        </select>
                        <select id="purposeFilter" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                            <option value="">All Purposes</option>
                            <option value="summarize">Summarize</option>
                            <option value="headlines">Headlines</option>
                            <option value="ux-fixes">UX Fixes</option>
                            <option value="risk-reversal">Risk Reversal</option>
                            <option value="microcopy">Microcopy</option>
                        </select>
                        <div class="view-toggle" id="viewToggle">
                            <button type="button" class="view-toggle-btn" data-view="cards" title="Card view">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <rect x="1" y="1" width="6" height="6" rx="1"/>
                                    <rect x="9" y="1" width="6" height="6" rx="1"/>
                                    <rect x="1" y="9" width="6" height="6" rx="1"/>
                                    <rect x="9" y="9" width="6" height="6" rx="1"/>
                                </svg>
                            </button>
                            <button type="button" class="view-toggle-btn active" data-view="table" title="Table view">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <rect x="1" y="1" width="14" height="3" rx="0.5"/>
                                    <rect x="1" y="6" width="14" height="3" rx="0.5"/>
                                    <rect x="1" y="11" width="14" height="3" rx="0.5"/>
                                </svg>
                            </button>
                        </div>
                        <button class="btn btn-primary" id="newPromptButton">New Prompt</button>
                    </div>
                </div>
                <!-- Active Filters Pills -->
                <div id="activeFiltersContainer" class="prompt-active-filters" style="display: none;">
                    <span class="prompt-active-filters-label">Filters:</span>
                    <div id="activeFiltersPills" class="prompt-filter-pills"></div>
                    <button class="prompt-clear-filters-btn" onclick="window.PromptFilters.clearAllFilters()">Clear all</button>
                </div>
                
                <!-- Filter Dropdown (triggered by clicking column headers) -->
                <div id="columnFilterDropdown" class="prompt-filter-dropdown" style="display: none;">
                    <div class="prompt-filter-dropdown-header">
                        <span id="filterDropdownTitle">Filter by</span>
                        <button class="prompt-filter-dropdown-close" onclick="window.PromptFilters.closeFilterDropdown()">&times;</button>
                    </div>
                    <div class="prompt-filter-dropdown-search">
                        <input type="text" id="filterSearchInput" placeholder="Search..." oninput="window.PromptFilters.filterDropdownOptions()">
                    </div>
                    <div class="prompt-filter-dropdown-options" id="filterDropdownOptions"></div>
                </div>
                
                <div id="statusMessage" class="status-message"></div>
                <div id="promptsContainer" class="domains-grid"></div>
            </div>
        </main>
    </div>

    <div id="modalBackdrop" class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <header style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="modalTitle">New Prompt</h2>
                <button type="button" id="modalCloseButton" data-modal-close style="background: none; border: none; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center;" title="Close">
                    <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/close_button.png" alt="Close" width="24" height="24">
                </button>
            </header>
            <form id="promptForm" style="max-height: calc(92vh - 180px); overflow-y: auto;">
                <div class="form-group">
                    <label for="nameInput">Name</label>
                    <input type="text" id="nameInput" placeholder="e.g., summarize-data, generate-headlines" required>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Human-readable identifier for the prompt</p>
                </div>
                <div class="form-group">
                    <label for="versionInput">Version</label>
                    <input type="number" id="versionInput" placeholder="1" min="1" required>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Version number for this prompt</p>
                </div>
                <div class="form-group">
                    <label for="promptTypeInput">Prompt Type</label>
                    <select id="promptTypeInput" required>
                        <option value="system" selected>System Prompt</option>
                        <option value="helper">Helper Prompt</option>
                    </select>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">System prompts are main prompts, helper prompts provide additional instructions</p>
                </div>
                <div class="form-group">
                    <label for="promptPurposeInput">Purpose</label>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <select id="promptPurposeInput" required style="flex: 1;">
                            <option value="">Select purpose...</option>
                            <option value="summarize">Summarize</option>
                            <option value="headlines">Headlines</option>
                            <option value="ux-fixes">UX Fixes</option>
                            <option value="risk-reversal">Risk Reversal</option>
                            <option value="microcopy">Microcopy</option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="addPurposeButton" style="padding: 12px 16px; white-space: nowrap; display: flex; align-items: center; justify-content: center;" title="Add new purpose">
                            <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/add.png" alt="Add new purpose" width="20" height="20">
                        </button>
                        <button type="button" class="btn btn-secondary" id="managePurposesButton" style="padding: 12px 16px; white-space: nowrap; display: flex; align-items: center; justify-content: center;" title="Manage purposes">
                            <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/edit.png" alt="Manage purposes" width="20" height="20">
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="statusInput">Status</label>
                    <select id="statusInput" required>
                        <option value="test">Test</option>
                        <option value="live">Live</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="clientFacingInput" style="width: auto; margin: 0;">
                        <span>Client Facing</span>
                    </label>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">If checked, this prompt will appear in the AI Expert menu</p>
                </div>
                <div class="form-group" id="allClientsGroup" style="display: none;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="allClientsInput" style="width: auto; margin: 0;" checked>
                        <span>All Clients</span>
                    </label>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">If checked, this prompt is available to all clients. If unchecked, select specific clients below.</p>
                </div>
                <div class="form-group" id="clientSelectionGroup" style="display: none;">
                    <label>Select Clients</label>
                    <div id="clientIdsContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: var(--bg);">
                        <!-- Client checkboxes will be populated by JavaScript -->
                    </div>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Select which clients can access this prompt in the AI Expert menu</p>
                </div>
                <div class="form-group">
                    <label for="llmModelInput">LLM Model</label>
                    <select id="llmModelInput" required>
                        <optgroup label="OpenAI">
                            <option value="gpt-4o">GPT-4o</option>
                            <option value="gpt-4o-mini" selected>GPT-4o Mini</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="o1-preview">O1 Preview</option>
                            <option value="o1-mini">O1 Mini</option>
                        </optgroup>
                        <optgroup label="Anthropic">
                            <option value="claude-sonnet-4-5-20250929" selected>Claude Sonnet 4.5 (Latest)</option>
                            <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                            <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                            <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                            <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                        </optgroup>
                    </select>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Select the LLM model to use for this prompt</p>
                </div>
                <div class="form-group" id="systemMessageGroup">
                    <label for="systemMessageInput">System Message</label>
                    <textarea id="systemMessageInput" placeholder="Enter the system prompt text here..." style="width: 100%; min-height: 300px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.6; box-sizing: border-box;"></textarea>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">The system message that will be sent to the LLM (required for system prompts)</p>
                </div>
                <div class="form-group" id="helperPromptGroup" style="display: none;">
                    <label for="helperPromptSelect">Helper Prompt</label>
                    <select id="helperPromptSelect" style="width: 100%;">
                        <option value="">None</option>
                    </select>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Select a helper prompt to append to the user message (optional)</p>
                </div>
                <div class="form-group" id="promptMessageGroup" style="display: none;">
                    <label for="promptMessageInput">Prompt Message</label>
                    <textarea id="promptMessageInput" placeholder="Enter the helper prompt message here..." style="width: 100%; min-height: 300px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.6; box-sizing: border-box;"></textarea>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">The prompt message that will be appended to the user message (required for helper prompts)</p>
                </div>
                <div class="form-group" id="userMessageGroup">
                    <label for="userMessageInput">Prompt Messages</label>
                    <textarea id="userMessageInput" placeholder="Enter user message (e.g., URL, verbatim JSON, etc.)" style="width: 100%; min-height: 200px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.6; box-sizing: border-box;"></textarea>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">The user input that will be sent with the system message to the LLM (for testing)</p>
                </div>
            </form>
            <div id="addPurposeModal" class="modal-backdrop">
                <div class="modal" style="width: min(450px, 90vw);">
                    <header>
                        <h2>Add New Purpose</h2>
                    </header>
                    <form id="addPurposeForm" style="padding: 32px;">
                        <div class="form-group">
                            <label for="newPurposeInput">Purpose Name</label>
                            <input type="text" id="newPurposeInput" placeholder="e.g., email-copy, social-media" required style="text-transform: lowercase;">
                            <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Use lowercase with hyphens (e.g., email-copy)</p>
                        </div>
                    </form>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancelAddPurposeButton" type="button">Cancel</button>
                        <button class="btn btn-primary" id="savePurposeButton" type="button">Add Purpose</button>
                    </div>
                </div>
            </div>
            <div id="managePurposesModal" class="modal-backdrop">
                <div class="modal" style="width: min(500px, 90vw);">
                    <header>
                        <h2>Manage Custom Purposes</h2>
                    </header>
                    <div style="padding: 32px;">
                        <div id="purposesList" style="margin-bottom: 24px;">
                            <!-- Custom purposes will be listed here -->
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancelManagePurposesButton" type="button">Close</button>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="deletePromptButton" type="button" style="display: none; padding: 12px 16px; white-space: nowrap;" title="Delete prompt">
                    <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/delete_button.png" alt="Delete" width="20" height="20" style="margin-right: 8px;">
                    <span>Delete</span>
                </button>
                <button class="btn btn-secondary" id="versionHistoryButton" type="button" style="display: none; padding: 12px 16px; white-space: nowrap;" title="View version history">
                    <span>Version History</span>
                </button>
                <div class="split-button-container" style="margin-left: auto; display: flex; gap: 0;">
                    <button class="btn btn-primary split-button-main" id="saveAndRunButton" type="button">Save and Run</button>
                    <button class="btn btn-primary split-button-dropdown" id="saveButtonDropdown" type="button" aria-label="More options">▼</button>
                    <div class="split-button-dropdown-menu" id="saveButtonMenu">
                        <button class="split-button-dropdown-menu-item" id="saveChangesButton" type="button">Save and Close</button>
                        <button class="split-button-dropdown-menu-item" id="newVersionButton" type="button" style="display: none;">New Version</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Version History Modal (separate from main modal to avoid nesting issues) -->
    <div id="versionHistoryModal" class="modal-backdrop">
        <div class="modal" style="width: min(700px, 90vw);">
            <header>
                <h2 id="versionHistoryTitle">Version History</h2>
            </header>
            <div style="padding: 24px;">
                <div id="versionHistoryList" class="version-history-list">
                    <!-- Version history items will be listed here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="closeVersionHistoryButton" type="button">Close</button>
            </div>
        </div>
    </div>

    <!-- Slideout Panel for Prompt Results -->
    <div id="slideoutPanel" class="ai-insights-panel">
        <div class="ai-insights-header">
            <button id="slideoutExpandButton" class="slideout-expand-btn" title="Expand slideout">
                <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/insights/1767922251837-rvam8.png" alt="Expand" width="20" height="20">
            </button>
            <div style="flex: 1;">
                <div id="slideoutTitle" data-slideout-title style="font-size: 1.5rem; font-weight: 600; font-family: 'Lato', sans-serif; color: oklch(0.145 0 0);">LLM Outputs</div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="filter-menu" style="position: relative;">
                    <button id="promptFiltersBtn" class="filter-button" type="button" aria-label="Open filters" data-filter-button style="display: none;">
                        <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/filter_list.svg" alt="" aria-hidden="true">
                        <span id="promptFilterBadge" class="filter-badge" data-filter-badge aria-hidden="true"></span>
                    </button>
                    <div id="promptFiltersDropdown" class="filter-dropdown" data-filter-dropdown style="display: none; position: absolute; top: 100%; right: 0px; margin-top: 8px; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 350px; max-width: 450px; z-index: 1000; max-height: 500px; overflow-y: auto;">
                        <!-- Filter Type Selection View -->
                        <div id="promptFilterTypeView" style="display: block;">
                            <div style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;">
                                <strong style="font-size: 14px;">Filter By</strong>
                                <button id="clearAllPromptFilters" style="padding: 4px 8px; background: transparent; border: none; color: #667eea; cursor: pointer; font-size: 12px; font-weight: 500;">Clear All</button>
                            </div>
                            <div id="promptFilterTypeList" style="padding: 8px;">
                                <!-- Filter types will be dynamically populated here -->
                            </div>
                            <div id="activePromptFiltersList" style="padding: 8px 12px; border-top: 1px solid #e0e0e0; background: #f8f9fa; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        
                        <!-- Filter Selection View (for prompts or versions) -->
                        <div id="promptFilterSelectionView" style="display: none;">
                            <div style="padding: 12px 16px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <button id="backToPromptFilterType" style="padding: 4px 8px; background: transparent; border: none; color: #667eea; cursor: pointer; font-size: 16px; font-weight: 500;">←</button>
                                    <strong id="promptFilterSelectionTitle" style="font-size: 14px;">Select Items</strong>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button id="selectAllPromptItems" style="padding: 4px 8px; background: transparent; border: none; color: #667eea; cursor: pointer; font-size: 12px; font-weight: 500;">Select All</button>
                                    <button id="clearAllPromptItems" style="padding: 4px 8px; background: transparent; border: none; color: #667eea; cursor: pointer; font-size: 12px; font-weight: 500;">Clear All</button>
                                </div>
                            </div>
                            <div id="promptFilterSelectionList" style="padding: 8px; max-height: 350px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
                <button id="closeSlideoutPanel" class="ai-close-btn" data-slideout-close>&times;</button>
            </div>
        </div>
        <div id="slideoutContent" class="ai-insights-content" data-slideout-content>
            <!-- Content loaded dynamically -->
            <button id="slideoutToTopButton" class="slideout-to-top-btn" title="Scroll to top" style="display: none;">
                <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/insights/1767671630805-s0jbg.png" alt="To top" width="24" height="24">
            </button>
        </div>
        <div class="ai-insights-chat">
            <div class="chat-input-container">
                <textarea id="slideoutChatInput" class="chat-input" placeholder="Enter prompt message (e.g., URL, verbatim JSON, etc.)..." rows="2"></textarea>
                <button id="slideoutChatSend" class="chat-send-btn" title="Send">
                    <img src="https://neeuv3c4wu4qzcdw.public.blob.vercel-storage.com/icons/send_icon.png" alt="Send" width="20" height="20" id="slideoutChatSendIcon">
                </button>
            </div>
        </div>
    </div>
    
    <div id="slideoutOverlay" class="ai-insights-overlay"></div>
    
    <script>
        // Fix: Prevent browser tab navigation when Option+Arrow is used in text inputs
        // On macOS, Option+ArrowLeft/Right is a browser shortcut for tab switching,
        // but users expect it to work for word-by-word navigation in text inputs
        // We intercept this and manually implement word navigation to prevent tab switching
        (function() {
            const handleOptionArrow = (e) => {
                // Only handle Option+Arrow (not Command+Arrow, which should still switch tabs)
                if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && e.altKey && !e.metaKey && !e.ctrlKey && !e.shiftKey) {
                    const target = e.target;
                    const isTextInput = target.tagName === 'INPUT' || 
                                       target.tagName === 'TEXTAREA' || 
                                       target.contentEditable === 'true' ||
                                       target.isContentEditable;
                    
                    // If user is in a text input, prevent browser's tab navigation and implement word navigation
                    if (isTextInput) {
                        e.stopImmediatePropagation();
                        e.preventDefault();
                        
                        // Helper function to find word boundaries using regex
                        const findWordBoundary = (text, pos, direction) => {
                            // Word boundary regex: word characters (letters, digits, underscore) are words
                            // Everything else (spaces, punctuation) are separators
                            if (direction === 'left') {
                                // Move left to find start of previous word
                                if (pos <= 0) return 0;
                                
                                // Skip any whitespace/punctuation to the left
                                let i = pos - 1;
                                while (i >= 0 && !/\w/.test(text[i])) {
                                    i--;
                                }
                                
                                // Now find the start of the word
                                while (i >= 0 && /\w/.test(text[i])) {
                                    i--;
                                }
                                
                                return i + 1;
                            } else {
                                // Move right to find start of next word
                                if (pos >= text.length) return text.length;
                                
                                // Skip current word if we're in the middle of one
                                let i = pos;
                                while (i < text.length && /\w/.test(text[i])) {
                                    i++;
                                }
                                
                                // Skip whitespace/punctuation
                                while (i < text.length && !/\w/.test(text[i])) {
                                    i++;
                                }
                                
                                return i;
                            }
                        };
                        
                        // Manually implement word-by-word navigation
                        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
                            const input = target;
                            const start = input.selectionStart;
                            const end = input.selectionEnd;
                            const text = input.value;
                            
                            let newPos;
                            if (e.key === 'ArrowLeft') {
                                newPos = findWordBoundary(text, start, 'left');
                            } else {
                                newPos = findWordBoundary(text, end, 'right');
                            }
                            
                            input.setSelectionRange(newPos, newPos);
                            input.focus(); // Ensure focus is maintained
                        } else if (target.contentEditable === 'true' || target.isContentEditable) {
                            // For contenteditable, manually find word boundaries in text
                            const selection = window.getSelection();
                            if (selection.rangeCount > 0) {
                                const range = selection.getRangeAt(0);
                                const textNode = range.startContainer;
                                
                                if (textNode.nodeType === Node.TEXT_NODE) {
                                    const text = textNode.textContent;
                                    const offset = range.startOffset;
                                    
                                    let newOffset;
                                    if (e.key === 'ArrowLeft') {
                                        newOffset = findWordBoundary(text, offset, 'left');
                                    } else {
                                        newOffset = findWordBoundary(text, offset, 'right');
                                    }
                                    
                                    range.setStart(textNode, newOffset);
                                    range.setEnd(textNode, newOffset);
                                    selection.removeAllRanges();
                                    selection.addRange(range);
                                } else {
                                    // Fallback: try using execCommand if available
                                    if (document.execCommand) {
                                        try {
                                            if (e.key === 'ArrowLeft') {
                                                document.execCommand('moveWordLeft', false, null);
                                            } else {
                                                document.execCommand('moveWordRight', false, null);
                                            }
                                        } catch (err) {
                                            console.warn('execCommand word navigation not supported');
                                        }
                                    }
                                }
                            }
                        }
                        
                        return false;
                    }
                }
            };
            
            // Register at both window and document level with capture phase for maximum priority
            window.addEventListener('keydown', handleOptionArrow, true);
            document.addEventListener('keydown', handleOptionArrow, true);
        })();
    </script>
</body>
</html>
