<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZHSFGWQMSN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZHSFGWQMSN');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founder Admin - Prompt Engineering</title>
    <script src="/config.js"></script>
    <style>
        :root {
            --bg: #f5f7fb;
            --surface: #ffffff;
            --border: #e2e8f0;
            --border-strong: #cbd5f5;
            --primary: #667eea;
            --primary-dark: #4c51bf;
            --danger: #e53e3e;
            --success: #38a169;
            --text: #1a202c;
            --muted: #718096;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Inter", "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        body.slideout-open {
            overflow: hidden;
        }

        .login-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.85);
            z-index: 999;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-card {
            background: var(--surface);
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(56, 66, 106, 0.35);
            width: min(380px, 92vw);
        }

        .login-card h2 {
            margin-bottom: 12px;
        }

        .login-card p {
            margin-bottom: 16px;
            color: var(--muted);
            font-size: 14px;
            line-height: 1.5;
        }

        .login-card input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 12px;
            transition: border 0.2s;
        }

        .login-card input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.15s, box-shadow 0.2s, background 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: #edf2f7;
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-ghost {
            background: transparent;
            color: var(--primary);
        }

        .btn-ghost:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #appShell {
            display: none;
            min-height: 100vh;
            flex-direction: column;
        }

        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        header h1 {
            font-size: 26px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 14px;
            color: var(--muted);
            margin-top: 6px;
            max-width: 640px;
        }

        .founder-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        #founderEmail {
            font-size: 12px;
            color: var(--muted);
        }

        main {
            flex: 1;
            padding: 32px;
            display: flex;
            justify-content: center;
        }

        .content {
            width: min(1100px, 100%);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .toolbar {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
        }

        .status-message {
            padding: 14px 18px;
            border-radius: 10px;
            font-size: 14px;
            display: none;
        }

        .status-message.success {
            background: #f0fff4;
            border: 1px solid #c6f6d5;
            color: var(--success);
        }

        .status-message.error {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: var(--danger);
        }

        .domains-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .domain-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 20px 45px -24px rgba(15, 23, 42, 0.35);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .domain-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .domain-header h2 {
            font-size: 18px;
            font-weight: 600;
            word-break: break-word;
        }

        .domain-meta {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .description {
            font-size: 14px;
            color: var(--muted);
        }

        .client-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .client-chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: rgba(102, 126, 234, 0.12);
            font-size: 12px;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            color: var(--muted);
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 48px 24px;
            background: rgba(255, 255, 255, 0.7);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 40px 24px;
        }

        .modal-backdrop.visible {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 30px 60px -24px rgba(15, 23, 42, 0.45);
            border: 1px solid var(--border-strong);
            width: min(800px, 95vw);
            max-height: 92vh;
            display: flex;
            flex-direction: column;
        }

        .modal header {
            position: static;
            border-bottom: 1px solid var(--border);
            padding: 24px 32px;
            background: #f7f9ff;
            border-radius: 16px 16px 0 0;
        }

        .modal header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .modal form {
            padding: 32px 32px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--muted);
            margin-bottom: 2px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 200px;
            line-height: 1.6;
        }

        .client-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            max-height: 220px;
            overflow-y: auto;
            padding: 6px 2px;
        }

        .client-option {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 13px;
            padding: 6px 8px;
            border: 1px solid transparent;
            border-radius: 8px;
        }

        .client-option:hover {
            border-color: rgba(102, 126, 234, 0.3);
            background: rgba(102, 126, 234, 0.08);
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 20px 32px;
            border-top: 1px solid var(--border);
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
        }

        .split-button-container {
            display: flex;
            gap: 0;
            position: relative;
        }

        .split-button-main {
            border-radius: 8px 0 0 8px;
            border-right: none;
        }

        .split-button-dropdown {
            border-radius: 0 8px 8px 0;
            padding: 10px 12px;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
        }

        .split-button-dropdown-menu {
            display: none;
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 8px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 160px;
            z-index: 1001;
            overflow: hidden;
        }

        .split-button-dropdown-menu.visible {
            display: block;
        }

        .split-button-dropdown-menu-item {
            display: block;
            width: 100%;
            padding: 10px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .split-button-dropdown-menu-item:hover {
            background: var(--bg);
        }

        .version-selector {
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .version-selector:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Slideout Panel Styles */
        .ai-insights-panel {
            position: fixed;
            right: -520px;
            top: 0;
            width: 500px;
            height: 100vh;
            background: oklch(1 0 0);
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 10001;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            border-top: 3px solid #B9F040;
        }

        .ai-insights-panel.open {
            right: 0;
        }

        .ai-insights-header {
            padding: 1.25rem 1.5rem 1rem 1.5rem;
            border-bottom: 1px solid oklch(0.922 0 0);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: oklch(1 0 0);
            gap: 12px;
        }

        .ai-insights-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            transition: opacity 0.2s ease;
        }

        .ai-close-btn {
            background: none;
            border: none;
            color: oklch(0.556 0 0);
            font-size: 1.75rem;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            font-family: 'Lato', sans-serif;
        }

        .ai-close-btn:hover {
            background: oklch(0.97 0 0);
            color: oklch(0.145 0 0);
        }

        .ai-insights-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .ai-insights-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .prompt-result-content {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-x: auto;
        }

        .prompt-result-metadata {
            margin-bottom: 16px;
            padding: 12px;
            background: #f0f4f8;
            border-radius: 6px;
            font-size: 13px;
            color: var(--muted);
        }

        .ai-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .ai-loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e4e6eb;
            border-top-color: #b9f040;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .founder-meta {
                align-items: flex-start;
            }

            main {
                padding: 24px;
            }

            .domains-grid {
                grid-template-columns: 1fr;
            }

            .ai-insights-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <h2>Founder Login</h2>
            <p>Use your founder email to manage prompts and version control.</p>
            <div id="loginError" class="status-message error" style="display: none;"></div>
            <input type="email" id="loginEmail" placeholder="founder@example.com" autocomplete="email">
            <input type="password" id="loginPassword" placeholder="Password (if configured)" autocomplete="current-password">
            <button class="btn btn-primary" id="loginButton">Login</button>
        </div>
    </div>

    <div id="appShell">
        <header>
            <div>
                <h1>Prompt Engineering</h1>
                <div class="subtitle">
                    Manage system prompts for transforming insights into actions with version control.
                </div>
            </div>
            <div class="founder-meta">
                <span id="founderEmail"></span>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" id="refreshButton">Refresh</button>
                    <button class="btn btn-ghost" id="logoutButton">Logout</button>
                </div>
            </div>
        </header>
        <main>
            <div class="content">
                <div class="toolbar">
                    <div>
                        <h2 style="font-size: 18px; font-weight: 600;">Prompts</h2>
                        <p style="font-size: 14px; color: var(--muted); margin-top: 6px;">
                            Create and manage system prompts with version control for transforming insights into actions.
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="statusFilter" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                            <option value="">All Statuses</option>
                            <option value="live">Live</option>
                            <option value="test">Test</option>
                            <option value="archived">Archived</option>
                        </select>
                        <select id="purposeFilter" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                            <option value="">All Purposes</option>
                            <option value="summarize">Summarize</option>
                            <option value="headlines">Headlines</option>
                            <option value="ux-fixes">UX Fixes</option>
                            <option value="risk-reversal">Risk Reversal</option>
                            <option value="microcopy">Microcopy</option>
                        </select>
                        <button class="btn btn-primary" id="newPromptButton">New Prompt</button>
                    </div>
                </div>
                <div id="statusMessage" class="status-message"></div>
                <div id="promptsContainer" class="domains-grid"></div>
            </div>
        </main>
    </div>

    <div id="modalBackdrop" class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <header>
                <h2 id="modalTitle">New Prompt</h2>
            </header>
            <form id="promptForm" style="max-height: calc(92vh - 180px); overflow-y: auto;">
                <div class="form-group">
                    <label for="nameInput">Name</label>
                    <input type="text" id="nameInput" placeholder="e.g., summarize-data, generate-headlines" required>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Human-readable identifier for the prompt</p>
                </div>
                <div class="form-group">
                    <label for="versionInput">Version</label>
                    <input type="number" id="versionInput" placeholder="1" min="1" required>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Version number for this prompt</p>
                </div>
                <div class="form-group">
                    <label for="promptPurposeInput">Purpose</label>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <select id="promptPurposeInput" required style="flex: 1;">
                            <option value="">Select purpose...</option>
                            <option value="summarize">Summarize</option>
                            <option value="headlines">Headlines</option>
                            <option value="ux-fixes">UX Fixes</option>
                            <option value="risk-reversal">Risk Reversal</option>
                            <option value="microcopy">Microcopy</option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="addPurposeButton" style="padding: 12px 16px; white-space: nowrap;" title="Add new purpose">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="statusInput">Status</label>
                    <select id="statusInput" required>
                        <option value="test">Test</option>
                        <option value="live">Live</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="llmModelInput">LLM Model</label>
                    <input type="text" id="llmModelInput" placeholder="gpt-4o-mini" value="gpt-4o-mini" required>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Model identifier (e.g., gpt-4o-mini, gpt-4)</p>
                </div>
                <div class="form-group">
                    <label for="systemMessageInput">System Message</label>
                    <textarea id="systemMessageInput" placeholder="Enter the system prompt text here..." style="min-height: 300px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.6;" required></textarea>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">The system message that will be sent to the LLM</p>
                </div>
                <div class="form-group">
                    <label for="userMessageInput">Prompt Messages</label>
                    <textarea id="userMessageInput" placeholder="Enter user message (e.g., URL, verbatim JSON, etc.)" style="min-height: 200px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.6;"></textarea>
                    <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">The user input that will be sent with the system message to the LLM</p>
                </div>
            </form>
            <div id="addPurposeModal" class="modal-backdrop" style="display: none;">
                <div class="modal" style="width: min(450px, 90vw);">
                    <header>
                        <h2>Add New Purpose</h2>
                    </header>
                    <form id="addPurposeForm" style="padding: 32px;">
                        <div class="form-group">
                            <label for="newPurposeInput">Purpose Name</label>
                            <input type="text" id="newPurposeInput" placeholder="e.g., email-copy, social-media" required style="text-transform: lowercase;">
                            <p style="font-size: 12px; color: var(--muted); margin-top: 4px;">Use lowercase with hyphens (e.g., email-copy)</p>
                        </div>
                    </form>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancelAddPurposeButton" type="button">Cancel</button>
                        <button class="btn btn-primary" id="savePurposeButton" type="button">Add Purpose</button>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="newVersionButton" type="button" style="display: none;">New Version</button>
                    <button class="btn btn-secondary" id="cancelModalButton" type="button">Cancel</button>
                </div>
                <div class="split-button-container">
                    <button class="btn btn-primary split-button-main" id="saveAndRunButton" type="button">Save and Run</button>
                    <button class="btn btn-primary split-button-dropdown" id="saveButtonDropdown" type="button" aria-label="More options">▼</button>
                    <div class="split-button-dropdown-menu" id="saveButtonMenu">
                        <button class="split-button-dropdown-menu-item" id="saveChangesButton" type="button">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Slideout Panel for Prompt Results -->
    <div id="slideoutPanel" class="ai-insights-panel">
        <div class="ai-insights-header">
            <div style="flex: 1;">
                <div id="slideoutTitle" style="font-size: 1.5rem; font-weight: 600; font-family: 'Lato', sans-serif; color: oklch(0.145 0 0);">Prompt Execution Results</div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <button id="closeSlideoutPanel" class="ai-close-btn">&times;</button>
            </div>
        </div>
        <div id="slideoutContent" class="ai-insights-content">
            <!-- Content loaded dynamically -->
        </div>
    </div>
    
    <div id="slideoutOverlay" class="ai-insights-overlay"></div>

    <script>
        const API_BASE_URL = window.APP_CONFIG?.API_BASE_URL || 'http://localhost:8000';
        const AUTH_TOKEN_KEY = 'visualizd_auth_token';

        // Initialize elements with debugging
        function getElement(id, required = true) {
            const el = document.getElementById(id);
            if (required && !el) {
                console.error(`[DEBUG] Required element not found: #${id}`);
            } else if (!el) {
                console.warn(`[DEBUG] Optional element not found: #${id}`);
            } else {
                console.log(`[DEBUG] Element found: #${id}`);
            }
            return el;
        }

        const elements = {
            loginOverlay: getElement('loginOverlay'),
            loginEmail: getElement('loginEmail'),
            loginPassword: getElement('loginPassword'),
            loginButton: getElement('loginButton'),
            loginError: getElement('loginError'),
            appShell: getElement('appShell'),
            founderEmail: getElement('founderEmail'),
            logoutButton: getElement('logoutButton'),
            refreshButton: getElement('refreshButton'),
            newPromptButton: getElement('newPromptButton'),
            statusMessage: getElement('statusMessage'),
            promptsContainer: getElement('promptsContainer'),
            statusFilter: getElement('statusFilter'),
            purposeFilter: getElement('purposeFilter'),
            modalBackdrop: getElement('modalBackdrop'),
            modalTitle: getElement('modalTitle'),
            promptForm: getElement('promptForm'),
            nameInput: getElement('nameInput'),
            versionInput: getElement('versionInput'),
            promptPurposeInput: getElement('promptPurposeInput'),
            statusInput: getElement('statusInput'),
            llmModelInput: getElement('llmModelInput'),
            systemMessageInput: getElement('systemMessageInput'),
            userMessageInput: getElement('userMessageInput'),
            cancelModalButton: getElement('cancelModalButton'),
            submitPromptButton: getElement('submitPromptButton', false),
            addPurposeButton: getElement('addPurposeButton'),
            addPurposeModal: getElement('addPurposeModal'),
            newPurposeInput: getElement('newPurposeInput'),
            cancelAddPurposeButton: getElement('cancelAddPurposeButton'),
            savePurposeButton: getElement('savePurposeButton'),
            saveAndRunButton: getElement('saveAndRunButton'),
            saveButtonDropdown: getElement('saveButtonDropdown'),
            saveButtonMenu: getElement('saveButtonMenu'),
            saveChangesButton: getElement('saveChangesButton'),
            newVersionButton: getElement('newVersionButton'),
            slideoutPanel: getElement('slideoutPanel'),
            slideoutOverlay: getElement('slideoutOverlay'),
            slideoutContent: getElement('slideoutContent'),
            slideoutTitle: getElement('slideoutTitle'),
            closeSlideoutPanel: getElement('closeSlideoutPanel'),
        };

        console.log('[DEBUG] Elements initialization complete');

        const state = {
            founder: null,
            prompts: [],
            currentMode: 'create',
            currentPromptId: null,
            actionMode: 'save-and-run', // 'save-and-run' or 'save-only'
        };

        const getAuthToken = () => localStorage.getItem(AUTH_TOKEN_KEY);
        const setAuthToken = (token) => localStorage.setItem(AUTH_TOKEN_KEY, token);
        const clearAuth = () => localStorage.removeItem(AUTH_TOKEN_KEY);

        const authHeaders = () => {
            const token = getAuthToken();
            return token
                ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                : { 'Content-Type': 'application/json' };
        };

        function showLoginError(message) {
            if (!message) {
                elements.loginError.style.display = 'none';
                elements.loginError.textContent = '';
                return;
            }
            elements.loginError.textContent = message;
            elements.loginError.style.display = 'block';
        }

        function showStatus(message, type = 'success') {
            if (!message) {
                elements.statusMessage.style.display = 'none';
                elements.statusMessage.textContent = '';
                elements.statusMessage.classList.remove('success', 'error');
                return;
            }
            elements.statusMessage.textContent = message;
            elements.statusMessage.style.display = 'block';
            elements.statusMessage.classList.remove('success', 'error');
            elements.statusMessage.classList.add(type);
        }

        async function validateFounderSession() {
            const response = await fetch(`${API_BASE_URL}/api/auth/me`, {
                headers: authHeaders(),
            });
            if (!response.ok) {
                throw new Error('Could not validate founder session.');
            }
            const data = await response.json();
            if (!data.is_founder) {
                throw new Error('Access denied: founder privileges required.');
            }
            state.founder = data;
            return data;
        }

        function renderFounderInfo() {
            if (state.founder?.email) {
                elements.founderEmail.textContent = state.founder.email;
            } else {
                elements.founderEmail.textContent = '';
            }
        }

        function showAppShell() {
            elements.loginOverlay.classList.add('hidden');
            elements.appShell.style.display = 'flex';
            renderFounderInfo();
        }

        function resetLoginForm() {
            elements.loginButton.disabled = false;
            elements.loginButton.textContent = 'Login';
        }

        async function loginFounder() {
            const email = elements.loginEmail.value.trim();
            const password = elements.loginPassword.value;

            if (!email) {
                showLoginError('Please enter your founder email.');
                return;
            }

            elements.loginButton.disabled = true;
            elements.loginButton.textContent = 'Logging in...';
            showLoginError();

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Login failed');
                }

                const data = await response.json();
                setAuthToken(data.access_token);

                await validateFounderSession();
                showAppShell();
                await loadInitialData();
            } catch (error) {
                console.error('Founder login failed', error);
                showLoginError(error.message || 'Unable to log in.');
                clearAuth();
            } finally {
                resetLoginForm();
            }
        }

        function logout() {
            clearAuth();
            state.founder = null;
            state.domains = [];
            state.clients = [];
            window.location.href = 'https://marketably.ai';
        }

        async function attemptExistingSession() {
            const token = getAuthToken();
            if (!token) return false;
            try {
                await validateFounderSession();
                showAppShell();
                await loadInitialData();
                return true;
            } catch (error) {
                console.warn('Existing founder session invalid', error);
                clearAuth();
                return false;
            }
        }

        async function loadInitialData() {
            showStatus('Loading prompts…', 'success');
            try {
                await loadPrompts();
                showStatus();
            } catch (error) {
                console.error('Failed to load initial data', error);
                showStatus(error.message || 'Unable to load data.', 'error');
            }
        }

        async function loadPrompts() {
            const statusFilter = elements.statusFilter.value;
            const purposeFilter = elements.purposeFilter.value;
            let url = `${API_BASE_URL}/api/founder/prompts?`;
            const params = new URLSearchParams();
            if (statusFilter) params.append('status', statusFilter);
            if (purposeFilter) params.append('prompt_purpose', purposeFilter);
            url += params.toString();

            const response = await fetch(url, {
                headers: authHeaders(),
            });
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }
                throw new Error('Failed to load prompts.');
            }
            state.prompts = await response.json();
            renderPrompts();
        }

        function renderPrompts() {
            if (!state.prompts.length) {
                elements.promptsContainer.innerHTML = `
                    <div class="empty-state">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No prompts yet</h3>
                        <p style="font-size: 14px;">Create your first prompt to start transforming insights into actions.</p>
                    </div>
                `;
                return;
            }

            // Group prompts by name to show version history
            const promptsByName = {};
            state.prompts.forEach(prompt => {
                if (!promptsByName[prompt.name]) {
                    promptsByName[prompt.name] = [];
                }
                promptsByName[prompt.name].push(prompt);
            });

            elements.promptsContainer.innerHTML = Object.entries(promptsByName)
                .map(([name, versions]) => {
                    const sortedVersions = versions.sort((a, b) => b.version - a.version);
                    const latest = sortedVersions[0];
                    const versionCount = versions.length;
                    const statusBadge = `<span class="client-chip" style="background: ${latest.status === 'live' ? '#f0fff4' : latest.status === 'test' ? '#fffbf0' : '#f7fafc'}; border-color: ${latest.status === 'live' ? '#c6f6d5' : latest.status === 'test' ? '#fbd38d' : '#e2e8f0'}; color: ${latest.status === 'live' ? '#22543d' : latest.status === 'test' ? '#744210' : '#4a5568'};">${latest.status.toUpperCase()}</span>`;
                    const updatedAt = latest.updated_at ? new Date(latest.updated_at).toLocaleString() : 'Unknown';
                    const createdAt = latest.created_at ? new Date(latest.created_at).toLocaleDateString() : 'Unknown';
                    const purposeChip = `<span class="client-chip">${latest.prompt_purpose}</span>`;
                    const modelChip = `<span class="client-chip" style="background: #edf2f7; border-color: #cbd5e0; color: #4a5568;">${latest.llm_model}</span>`;

                    // Build version selector if multiple versions exist
                    let versionSelector = '';
                    if (versionCount > 1) {
                        const versionOptions = sortedVersions.map(v => 
                            `<option value="${v.id}" ${v.id === latest.id ? 'selected' : ''}>v${v.version} - ${v.status}${v.updated_at ? ' (' + new Date(v.updated_at).toLocaleDateString() + ')' : ''}</option>`
                        ).join('');
                        versionSelector = `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <label style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); display: block; margin-bottom: 6px;">Version History</label>
                                <select class="version-selector" data-prompt-name="${name}" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: white;">
                                    ${versionOptions}
                                </select>
                            </div>
                        `;
                    }

                    return `
                        <article class="domain-card" data-prompt-name="${name}">
                            <div class="domain-header">
                                <div>
                                    <h2>${name}</h2>
                                    <div class="domain-meta">
                                        <span>Version ${latest.version}${versionCount > 1 ? ` (${versionCount} versions)` : ''}</span>
                                        <span>Created ${createdAt}</span>
                                        <span>Updated ${updatedAt}</span>
                                    </div>
                                </div>
                                <button class="btn btn-secondary" data-action="edit-prompt" data-prompt-id="${latest.id}">Edit</button>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                                ${statusBadge} ${purposeChip} ${modelChip}
                            </div>
                            <div class="description" style="font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto; background: #f7fafc; padding: 8px; border-radius: 6px; white-space: pre-wrap; word-break: break-word;">${latest.system_message.substring(0, 200)}${latest.system_message.length > 200 ? '...' : ''}</div>
                            ${versionSelector}
                        </article>
                    `;
                })
                .join('');

            elements.promptsContainer.querySelectorAll('[data-action="edit-prompt"]').forEach((button) => {
                button.addEventListener('click', () => {
                    const promptId = button.getAttribute('data-prompt-id');
                    openPromptModal('edit', promptId);
                });
            });

            // Add event listeners for version selectors
            elements.promptsContainer.querySelectorAll('.version-selector').forEach((select) => {
                select.addEventListener('change', (e) => {
                    const promptId = e.target.value;
                    openPromptModal('edit', promptId);
                });
            });
        }

        function loadCustomPurposes() {
            const customPurposes = JSON.parse(localStorage.getItem('customPromptPurposes') || '[]');
            const existingOptions = Array.from(elements.promptPurposeInput.options).map(opt => opt.value);
            
            customPurposes.forEach(purpose => {
                if (purpose && !existingOptions.includes(purpose)) {
                    const option = document.createElement('option');
                    option.value = purpose;
                    option.textContent = purpose.split('-').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    elements.promptPurposeInput.appendChild(option);
                }
            });
        }

        function addCustomPurpose(purpose) {
            if (!purpose) return;
            
            // Normalize to lowercase with hyphens
            const normalizedPurpose = purpose.toLowerCase().trim().replace(/\s+/g, '-');
            
            // Get existing custom purposes
            const customPurposes = JSON.parse(localStorage.getItem('customPromptPurposes') || '[]');
            
            // Add if not already present
            if (!customPurposes.includes(normalizedPurpose)) {
                customPurposes.push(normalizedPurpose);
                localStorage.setItem('customPromptPurposes', JSON.stringify(customPurposes));
                
                // Add to dropdown if not already there
                const existingOptions = Array.from(elements.promptPurposeInput.options).map(opt => opt.value);
                if (!existingOptions.includes(normalizedPurpose)) {
                    const option = document.createElement('option');
                    option.value = normalizedPurpose;
                    option.textContent = normalizedPurpose.split('-').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    elements.promptPurposeInput.appendChild(option);
                }
            }
            
            // Select the new purpose
            elements.promptPurposeInput.value = normalizedPurpose;
        }

        function openPromptModal(mode, promptId = null) {
            state.currentMode = mode;
            state.currentPromptId = promptId;
            elements.promptForm.reset();
            
            // Reload custom purposes
            loadCustomPurposes();

            if (mode === 'edit' && promptId) {
                const prompt = state.prompts.find((item) => item.id === promptId);
                if (!prompt) {
                    showStatus('Selected prompt could not be found.', 'error');
                    return;
                }
                elements.modalTitle.textContent = `Edit ${prompt.name} (v${prompt.version})`;
                elements.nameInput.value = prompt.name;
                elements.versionInput.value = prompt.version;
                elements.promptPurposeInput.value = prompt.prompt_purpose;
                elements.statusInput.value = prompt.status;
                elements.llmModelInput.value = prompt.llm_model;
                elements.systemMessageInput.value = prompt.system_message;
                elements.userMessageInput.value = ''; // User message is not stored, always empty
                
                // Show "New Version" button when editing
                if (elements.newVersionButton) {
                    elements.newVersionButton.style.display = 'block';
                }
            } else {
                elements.modalTitle.textContent = 'New Prompt';
                elements.nameInput.value = '';
                elements.versionInput.value = '1';
                elements.promptPurposeInput.value = '';
                elements.statusInput.value = 'test';
                elements.llmModelInput.value = 'gpt-4o-mini';
                elements.systemMessageInput.value = '';
                elements.userMessageInput.value = '';
                
                // Hide "New Version" button when creating new prompt
                if (elements.newVersionButton) {
                    elements.newVersionButton.style.display = 'none';
                }
            }

            state.actionMode = 'save-and-run';
            elements.modalBackdrop.classList.add('visible');
            setTimeout(() => elements.nameInput.focus(), 50);
        }

        function openAddPurposeModal() {
            elements.newPurposeInput.value = '';
            elements.addPurposeModal.style.display = 'flex';
            setTimeout(() => elements.newPurposeInput.focus(), 50);
        }

        function closeAddPurposeModal() {
            elements.addPurposeModal.style.display = 'none';
            elements.newPurposeInput.value = '';
        }

        function handleAddPurpose() {
            const newPurpose = elements.newPurposeInput.value.trim();
            if (!newPurpose) {
                showStatus('Please enter a purpose name.', 'error');
                return;
            }
            
            addCustomPurpose(newPurpose);
            closeAddPurposeModal();
            showStatus('Purpose added successfully.', 'success');
            setTimeout(() => showStatus(), 2000);
        }

        function closePromptModal() {
            state.currentMode = 'create';
            state.currentPromptId = null;
            elements.modalBackdrop.classList.remove('visible');
            if (elements.newVersionButton) {
                elements.newVersionButton.style.display = 'none';
            }
        }

        function createNewVersion() {
            if (!state.currentPromptId) {
                showStatus('No prompt selected to create version from.', 'error');
                return;
            }

            const currentPrompt = state.prompts.find((item) => item.id === state.currentPromptId);
            if (!currentPrompt) {
                showStatus('Current prompt could not be found.', 'error');
                return;
            }

            // Find the highest version for this prompt name
            const sameNamePrompts = state.prompts.filter(p => p.name === currentPrompt.name);
            const maxVersion = Math.max(...sameNamePrompts.map(p => p.version));
            const newVersion = maxVersion + 1;

            // Pre-fill form with current prompt data but with new version
            elements.modalTitle.textContent = `New Version: ${currentPrompt.name} (v${newVersion})`;
            elements.nameInput.value = currentPrompt.name;
            elements.versionInput.value = newVersion;
            elements.promptPurposeInput.value = currentPrompt.prompt_purpose;
            elements.statusInput.value = 'test'; // New versions start as test
            elements.llmModelInput.value = currentPrompt.llm_model;
            elements.systemMessageInput.value = currentPrompt.system_message;
            elements.userMessageInput.value = '';

            // Change mode to create
            state.currentMode = 'create';
            state.currentPromptId = null;
            
            // Hide "New Version" button since we're now creating
            if (elements.newVersionButton) {
                elements.newVersionButton.style.display = 'none';
            }
        }

        async function handlePromptFormSubmit(event) {
            event.preventDefault();
            await savePrompt(state.actionMode === 'save-and-run');
        }

        async function savePrompt(shouldExecute = false) {
            elements.saveAndRunButton.disabled = true;
            elements.saveChangesButton.disabled = true;
            
            const nameValue = elements.nameInput.value.trim();
            const versionValue = parseInt(elements.versionInput.value);
            const promptPurposeValue = elements.promptPurposeInput.value;
            const statusValue = elements.statusInput.value;
            const llmModelValue = elements.llmModelInput.value.trim();
            const systemMessageValue = elements.systemMessageInput.value.trim();

            if (!nameValue || !promptPurposeValue || !systemMessageValue || !llmModelValue) {
                showStatus('All required fields must be filled.', 'error');
                elements.saveAndRunButton.disabled = false;
                elements.saveChangesButton.disabled = false;
                return;
            }

            if (isNaN(versionValue) || versionValue < 1) {
                showStatus('Version must be a positive integer.', 'error');
                elements.saveAndRunButton.disabled = false;
                elements.saveChangesButton.disabled = false;
                return;
            }

            const payload = {
                name: nameValue,
                version: versionValue,
                prompt_purpose: promptPurposeValue,
                status: statusValue,
                llm_model: llmModelValue,
                system_message: systemMessageValue,
            };

            try {
                let savedPrompt;
                if (state.currentMode === 'edit' && state.currentPromptId) {
                    savedPrompt = await updatePrompt(state.currentPromptId, payload);
                    showStatus('Prompt updated successfully.', 'success');
                } else {
                    savedPrompt = await createPrompt(payload);
                    showStatus('Prompt created successfully.', 'success');
                }
                
                if (shouldExecute) {
                    const userMessage = elements.userMessageInput.value.trim();
                    closePromptModal();
                    await loadPrompts();
                    await executePrompt(savedPrompt.id, userMessage);
                } else {
                    closePromptModal();
                    await loadPrompts();
                }
            } catch (error) {
                console.error('Prompt save failed', error);
                showStatus(error.message || 'Unable to save prompt.', 'error');
            } finally {
                elements.saveAndRunButton.disabled = false;
                elements.saveChangesButton.disabled = false;
            }
        }

        async function executePrompt(promptId, userMessage) {
            console.log('[DEBUG] executePrompt called', { promptId, userMessage });
            console.log('[DEBUG] slideoutContent element:', elements.slideoutContent);
            
            if (!elements.slideoutContent) {
                console.error('[DEBUG] slideoutContent is null! Cannot display results.');
                showStatus('Error: Slideout panel not found. Please refresh the page.', 'error');
                return;
            }

            openSlideout('Prompt Execution Results');
            
            // Show loading state
            console.log('[DEBUG] Setting loading state in slideoutContent');
            elements.slideoutContent.innerHTML = `
                <div class="ai-loading">
                    <div class="ai-loading-spinner"></div>
                    <p>Executing prompt...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE_URL}/api/founder/prompts/${promptId}/execute`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ user_message: userMessage || '' }),
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Failed to execute prompt');
                }

                const result = await response.json();
                displayPromptResult(result);
            } catch (error) {
                console.error('Prompt execution failed', error);
                elements.slideoutContent.innerHTML = `
                    <div style="padding: 24px;">
                        <h3 style="color: var(--danger); margin-bottom: 12px;">Error</h3>
                        <p style="color: var(--text);">${error.message || 'Failed to execute prompt'}</p>
                    </div>
                `;
            }
        }

        function displayPromptResult(result) {
            console.log('[DEBUG] displayPromptResult called', result);
            console.log('[DEBUG] slideoutContent element:', elements.slideoutContent);
            
            if (!elements.slideoutContent) {
                console.error('[DEBUG] slideoutContent is null in displayPromptResult!');
                showStatus('Error: Slideout panel not found. Please refresh the page.', 'error');
                return;
            }

            const metadata = `
                <div class="prompt-result-metadata">
                    <strong>Model:</strong> ${result.model || 'N/A'}<br>
                    <strong>Tokens Used:</strong> ${result.tokens_used || 'N/A'}
                </div>
            `;
            
            const content = typeof result.content === 'string' 
                ? result.content 
                : JSON.stringify(result.content, null, 2);
            
            console.log('[DEBUG] Setting result content in slideoutContent');
            elements.slideoutContent.innerHTML = `
                ${metadata}
                <div class="prompt-result-content">${escapeHtml(content)}</div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openSlideout(title) {
            console.log('[DEBUG] openSlideout called', { title });
            console.log('[DEBUG] slideoutTitle:', elements.slideoutTitle);
            console.log('[DEBUG] slideoutPanel:', elements.slideoutPanel);
            console.log('[DEBUG] slideoutOverlay:', elements.slideoutOverlay);
            
            if (elements.slideoutTitle) {
                elements.slideoutTitle.textContent = title || 'Prompt Execution Results';
            } else {
                console.warn('[DEBUG] slideoutTitle is null');
            }
            
            if (elements.slideoutPanel) {
                elements.slideoutPanel.classList.add('open');
                console.log('[DEBUG] Added "open" class to slideoutPanel');
            } else {
                console.error('[DEBUG] slideoutPanel is null!');
            }
            
            if (elements.slideoutOverlay) {
                elements.slideoutOverlay.classList.add('visible');
                console.log('[DEBUG] Added "visible" class to slideoutOverlay');
            } else {
                console.error('[DEBUG] slideoutOverlay is null!');
            }
            
            document.body.classList.add('slideout-open');
        }

        function closeSlideout() {
            if (elements.slideoutPanel) {
                elements.slideoutPanel.classList.remove('open');
            }
            if (elements.slideoutOverlay) {
                elements.slideoutOverlay.classList.remove('visible');
            }
            document.body.classList.remove('slideout-open');
        }

        async function createPrompt(payload) {
            const response = await fetch(`${API_BASE_URL}/api/founder/prompts`, {
                method: 'POST',
                headers: authHeaders(),
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || 'Failed to create prompt.');
            }
            return response.json();
        }

        async function updatePrompt(promptId, payload) {
            const response = await fetch(`${API_BASE_URL}/api/founder/prompts/${promptId}`, {
                method: 'PUT',
                headers: authHeaders(),
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || 'Failed to update prompt.');
            }
            return response.json();
        }

        elements.loginButton.addEventListener('click', loginFounder);
        elements.logoutButton.addEventListener('click', logout);
        elements.refreshButton.addEventListener('click', loadInitialData);
        elements.newPromptButton.addEventListener('click', () => openPromptModal('create'));
        elements.cancelModalButton.addEventListener('click', closePromptModal);
        elements.promptForm.addEventListener('submit', handlePromptFormSubmit);
        elements.saveAndRunButton.addEventListener('click', () => {
            state.actionMode = 'save-and-run';
            elements.promptForm.requestSubmit();
        });
        elements.saveChangesButton.addEventListener('click', () => {
            state.actionMode = 'save-only';
            elements.promptForm.requestSubmit();
        });
        elements.saveButtonDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
            elements.saveButtonMenu.classList.toggle('visible');
        });
        if (elements.newVersionButton) {
            elements.newVersionButton.addEventListener('click', createNewVersion);
        }
        if (elements.closeSlideoutPanel) {
            elements.closeSlideoutPanel.addEventListener('click', closeSlideout);
        } else {
            console.error('[DEBUG] closeSlideoutPanel is null, cannot attach event listener');
        }
        
        if (elements.slideoutOverlay) {
            elements.slideoutOverlay.addEventListener('click', closeSlideout);
        } else {
            console.error('[DEBUG] slideoutOverlay is null, cannot attach event listener');
        }
        
        // Close dropdown menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!elements.saveButtonDropdown.contains(e.target) && !elements.saveButtonMenu.contains(e.target)) {
                elements.saveButtonMenu.classList.remove('visible');
            }
        });
        
        // Close slideout on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && elements.slideoutPanel && elements.slideoutPanel.classList.contains('open')) {
                closeSlideout();
            }
        });
        elements.statusFilter.addEventListener('change', loadPrompts);
        elements.purposeFilter.addEventListener('change', loadPrompts);
        elements.addPurposeButton.addEventListener('click', openAddPurposeModal);
        elements.cancelAddPurposeButton.addEventListener('click', closeAddPurposeModal);
        elements.savePurposeButton.addEventListener('click', handleAddPurpose);
        
        // Allow Enter key to submit add purpose form
        elements.newPurposeInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleAddPurpose();
            }
        });
        
        // Close add purpose modal when clicking backdrop
        elements.addPurposeModal.addEventListener('click', (event) => {
            if (event.target === elements.addPurposeModal) {
                closeAddPurposeModal();
            }
        });

        elements.modalBackdrop.addEventListener('click', (event) => {
            if (event.target === elements.modalBackdrop) {
                closePromptModal();
            }
        });

        elements.loginEmail.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                loginFounder();
            }
        });

        elements.loginPassword.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                loginFounder();
            }
        });

        // Load custom purposes on page load
        loadCustomPurposes();
        
        // Also load existing purposes from database to populate filter dropdown
        async function loadExistingPurposes() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/founder/prompts`, {
                    headers: authHeaders(),
                });
                if (response.ok) {
                    const prompts = await response.json();
                    const uniquePurposes = [...new Set(prompts.map(p => p.prompt_purpose))].sort();
                    
                    // Add to filter dropdown
                    uniquePurposes.forEach(purpose => {
                        const existingOptions = Array.from(elements.purposeFilter.options).map(opt => opt.value);
                        if (!existingOptions.includes(purpose)) {
                            const option = document.createElement('option');
                            option.value = purpose;
                            option.textContent = purpose.split('-').map(word => 
                                word.charAt(0).toUpperCase() + word.slice(1)
                            ).join(' ');
                            elements.purposeFilter.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.warn('Could not load existing purposes for filter:', error);
            }
        }

        attemptExistingSession().then((hasSession) => {
            if (!hasSession) {
                elements.loginOverlay.classList.remove('hidden');
                elements.appShell.style.display = 'none';
            } else {
                loadExistingPurposes();
            }
        });
    </script>
</body>
</html>
